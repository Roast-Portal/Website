<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RoastPortal – Personalized Coffee Quiz | Find Your Perfect Roast</title>

  <!-- ╔═════════════ SEO & Social ═════════════╗ -->
  <meta name="description"  content="Discover your ideal coffee roast with our interactive quiz and personalized recommendations.">
  <meta name="keywords"     content="coffee, roasting, personalized, quiz, beans, brew">
  <meta property="og:title"       content="RoastPortal – Personalized Coffee Quiz | Find Your Perfect Roast">
  <meta property="og:description" content="Take the RoastPortal quiz to get a custom coffee profile crafted just for you">
  <meta property="og:image"       content="https://roastportal.com/images/og-image.jpg">
  <meta property="og:url"         content="https://roastportal.com/">
  <meta name="twitter:card"       content="summary_large_image">
  <meta name="twitter:title"      content="RoastPortal – Personalized Coffee Quiz | Find Your Perfect Roast">
  <meta name="twitter:description"content="Take the RoastPortal quiz to get a custom coffee profile crafted just for you.">
  <meta name="twitter:image"      content="https://roastportal.com/images/og-image.jpg">
  <link rel="canonical" href="https://roastportal.com/">
  <link rel="icon" type="image/png" href="images/favicon.png">

  <!-- ╔═════════════ Fonts & Tailwind ═════════════╗ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap"  rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap"     rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@0,400;0,600;0,700;1,600&display=swap" rel="stylesheet">

  <!-- ╔═════════════ Page‑specific CSS ═════════════╗ -->
  <style>
    :root{--brand-dark:#2b1608;--brand-light:#f5f0ea}
    .pill-input input{display:none}
    .pill-input input:checked + span{background:#22c55e;color:#fff;border-color:#22c55e}
    .pill-input label span{transition:.2s;padding:.5rem 1.25rem;border-radius:9999px;border:1px solid #d1d5db;cursor:pointer;display:inline-block}
    .question{display:none;min-height:200px}.question.active{display:block}
    .wordmark{font-family:'Kanit','Poppins','Nunito',sans-serif;font-size:2rem;letter-spacing:.04em;text-transform:uppercase;line-height:1.1}
    .wordmark .roast,.wordmark .portal{color:#1a0f05;margin:0;padding:0;display:inline}
    html{scroll-padding-top:80px}html,body{font-family:'Kanit','Poppins','Nunito','Playfair Display',sans-serif}
    textarea{font-size:1.15rem;padding:1rem;border:2px solid #d1d5db;border-radius:.75rem;background:#f8fafc;color:#2b1608;transition:border .2s,box-shadow .2s;min-height:4.5rem;text-align:left}
    textarea:focus{border-color:#22c55e;box-shadow:0 0 0 2px #bbf7d0;background:#fff;text-align:left}
    #quizCard{min-height:420px;padding-top:2.5rem;padding-bottom:2.5rem}
    @keyframes fadeInLoadingMsg{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
    .sequential-fade-in{opacity:0;animation:fadeInLoadingMsg .7s ease forwards}
    /* hero gradient animation */
    @keyframes heroGradient{
      0%{background:radial-gradient(circle at 30% 40%,rgba(34,197,94,.10)0%,rgba(43,22,8,.08)100%)}
      25%{background:radial-gradient(circle at 70% 60%,rgba(43,22,8,.12)0%,rgba(34,197,94,.08)100%)}
      50%{background:radial-gradient(circle at 60% 30%,rgba(34,197,94,.09)0%,rgba(43,22,8,.08)100%)}
      75%{background:radial-gradient(circle at 40% 70%,rgba(43,22,8,.10)0%,rgba(34,197,94,.09)100%)}
      100%{background:radial-gradient(circle at 30% 40%,rgba(34,197,94,.10)0%,rgba(43,22,8,.08)100%)}
    }
    .animate-heroGradient{animation:heroGradient 30s ease-in-out infinite;opacity:1}
    
    /* Full-screen quiz styles */
    .quiz-fullscreen {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: #fff;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      padding-block: 1rem; /* minimal padding */
      box-sizing: border-box;
    }
    
    .quiz-fullscreen .container {
      width: 100%;
      max-width: 24rem; /* much smaller width */
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
 
    .quiz-fullscreen #quizForm {
      width: 100%;
      max-width: 24rem; /* match container */
      height: calc(100vh - 2rem); /* minimal height */
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 0.5rem; /* minimal padding */
      box-sizing: border-box;
    }
 
    .quiz-fullscreen #quizCard {
      flex: 1 1 auto;
      max-height: calc(100% - 3rem); /* more space for buttons */
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .quiz-fullscreen .flex.justify-between {
      flex-shrink: 0;
      height: 3rem; /* more height for buttons */
      align-items: center;
      margin-top: 0.5rem; /* more margin */
    }

    .quiz-fullscreen .flex.justify-between .sm\\:ml-auto {
      order: 2;
    }

    .quiz-fullscreen .flex.justify-between #nextBtn {
      order: 2;
    }

    .quiz-fullscreen .flex.justify-between #prevBtn {
      order: 1;
    }
 
    .quiz-fullscreen #quizCard > * {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
 
    .quiz-fullscreen #quizCard .question-body {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      overflow: hidden; /* prevent scrolling */
    }
    
    .quiz-fullscreen .pill-input {
      max-height: 40vh; /* much smaller max height */
      overflow: hidden; /* prevent scrolling */
    }
    
    .quiz-fullscreen .space-y-6 {
      max-height: 40vh; /* much smaller max height */
      overflow: hidden; /* prevent scrolling */
    }
    
    .quiz-fullscreen #contactForm {
      max-width: 24rem;
      width: 100%;
      margin: 0 auto;
      padding: 2rem;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .quiz-escape {
      position: fixed;
      top: 0.5rem;
      right: 0.5rem;
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(229, 231, 235, 0.5);
      border-radius: 50%;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1rem;
      color: #9ca3af;
      z-index: 10000;
    }
    
    .quiz-escape:hover {
      background: rgba(255, 255, 255, 0.8);
      border-color: rgba(209, 213, 219, 0.8);
      color: #6b7280;
    }
  </style>
</head>

<body class="font-sans antialiased text-gray-800 bg-gray-50">

<!-- ╔═════════════ HEADER ═════════════╗ -->
<header class="bg-white shadow sticky top-0 z-50">
  <nav class="container mx-auto flex justify-between items-center py-3 px-6 md:py-3 md:px-8" aria-label="Main navigation">
    <a href="#hero" class="flex items-center gap-4" aria-label="RoastPortal Home">
      <img src="images/favicon.png" alt="RoastPortal logo" class="h-10" loading="lazy">
      <span class="wordmark"><span class="roast">Roast</span> <span class="portal">Portal</span></span>
    </a>
    <a class="text-[#1a0f05] font-semibold hover:underline px-4 py-2 rounded transition-colors" href="/login">Login</a>
  </nav>
</header>

<!-- ╔═════════════ HERO ═════════════╗ -->
<section id="hero" class="relative bg-cover bg-center min-h-[60vh] flex items-center justify-center overflow-hidden" style="background-image:url('images/hero-banner.png')">
  <div aria-hidden="true" class="absolute inset-0 bg-gradient-to-b from-[#2b1608]/90 via-black/80 to-black/90"></div>
  <div aria-hidden="true" class="absolute inset-0 animate-heroGradient pointer-events-none"></div>
  <span class="sr-only">Background showing roasted coffee beans and a steaming mug</span>

  <div class="relative z-10 text-center px-6 py-20">
    <h1 class="text-4xl md:text-6xl font-bold text-white drop-shadow mb-4" style="font-family:'Poppins',sans-serif;font-weight:600">
      Data‑driven coffee,<br>roasted for <span class="text-[#22c55e] drop-shadow font-extrabold">you</span>
    </h1>
    <p class="text-lg md:text-2xl text-white mb-6 drop-shadow">
      Answer a few questions, sip, rate, repeat — our AI adapts every bag until it’s perfect for you.
    </p>
    <a class="bg-[#16a34a] text-white px-6 py-3 rounded-full font-medium text-lg hover:bg-[#22c55e] transition-colors" href="#quiz">Start your custom blend</a>
  </div>
</section>

<!-- ╔═════════════ HOW IT WORKS ═════════════╗ -->
<section id="how-it-works" class="py-16 bg-gray-100">
  <div class="container mx-auto px-6">
    <h2 class="text-3xl font-bold text-center mb-12">How it works</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
      <article class="text-center p-6 bg-white rounded-lg shadow-lg">
        <div class="text-5xl font-extrabold text-[#2b1608] mb-4">1</div>
        <h3 class="text-xl font-semibold mb-2">Share your taste</h3>
        <p class="text-gray-600 text-base px-4">Tell our AI what you like.</p>
      </article>
      <article class="text-center p-6 bg-white rounded-lg shadow-lg">
        <div class="text-5xl font-extrabold text-[#2b1608] mb-4">2</div>
        <h3 class="text-xl font-semibold mb-2">Enjoy your roast</h3>
        <p class="text-gray-600 text-base px-4">We send a roast crafted just for you.</p>
      </article>
      <article class="text-center p-6 bg-white rounded-lg shadow-lg">
        <div class="text-5xl font-extrabold text-[#2b1608] mb-4">3</div>
        <h3 class="text-xl font-semibold mb-2">Refine your cup</h3>
        <p class="text-gray-600 text-base px-4">Give feedback so the next bag is even better.</p>
      </article>
    </div>
  </div>
</section>

<!-- ╔═════════════ QUIZ ═════════════╗ -->
<section id="quiz" class="py-16 bg-white">
  <div class="container mx-auto px-6">
    <h2 id="quizTitle" class="text-3xl font-bold text-center mb-8">Train your coffee AI</h2>

    <!-- ▶ FORM 1 : QUIZ ◀ -->
    <form id="quizForm" class="max-w-3xl mx-auto bg-white/90 shadow-xl rounded-2xl p-6 md:p-10 relative" aria-label="Coffee Preference Quiz">
      <button type="button" id="quizEscape" class="quiz-escape hidden" aria-label="Exit quiz">×</button>
      <input type="hidden" name="formType" value="quiz">
      <input type="hidden" name="userId" id="quizUserId">

      <!-- Progress bar -->
      <div class="mb-6">
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div id="progressBar" class="bg-[#22c55e] h-3 rounded-full transition-all" style="width:0%"></div>
        </div>
      </div>

      <!-- Dynamic question container -->
      <div id="quizCard" class="relative min-h-[220px] flex flex-col justify-center items-center"></div>

      <!-- Review Section (hidden by default) -->
      <div id="reviewSection" class="hidden">
        <h3 class="text-2xl font-bold text-center mb-4">Your Custom Roast Profile</h3>
        <div id="reviewContent" class="space-y-3 bg-gray-50 p-6 rounded-lg shadow-inner"></div>
        <div class="mt-6">
            <label for="blendName" class="block font-medium mb-1">Name your blend</label>
            <input type="text" id="blendName" name="blendName" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-200">
        </div>
      </div>


      <p id="errorMessage" class="hidden text-red-500 text-sm font-medium mt-2"></p>

      <!-- Navigation buttons -->
      <div class="flex flex-col sm:flex-row justify-between mt-6 gap-2">
        <button id="submitBtn" class="bg-[#22c55e] text-white px-6 py-3 rounded font-semibold hidden" type="submit">Submit</button>
        <div class="flex flex-col sm:flex-row gap-2 sm:ml-auto">
          <button id="nextBtn" class="bg-[#22c55e] text-white px-6 py-3 rounded font-semibold order-2 sm:order-2">Next</button>
          <button id="prevBtn" class="bg-gray-300 text-gray-800 px-6 py-3 rounded font-semibold order-1 sm:order-1" disabled>Previous</button>
        </div>
      </div>
    </form>

    <!-- ▶ FORM 2 : CONTACT ◀ (hidden until quiz completes) -->
    <form id="contactForm" class="space-y-4 max-w-lg mx-auto mt-10 hidden">
      <input type="hidden" name="formType" value="contact">
      <input type="hidden" name="userId" id="contactUserId">
      <div>
        <label class="block font-medium mb-1" for="contactName">Name</label>
        <input class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-200" type="text" id="contactName" name="contactName" required>
      </div>
      <div>
        <label class="block font-medium mb-1" for="contactEmail">Email</label>
        <input class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-200" type="email" id="contactEmail" name="contactEmail" required>
      </div>
      <div>
        <label class="block font-medium mb-1" for="contactPhone">Phone</label>
        <input class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-200" type="tel" id="contactPhone" name="contactPhone" required>
      </div>
      <button class="w-full bg-[#22c55e] text-white font-semibold py-2 rounded hover:bg-[#16a34a] transition" type="submit">Get my custom roast</button>
      <p id="contactError" class="hidden text-center text-red-500 font-semibold mt-2"></p>
      <p id="contactSuccess" class="hidden text-center text-[#16a34a] font-semibold mt-4">Thank you! We have your details.</p>
    </form>
  </div>
</section>

<!-- ╔═════════════ FAQ ═════════════╗ -->
<section class="container mx-auto px-6 max-w-3xl mt-12 mb-16" aria-label="Frequently Asked Questions">
  <h2 class="text-3xl font-bold text-center mb-8">FAQ</h2>
  <div class="space-y-4">
    <details class="border border-gray-200 rounded-lg p-4">
      <summary class="pl-2 font-semibold cursor-pointer">How does it work?</summary>
      <p class="mt-2 text-gray-600">
        You answer a questionnaire. We send you your first personalized bag of coffee. You try it and give us feedback about that specific bag. We take your feedback and use AI to further improve how we roast coffee for you. Your next bag of coffee is upgraded with the new changes. After you try it, you can give us feedback again and we will continue to improve your coffee until it is perfect for you.
      </p>
    </details>
    <details class="border border-gray-200 rounded-lg p-4">
      <summary class="pl-2 font-semibold cursor-pointer">What makes you different from other coffee subscription services?</summary>
      <p class="mt-2 text-gray-600">
        Other services have a fixed number of coffee blends to choose from and they try to help you find which blend you would like best. We start with what you tell us you are looking for and then create a blend just for you. When you give us feedback on your blend, we tweak your blend just for you. Our goal is to work with you to create the perfect blend for you.
      </p>
    </details>
    <details class="border border-gray-200 rounded-lg p-4">
      <summary class="pl-2 font-semibold cursor-pointer">What is a blend?</summary>
      <p class="mt-2 text-gray-600">
        Other roasters mix one or more types of coffee together that are roasted in a specific way to create a blend that the roaster likes and then sells to a mass market. We believe blends should be personal to each individual. We use the same levers to create a blend, but by using AI, we are able to create a blend that isn’t trying to align with what our personal taste preferences are, but align with your taste preferences.
      </p>
    </details>
    <details class="border border-gray-200 rounded-lg p-4">
      <summary class="pl-2 font-semibold cursor-pointer">What if I want to have more than one blend?</summary>
      <p class="mt-2 text-gray-600">
        That’s easy. Just go into your settings and create a new blend. Any new blend you create will be optimized separately. You can specify how often you want us to send you each blend you have created.
      </p>
    </details>
    <details class="border border-gray-200 rounded-lg p-4">
      <summary class="pl-2 font-semibold cursor-pointer">Do I need to give feedback every time?</summary>
      <p class="mt-2 text-gray-600">
        No. If you don’t give feedback, we send you the same coffee as before.
      </p>
    </details>
    <details class="border border-gray-200 rounded-lg p-4">
      <summary class="pl-2 font-semibold cursor-pointer">How do I pause my subscription?</summary>
      <p class="mt-2 text-gray-600">
        Just turn on “vacation mode” in your settings.
      </p>
    </details>
    <details class="border border-gray-200 rounded-lg p-4">
      <summary class="pl-2 font-semibold cursor-pointer">How often will I get a new bag of coffee?</summary>
      <p class="mt-2 text-gray-600">
        After you open a new bag of coffee and leave feedback, we start creating the next version of your coffee and send it to you when done. We package it to remain fresh until you need it. If you don’t provide any feedback, we estimate when you will be running low on coffee and try to time it so we send you a new bag before you run out.
      </p>
    </details>
    <details class="border border-gray-200 rounded-lg p-4">
      <summary class="pl-2 font-semibold cursor-pointer">How much does the coffee cost?</summary>
      <p class="mt-2 text-gray-600">
        You get to choose how much you pay. Paying more impacts how much we are able to optimize the quality of your coffee.
      </p>
    </details>
    <details class="border border-gray-200 rounded-lg p-4">
      <summary class="pl-2 font-semibold cursor-pointer">What sizes of coffee can I buy?</summary>
      <p class="mt-2 text-gray-600">
        Currently we only sell 12 oz bags of coffee. Please let us know if you would like to buy in bulk: <a class="underline" href="mailto:support@roastportal.com">support@roastportal.com</a>.
      </p>
    </details>
  </div>
</section>

<!-- ╔═════════════ FOOTER ═════════════╗ -->
<footer class="bg-gray-800 text-gray-200 py-4">
  <div class="container mx-auto px-6 flex flex-col md:flex-row justify-between items-center text-sm space-y-4 md:space-y-0">
    <a href="#hero" aria-label="Back to top"><img src="images/favicon.png" alt="RoastPortal logo" class="h-8" loading="lazy"></a>
    <p>© 2025 RoastPortal. All rights reserved.</p>
    <div class="flex space-x-4">
      <a href="terms.html" class="hover:underline">Terms</a>
      <a href="mailto:hello@roastportal.com" class="hover:underline">Contact</a>
    </div>
  </div>
</footer>

<!-- ╔═════════════ MAIN SCRIPT ═════════════╗ -->
<script>
/*------------------------------------------------------------------
  CONFIG
------------------------------------------------------------------*/
const GAS_URL     = 'https://script.google.com/macros/s/AKfycbyN5Mv6iJ7Wmj79jR6TY9PcXgK8-QaaKFSwqq8KRlzaPYidgCr6rcYlLePDqbDDzyNoaQ/exec'; // ← replace with your deployed Web‑App URL
const TAB_FORM    = 'FormResponses';
const TAB_CONTACT = 'ContactCapture';

/*------------------------------------------------------------------
  STATE & HELPERS
------------------------------------------------------------------*/
const quizData = [
  {label:'What roast level do you enjoy most?', type:'radio', name:'roastLevel', options:['Light','Light-Medium','Medium','Medium-Dark','Dark']},
  {label:'Which flavor notes do you love?', type:'multi-range', names:['flavorNutty','flavorFruity','flavorFloral','flavorSmoky'], min:0,max:100,step:1,flavors:['Nutty','Fruity','Floral','Smoky']},
  {label:'How do you usually brew your coffee?', type:'radio', name:'brewMethod', options:['Drip','Pour-over','French Press','Espresso','Single-Serve Pod','Cold Brew','Other']},
  {label:'What brewing equipment do you have?', type:'text', name:'equipmentDetails'},
  {label:'Would you like us to grind the beans?', type:'radio', name:'grindService', options:['Yes','No']},
  {label:'How do you take your coffee? (select all that apply)', type:'checkbox', names:['addMilk','addDairyFree','addSugar'], options:['Milk / Cream','Dairy‑free Milk','Sugar / Syrup']},
  {label:'How much do you value a premium coffee experience?', type:'range', name:'priceRange', min:14, max:100, step:1, left:'$14', right:'$100'},
  {label:'How adventurous are you with coffee?', type:'radio', name:'personality', options:['Stick to classics','Enjoy some variety',"Bring on the funk!"]},
  {label:'Which tastes do you prefer?',type:'radio', name:'tasteBalance', options:['Sweet & Smooth','Tart & Complex', 'Rich & Bitter']},
  {label:'What kind of water do you brew with?', type:'radio', name:'waterType', options:['Unfiltered tap','Filtered tap','Recipe','Distilled']},
  {label:'Anything else we should know?', type:'text', name:'additionalNotes'}
];
const defaults = {roastLevel:'Medium',brewMethod:'Drip',grindService:'No',priceRange:35,personality:'Enjoy some variety',
  flavorNutty:50,flavorFruity:50,flavorFloral:50,flavorSmoky:50,
  tasteBalance:'Sweet & Smooth',waterType:'Unfiltered tap'
};

let current = 0;
let answers = {...defaults};
const userId = sessionStorage.getItem('userId') || (crypto.randomUUID?.() || Math.random().toString(36).slice(2));
sessionStorage.setItem('userId', userId);

/*------------------------------------------------------------------
  DOM SHORTCUTS
------------------------------------------------------------------*/
const quizForm      = document.getElementById('quizForm');
const contactForm   = document.getElementById('contactForm');
const quizCard      = document.getElementById('quizCard');
const progressBar   = document.getElementById('progressBar');
const prevBtn       = document.getElementById('prevBtn');
const nextBtn       = document.getElementById('nextBtn');
const submitBtn     = document.getElementById('submitBtn');
const errorMessage  = document.getElementById('errorMessage');
document.getElementById('quizUserId').value    = userId;
document.getElementById('contactUserId').value = userId;

/*------------------------------------------------------------------
  RENDERING
------------------------------------------------------------------*/
function createRadarChart(flavors) {
    const size = 120; // Even smaller size for better fit
    const center = size / 2;
    const radius = size * 0.3; // Reduced radius to create more padding
    const numAxes = flavors.length;
    const angleSlice = (Math.PI * 2) / numAxes;

    // Helper to calculate point coordinates
    const getPoint = (value, index) => {
        const angle = angleSlice * index - Math.PI / 2; // Start at the top
        const x = center + (value / 100) * radius * Math.cos(angle);
        const y = center + (value / 100) * radius * Math.sin(angle);
        return `${x},${y}`;
    };

    // --- SVG Parts ---
    // 1. Grid lines (concentric polygons)
    let gridLines = '';
    [25, 50, 75, 100].forEach(val => {
        const points = flavors.map((_, i) => getPoint(val, i)).join(' ');
        gridLines += `<polygon points="${points}" fill="none" stroke="#e5e7eb" stroke-width="1"/>`;
    });

    // 2. Axes lines
    const axesLines = flavors.map((_, i) => {
        const p = getPoint(100, i);
        return `<line x1="${center}" y1="${center}" x2="${p.split(',')[0]}" y2="${p.split(',')[1]}" stroke="#d1d5db" stroke-width="1"/>`;
    }).join('');

    // 3. Data polygon
    const dataPoints = flavors.map((flavor, i) => getPoint(flavor.value, i)).join(' ');
    const dataPolygon = `<polygon points="${dataPoints}" fill="rgba(34, 197, 94, 0.5)" stroke="#16a34a" stroke-width="2"/>`;

    // 4. Labels
    const labels = flavors.map((flavor, i) => {
        const p = getPoint(110, i); // Reduced distance for labels
        const x = parseFloat(p.split(',')[0]);
        const y = parseFloat(p.split(',')[1]);
        let textAnchor = "middle";
        if (x < center - 10) textAnchor = "end";
        if (x > center + 10) textAnchor = "start";
        
        return `<text x="${x}" y="${y}" dy="0.3em" text-anchor="${textAnchor}" font-size="10" fill="#4b5563">${flavor.name}</text>`;
    }).join('');

    return `
        <svg width="100%" height="auto" viewBox="0 0 ${size} ${size}">
            ${gridLines}
            ${axesLines}
            ${labels}
            ${dataPolygon}
        </svg>
    `;
}

function positionThumbLabel(slider) {
    const output = document.getElementById(slider.id + 'Val');
    if (!output) return;

    const min = parseFloat(slider.min);
    const max = parseFloat(slider.max);
    const val = parseFloat(slider.value);

    const width = slider.offsetWidth;
    const thumbWidth = 24; 
    const percent = (val - min) / (max - min);
    const thumbPosition = percent * (width - thumbWidth);
    const labelWidth = output.offsetWidth;
    const newPosition = thumbPosition + (thumbWidth / 2) - (labelWidth / 2);

    output.style.left = `${newPosition}px`;
    output.innerHTML = slider.name === 'priceRange' ? '$' + val : val;
}

function renderQuestion(idx){
  const q = quizData[idx];
  quizCard.innerHTML='';
  if(!q) return;

  const questionTitle = `<h3 class="text-xl font-semibold mb-4 text-center">${q.label}</h3>`;

  /* RADIO */
  if(q.type==='radio'){
    quizCard.innerHTML=`
      <div class="w-full max-w-md mx-auto">
        <h3 class="text-lg font-semibold mb-3 text-center">${q.label}</h3>
        <div class="question-body">
          <div class="flex flex-wrap justify-center gap-2 pill-input">
            ${q.options.map(opt=>`
              <label><input type="radio" name="${q.name}" value="${opt}" class="sr-only">
                <span class="bg-white text-gray-800 border-gray-300 hover:bg-gray-100 text-sm px-3 py-1">${opt}</span>
              </label>`).join('')}
          </div>
        </div>
      </div>`;
  }

  /* RANGE */
  else if(q.type==='range'){
    const v = answers[q.name]??q.min;
    quizCard.innerHTML=`
      <div class="w-full max-w-md mx-auto">
        <h3 class="text-lg font-semibold mb-3 text-center">${q.label}</h3>
        <div class="question-body">
          <div class="flex items-center gap-x-3 w-full px-2">
            <span class="text-xs text-gray-500">${q.left||''}</span>
            <div class="relative flex-grow h-6">
            <input type="range" id="${q.name}" name="${q.name}" min="${q.min}" max="${q.max}" step="${q.step}" value="${v}" class="w-full accent-[#22c55e] absolute top-1/2 -translate-y-1/2" style="margin: 0; padding: 0;">
            <output for="${q.name}" id="${q.name}Val"
                    class="output-bubble absolute pointer-events-none bg-gray-700 text-white text-xs font-semibold px-1 py-0.5 rounded shadow-lg -top-1"
                    style="transform: translateX(-50%);">
                ${q.name === 'priceRange' ? '$' + v : v}
            </output>
            </div>
            <span class="text-xs text-gray-500">${q.right||''}</span>
          </div>
        </div>
      </div>`;
    const sliderEl = document.getElementById(q.name);
    setTimeout(() => positionThumbLabel(sliderEl), 0);
  }

  /* MULTI‑RANGE */
  else if(q.type==='multi-range'){
    quizCard.innerHTML=`
      <div class="w-full max-w-md mx-auto">
        <h3 class="text-lg font-semibold mb-3 text-center">${q.label}</h3>
        <div class="question-body">
          <div class="space-y-3 w-full">${q.names.map((n,i)=>`
            <div>
              <p class="mb-1 text-xs text-center">${q.flavors[i]}</p>
              <div class="flex items-center gap-x-2">
                <span class="text-xs text-gray-500 w-16 text-left flex-shrink-0">Dislike</span>
                <input type="range" id="${n}" name="${n}" min="${q.min}" max="${q.max}" step="${q.step}" value="${answers[n]??50}" class="w-full accent-[#22c55e]">
                <span class="text-xs text-gray-500 w-16 text-right flex-shrink-0">Love it</span>
              </div>
            </div>`).join('')}</div>
        </div>
      </div>`;
  }

  /* CHECKBOX */
  else if(q.type==='checkbox'){
    quizCard.innerHTML=`
      <div class="w-full max-w-md mx-auto">
        <h3 class="text-lg font-semibold mb-3 text-center">${q.label}</h3>
        <div class="question-body">
          <div class="flex flex-wrap justify-center gap-2 pill-input">
            ${q.options.map((opt,i)=>`
              <label><input type="checkbox" name="${q.names[i]}" ${answers[q.names[i]]?'checked':''}>
                <span class="text-sm px-3 py-1">${opt}</span></label>`).join('')}
          </div>
        </div>
      </div>`;
  }

  /* TEXT */
  else if(q.type==='text'){
    quizCard.innerHTML=`
      <div class="w-full max-w-md mx-auto">
        <h3 class="text-lg font-semibold mb-3 text-center">${q.label}</h3>
        <div class="question-body">
          <textarea id="${q.name}" name="${q.name}" class="w-full text-sm" rows="3">${answers[q.name]||''}</textarea>
        </div>
      </div>`;
  }

  /* Listeners for newly added controls */
  quizCard.querySelectorAll('input,textarea').forEach(el=>{
    el.addEventListener('input', e=>{
      if(el.type==='checkbox'){answers[el.name]=el.checked}
      else{answers[el.name]=el.value}
      if(el.type === 'range') {
        positionThumbLabel(el);
      }
    });
    
    // Add click event for radio buttons to handle all selections including defaults
    if(el.type==='radio'){
      el.addEventListener('click', e=>{
        answers[el.name]=el.value;
        autoNext();
      });
    }
    
    // Add keyboard events for textarea
    if(el.type==='textarea' || el.tagName.toLowerCase() === 'textarea'){
      el.addEventListener('keydown', e=>{
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          autoNext();
        }
        // Shift+Enter allows new line (default behavior)
      });
    }
  });
}

/*------------------------------------------------------------------
  NAVIGATION
------------------------------------------------------------------*/
function autoNext(){
  if(current<quizData.length){
    // If this is the first selection (moving from question 0 to 1), activate full-screen mode
    if(current === 0) {
      document.body.classList.add('quiz-fullscreen');
      document.getElementById('quiz').classList.add('quiz-fullscreen');
      document.getElementById('quizEscape').classList.remove('hidden');
    }
    current++;
    updateUI();
  }
}
function updateUI(){
  if (current >= quizData.length) {
    showReview();
    return;
  }
  renderQuestion(current);
  const progress = current / quizData.length;
  progressBar.style.width = (progress * 100) + '%';
  
  // Hide navigation buttons on first question, show Previous from question 2
  if (current === 0) {
    prevBtn.classList.add('hidden');
    nextBtn.classList.add('hidden');
    submitBtn.classList.add('hidden');
  } else if (current === 1) {
    prevBtn.classList.remove('hidden');
    prevBtn.disabled = false;
    submitBtn.classList.add('hidden');
    nextBtn.classList.remove('hidden');
  } else {
    prevBtn.classList.remove('hidden');
    prevBtn.disabled = false;
    submitBtn.classList.add('hidden');
    nextBtn.classList.remove('hidden');
  }

  if (current === quizData.length - 1) {
    nextBtn.textContent = 'Next';
  } else {
    nextBtn.textContent = 'Next';
  }
}
prevBtn.addEventListener('click',()=>{if(current>0){current--;updateUI()}});
nextBtn.addEventListener('click', () => {
  if (current === quizData.length - 1) {
    // Last question, show "analyzing" message
    quizCard.innerHTML = `
      <div class="w-full max-w-md mx-auto">
        <div class="question-body">
          <div class="text-center py-8">
        <svg class="animate-spin h-10 w-10 text-green-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-xl font-semibold text-gray-800">Creating your custom blend...</p>
        <p class="text-gray-600 mt-2">Our AI is analyzing your preferences to craft the perfect roast.</p>
          </div>
        </div>
      </div>`;
    
    prevBtn.classList.add('hidden');
    nextBtn.classList.add('hidden');

    setTimeout(() => {
      current++;
      updateUI();
    }, 2500);
  } else {
    current++;
    updateUI();
  }
});
updateUI(); // initial render

// Escape functionality
document.getElementById('quizEscape').addEventListener('click', function() {
  // Reset to initial state
  current = 0;
  answers = {...defaults};
  
  // Remove full-screen mode
  document.body.classList.remove('quiz-fullscreen');
  document.getElementById('quiz').classList.remove('quiz-fullscreen');
  document.getElementById('quizEscape').classList.add('hidden');
  
  // Reset progress bar
  document.getElementById('progressBar').style.width = '0%';
  
  // Update UI
  updateUI();
  
  // Scroll back to quiz section
  document.getElementById('quiz').scrollIntoView({ behavior: 'smooth' });
});

/*------------------------------------------------------------------
  REVIEW & SUBMIT
------------------------------------------------------------------*/
function showReview() {
  // Activate full-screen mode if not already active
  if(!document.body.classList.contains('quiz-fullscreen')) {
    document.body.classList.add('quiz-fullscreen');
    document.getElementById('quiz').classList.add('quiz-fullscreen');
    document.getElementById('quizEscape').classList.remove('hidden');
  }
  
  // Show quiz card and replace content with review
  quizCard.classList.remove('hidden');
  document.getElementById('reviewSection').classList.add('hidden');
  prevBtn.classList.remove('hidden');
  nextBtn.classList.add('hidden');
  submitBtn.classList.remove('hidden');
  submitBtn.textContent = 'Checkout';

  // 1. Generate a blend name suggestion
  let blendTitle = 'Your Custom Blend';
  switch (answers.personality) {
    case 'Bring on the funk!':
      blendTitle = 'The Explorer';
      break;
    case 'Enjoy some variety':
      blendTitle = 'The Artisan';
      break;
    case 'Stick to classics':
      blendTitle = 'The Connoisseur';
      break;
  }

  // 2. Prepare flavor data for the chart
  const flavors = [
    { name: 'Nutty', value: parseInt(answers.flavorNutty, 10) },
    { name: 'Fruity', value: parseInt(answers.flavorFruity, 10) },
    { name: 'Floral', value: parseInt(answers.flavorFloral, 10) },
    { name: 'Smoky', value: parseInt(answers.flavorSmoky, 10) }
  ];

  // 3. Creator's Note
  let noteAdjective = '';
  switch(answers.tasteBalance) {
      case 'Sweet & Smooth':
          noteAdjective = "approachable and satisfying";
          break;
      case 'Tart & Complex':
          noteAdjective = "bright and wonderfully complex";
          break;
      case 'Rich & Bitter':
          noteAdjective = "deeply satisfying and bold";
          break;
  }
  const primaryNotes = flavors.sort((a, b) => b.value - a.value).slice(0, 2).map(f => f.name).join(' & ');
  const creatorsNote = `A ${answers.roastLevel.toLowerCase()} roast highlighting ${primaryNotes.toLowerCase()} notes. ${noteAdjective} and perfect for your ${answers.brewMethod}.`;
  
  const radarChartHTML = createRadarChart(flavors);

  // Replace quiz card content with review in the same container
  quizCard.innerHTML = `
    <div class="w-full max-w-md mx-auto">
      <h3 class="text-sm font-semibold mb-1 text-center">Your Custom Roast Profile</h3>
      <div class="question-body">
        <div class="space-y-1">
          <div class="text-center">
            <h4 class="text-sm font-bold text-gray-800">${blendTitle}</h4>
            <p class="text-gray-600 italic text-xs">Your AI-Generated Flavor Profile</p>
          </div>

          <div class="flex justify-center">${radarChartHTML}</div>
          
          <div>
            <p class="font-semibold text-gray-700 text-xs">Creator's Note:</p>
            <p class="text-gray-600 text-xs leading-tight">${creatorsNote}</p>
          </div>
          
          <div class="mt-1">
            <label for="blendName" class="block font-medium mb-1 text-xs">Name your blend</label>
            <input type="text" id="blendName" name="blendName" maxlength="15" class="w-full border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-green-200 text-xs">
          </div>
        </div>
      </div>
    </div>
  `;
}


/*------------------------------------------------------------------
  BACK‑END COMM
------------------------------------------------------------------*/
function submitToSheet(tab, formData){
  return fetch(`${GAS_URL}?tab=${encodeURIComponent(tab)}`,{
    method:'POST',
    mode:'cors',
    headers:{'Accept':'application/json'},
    body:formData
  })
  .then(r=>r.json())
  .catch(()=>({status:'ERR'}));
}

/* QUIZ SUBMIT -----------------------------------------------------*/
quizForm.addEventListener('submit',async e=>{
  e.preventDefault();
  
  const submitButton = document.getElementById('submitBtn');
  const originalButtonHTML = submitButton.innerHTML;
  submitButton.disabled = true;
  submitButton.innerHTML = `
    <span class="inline-flex items-center">
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Submitting...
    </span>`;
  errorMessage.classList.add('hidden');

  /* inject every answer as hidden input so formData carries them */
  Object.entries(answers).forEach(([k,v])=>{
    const hidden=document.createElement('input');
    hidden.type='hidden';hidden.name=k;hidden.value=(typeof v==='boolean'?v?1:'':v);
    quizForm.appendChild(hidden);
  });
  const blendName = document.getElementById('blendName').value;
  const fd=new FormData(quizForm);
  fd.set('userId',userId);
  fd.set('blendName', blendName);

  const res=await submitToSheet(TAB_FORM,fd);
  if(res.status==='OK'){
    // Hide review section and navigation buttons
    document.getElementById('reviewSection').classList.add('hidden');
    document.getElementById('prevBtn').classList.add('hidden');
    document.getElementById('submitBtn').classList.add('hidden');
    
    // Show quiz card again and replace content with contact form
    quizCard.classList.remove('hidden');
    
    // Replace quiz card content with contact form
    quizCard.innerHTML = `
      <div class="w-full max-w-md mx-auto">
        <h3 class="text-lg font-semibold mb-2 text-center">Almost done! We need your details</h3>
        <div class="question-body">
          <div class="space-y-2">
            <div>
              <label class="block font-medium mb-1 text-xs" for="contactName">Name</label>
              <input class="w-full border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-green-200 text-xs" type="text" id="contactName" name="contactName" required>
            </div>
            <div>
              <label class="block font-medium mb-1 text-xs" for="contactEmail">Email</label>
              <input class="w-full border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-green-200 text-xs" type="email" id="contactEmail" name="contactEmail" required>
            </div>
            <div>
              <label class="block font-medium mb-1 text-xs" for="contactPhone">Phone</label>
              <input class="w-full border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-green-200 text-xs" type="tel" id="contactPhone" name="contactPhone" required>
            </div>
            <button id="contactSubmitBtn" class="w-full bg-[#22c55e] text-white font-semibold py-1 rounded hover:bg-[#16a34a] transition text-xs" type="button">Get my custom roast</button>
            <p id="contactError" class="hidden text-center text-red-500 font-semibold mt-1 text-xs"></p>
          </div>
        </div>
      </div>
    `;
    
    // Add event listener to the new contact submit button
    document.getElementById('contactSubmitBtn').addEventListener('click', async function() {
      const contactSubmitBtn = this;
      const originalContactHTML = contactSubmitBtn.innerHTML;
      
      // Validate required fields
      const nameField = document.getElementById('contactName');
      const emailField = document.getElementById('contactEmail');
      const phoneField = document.getElementById('contactPhone');
      const contactErrorEl = document.getElementById('contactError');
      
      if (!nameField.value || !emailField.value || !phoneField.value) {
        contactErrorEl.textContent = 'Please fill in all fields.';
        contactErrorEl.classList.remove('hidden');
        return;
      }
      
      contactErrorEl.classList.add('hidden');
      contactSubmitBtn.disabled = true;
      contactSubmitBtn.innerHTML = `
        <span class="inline-flex items-center justify-center">
          <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Submitting...
        </span>`;
      
      // Create form data for contact submission
      const contactFD = new FormData();
      contactFD.set('formType', 'contact');
      contactFD.set('userId', userId);
      contactFD.set('contactName', nameField.value);
      contactFD.set('contactEmail', emailField.value);
      contactFD.set('contactPhone', phoneField.value);
      contactFD.set('blendName', blendName);
      
      const contactRes = await submitToSheet(TAB_CONTACT, contactFD);
      if(contactRes.status === 'OK') {
        // Show success message
        quizCard.innerHTML = `
          <div class="w-full max-w-md mx-auto">
            <div class="question-body">
              <div class="text-center py-10">
                <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="text-2xl font-bold text-gray-800">Thank you!</h3>
                <p class="text-gray-600 mt-2">Your custom roast is on its way. We'll be in touch shortly with order details.</p>
              </div>
            </div>
          </div>
        `;
        sessionStorage.removeItem('userId');
      } else {
        contactErrorEl.textContent = 'Submission failed. Please try again.';
        contactErrorEl.classList.remove('hidden');
        contactSubmitBtn.disabled = false;
        contactSubmitBtn.innerHTML = originalContactHTML;
      }
    });
    
  }else{
    errorMessage.textContent='Submission failed. Please retry.';
    errorMessage.classList.remove('hidden');
    submitButton.disabled = false;
    submitButton.innerHTML = originalButtonHTML;
  }
});

/* CONTACT SUBMIT - Now handled inline within quiz submission flow */
</script>
<script>
/* --- SAFETY GUARD: prevent premature submit -------------------------------- */
(function () {
  /* 1. Ensure navigation buttons are not accidental submits */
  ['nextBtn', 'prevBtn'].forEach(id => {
    const btn = document.getElementById(id);
    if (btn && btn.type !== 'button') btn.type = 'button';
  });

  /* 2. Block the ENTER key from submitting while quiz is in progress */
  const qForm = document.getElementById('quizForm');
  if (qForm) qForm.addEventListener('keydown', e => {
    if (e.key === 'Enter') e.preventDefault();
  });
})();
</script>
</body>
</html>
