<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RoastPortal – Personalized Coffee Quiz | Find Your Perfect Roast</title>
  <meta name="description" content="Discover your ideal coffee roast with our interactive quiz and personalized recommendations." />
  <meta name="keywords" content="coffee, roasting, personalized, quiz, beans, brew" />
  <meta property="og:title" content="Roast Portal – Personalized Coffee Quiz | Find Your Perfect Roast" />
  <meta property="og:description" content="Take the Roast Portal quiz to get a custom coffee profile crafted just for you" />
  <meta property="og:image" content="https://roastportal.com/images/og-image.jpg" />
  <meta property="og:url" content="https://roastportal.com/" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Roast Portal – Personalized Coffee Quiz | Find Your Perfect Roast" />
  <meta name="twitter:description" content="Take the Roast Portal quiz to get a custom coffee profile crafted just for you." />
  <meta name="twitter:image" content="https://roastportal.com/images/og-image.jpg" />
  <link rel="canonical" href="https://roastportal.com/" />
  <link rel="icon" type="image/png" href="images/favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  <style>
    :root { --brand-dark: #2b1608; --brand-light: #f5f0ea; }
    .pill-input input { display: none; }
    .pill-input input:checked + span {
      background-color: #22c55e;
      color: #fff;
      border-color: #22c55e;
    }
    .pill-input label span {
      transition: background 0.2s, color 0.2s, border 0.2s;
      padding: 0.5rem 1.25rem;
      border-radius: 9999px;
      border: 1px solid #d1d5db;
      cursor: pointer;
      display: inline-block;
    }
    .question { display: none; min-height: 200px; }
    .question.active { display: block; }
    .wordmark {
      font-family: 'Kanit', 'Poppins', 'Inter', 'Segoe UI', Arial, sans-serif;
      font-size: 2rem;
      font-weight: 400;
      letter-spacing: 0.04em;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
      padding: 0.125em 0.5em;
      background: transparent;
      margin-left: 0;
      text-transform: uppercase;
      line-height: 1.1;
    }
    .wordmark .roast, .wordmark .portal {
      color: #2b1608;
      font-weight: 400;
      margin: 0;
      padding: 0;
      text-align: left;
      width: 100%;
      display: block;
    }
    /* Fix scroll offset for anchor links */
    html {
      scroll-padding-top: 80px;
    }
    html, body {
      font-family: 'Kanit', 'Poppins', 'Nunito', 'Playfair Display', 'Inter', 'Segoe UI', Arial, sans-serif;
    }
    textarea {
      font-size: 1.15rem;
      padding: 1rem;
      border: 2px solid #d1d5db;
      border-radius: 0.75rem;
      background: #f8fafc;
      color: #2b1608;
      transition: border 0.2s, box-shadow 0.2s;
      min-height: 4.5rem;
      outline: none;
    }
    textarea:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 2px #bbf7d0;
      background: #fff;
      text-align: center;
    }
    #quizCard {
      min-height: 420px;
      padding-top: 2.5rem;
      padding-bottom: 2.5rem;
    }
  </style>
</head>
<body class="font-sans antialiased text-gray-800 bg-gray-50">
  <header class="bg-white shadow sticky top-0 z-50">
    <nav class="container mx-auto flex justify-between items-center py-2 px-6 md:py-2 md:px-8" aria-label="Main navigation">
      <a href="#hero" class="flex items-center gap-x-2 md:gap-x-4 pl-2 md:pl-4" aria-label="RoastPortal Home">
        <img src="images/favicon.png" alt="RoastPortal logo" class="h-10" />
        <span class="wordmark">
          <span class="roast">Roast</span>
          <span class="portal">Portal</span>
        </span>
      </a>
      <div class="flex items-center">
        <a class="text-[#2b1608] font-semibold hover:underline px-4 py-2 md:px-6 md:py-2 rounded transition-colors duration-150" href="/login">Login</a>
      </div>
    </nav>
  </header>
  <main id="main-content">
    <section id="hero" class="relative bg-cover bg-center min-h-[60vh] flex items-center justify-center overflow-hidden" style="background-image: url('images/hero-banner.png');">
      <div aria-hidden="true" class="absolute inset-0 bg-gradient-to-b from-[#2b1608]/90 via-black/80 to-black/90"></div>
      <!-- Animated gradient overlay -->
      <div aria-hidden="true" class="absolute inset-0 z-10 pointer-events-none animate-heroGradient"></div>
      <style>
        @keyframes heroGradient {
          0% {
            background: radial-gradient(circle at 30% 40%, rgba(34,197,94,0.10) 0%, rgba(43,22,8,0.08) 100%);
          }
          25% {
            background: radial-gradient(circle at 70% 60%, rgba(43,22,8,0.12) 0%, rgba(34,197,94,0.08) 100%);
          }
          50% {
            background: radial-gradient(circle at 60% 30%, rgba(34,197,94,0.09) 0%, rgba(43,22,8,0.08) 100%);
          }
          75% {
            background: radial-gradient(circle at 40% 70%, rgba(43,22,8,0.10) 0%, rgba(34,197,94,0.09) 100%);
          }
          100% {
            background: radial-gradient(circle at 30% 40%, rgba(34,197,94,0.10) 0%, rgba(43,22,8,0.08) 100%);
          }
        }
        .animate-heroGradient {
          animation: heroGradient 30s ease-in-out infinite;
          opacity: 1;
          z-index: 10;
        }
      </style>
      <span class="sr-only">Background image showing roasted coffee beans and a steaming mug</span>
      <div class="relative z-10 text-center px-6 py-20">
        <h1 class="text-4xl md:text-6xl font-bold text-white drop-shadow-lg mb-4" style="font-family: 'Poppins', 'Inter', 'Segoe UI', Arial, sans-serif; font-weight: 600;">Data‑driven coffee, <br> roasted for <span class="text-[#22c55e] drop-shadow font-extrabold">you</span></h1>
        <p class="text-lg md:text-2xl text-white mb-6 drop-shadow">Answer a few questions, sip, rate, repeat — our AI adapts every bag until it’s perfect for you.</p>
        <a class="bg-[#16a34a] text-white px-6 py-3 rounded-full font-medium text-lg hover:bg-[#22c55e] transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-200" href="#quiz">Take the quiz</a>
      </div>
    </section>
    <section id="how-it-works" class="py-16 bg-gray-100">
      <div class="container mx-auto px-6">
        <h2 class="text-3xl font-bold text-center mb-12">How it works</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
          <article class="text-center p-6 bg-white rounded-lg shadow-lg">
            <div class="text-5xl font-extrabold text-[#2b1608] mb-4">1</div>
            <h3 class="text-xl font-semibold mb-2">Share your taste</h3>
            <p class="text-gray-600 text-base px-4">Share your coffee preferences with our AI.</p>
          </article>
          <article class="text-center p-6 bg-white rounded-lg shadow-lg">
            <div class="text-5xl font-extrabold text-[#2b1608] mb-4">2</div>
            <h3 class="text-xl font-semibold mb-2">Enjoy your roast</h3>
            <p class="text-gray-600 text-base px-4">Enjoy a roast crafted just for you.</p>
          </article>
          <article class="text-center p-6 bg-white rounded-lg shadow-lg">
            <div class="text-5xl font-extrabold text-[#2b1608] mb-4">3</div>
            <h3 class="text-xl font-semibold mb-2">Refine your cup</h3>
            <p class="text-gray-600 text-base px-4">Give feedback to refine your perfect cup.</p>
          </article>
        </div>
      </div>
    </section>
    <section id="quiz" class="py-16 bg-white">
      <div class="container mx-auto px-6">
        <h2 class="text-3xl font-bold text-center mb-8">Train your coffee AI</h2>
        <form method="POST" action="#" class="max-w-3xl mx-auto bg-white/90 shadow-xl rounded-2xl p-6 md:p-10 transition-all duration-300" id="quizForm" aria-label="Coffee Preference Quiz">
          <!-- Step Indicator and Progress Bar -->
          <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
              <div></div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div id="progressBar" class="bg-[#22c55e] h-3 rounded-full transition-all duration-300" style="width:0%"></div>
            </div>
          </div>
          <!-- Quiz Card -->
          <div id="quizCard" class="relative min-h-[220px] flex flex-col justify-center items-center">
            <!-- Question will be rendered here -->
          </div>
          <div id="errorMessage" class="hidden text-red-500 text-sm font-medium mt-2 mb-0"></div>
          <div class="bg-gray-100 p-4 rounded text-sm hidden" id="summary" aria-live="polite"></div>
          <div class="flex flex-col sm:flex-row justify-between mt-6 gap-2">
            <button class="bg-[#22c55e] text-white px-6 py-3 rounded font-semibold text-base hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300 hidden transition-all duration-150" id="submitBtn" type="submit">Submit</button>
            <div class="flex flex-col sm:flex-row gap-2 sm:ml-auto">
              <button class="bg-[#22c55e] text-white px-6 py-3 rounded font-semibold text-base hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300 disabled:opacity-50 transition-all duration-150 order-1 sm:order-2" id="nextBtn" type="button">Next</button>
              <button class="bg-gray-300 text-gray-800 px-6 py-3 rounded font-semibold text-base hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 disabled:opacity-50 transition-all duration-150 order-2 sm:order-1" disabled id="prevBtn" type="button">Previous</button>
            </div>
          </div>
          <div id="loadingSpinner" class="hidden flex justify-center items-center mt-4">
            <svg class="animate-spin h-8 w-8 text-[#22c55e]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
          </div>
          <div id="submitMessage" class="hidden text-center text-lg font-semibold mt-4"></div>
        </form>
      </div>
    </section>
    <section class="container mx-auto px-6 max-w-3xl mt-12" aria-label="Frequently Asked Questions">
      <h2 class="text-3xl font-bold text-center mb-8">FAQ</h2>
      <div class="space-y-4">
        <details class="border border-gray-200 rounded-lg p-4">
          <summary class="pl-2 font-semibold cursor-pointer">How does it work?</summary>
          <p class="mt-2 text-gray-600">You answer a questionnaire. We send you your first personalized bag of coffee. You try it and give us feedback about that specific bag. We take your feedback and use AI to further improve how we roast coffee for you. Your next bag of coffee is upgraded with the new changes. After you try it, you can give us feedback again and we will continue to improve your coffee until it is perfect for you.</p>
        </details>
        <details class="border border-gray-200 rounded-lg p-4">
          <summary class="pl-2 font-semibold cursor-pointer">What makes you different from other coffee subscription services?</summary>
          <p class="mt-2 text-gray-600">Other services have a fixed number of coffee blends to choose from and they try to help you find which blend you would like best. We start with what you tell us you are looking for and then create a blend just for you. When you give us feedback on your blend, we tweak your blend just for you. Our goal is to work with you to create the perfect blend for you.</p>
        </details>
        <details class="border border-gray-200 rounded-lg p-4">
          <summary class="pl-2 font-semibold cursor-pointer">What is a blend?</summary>
          <p class="mt-2 text-gray-600">Other roasters mix one or more types of coffee together that are roasted in a specific way to create a blend that the roaster likes and then sells to a mass market. We believe blends should be personal to each individual. We use the same levers to create a blend, but by using AI, we are able to create a blend that isn’t trying to align with what our personal taste preferences are, but align with your taste preferences.</p>
        </details>
        <details class="border border-gray-200 rounded-lg p-4">
          <summary class="pl-2 font-semibold cursor-pointer">What if I want to have more than one blend?</summary>
          <p class="mt-2 text-gray-600">That’s easy. Just go into your settings and create a new blend. Any new blend you create will be optimized separately. You can specify how often you want us to send you each blend you have created.</p>
        </details>
        <details class="border border-gray-200 rounded-lg p-4">
          <summary class="pl-2 font-semibold cursor-pointer">Do I need to give feedback every time?</summary>
          <p class="mt-2 text-gray-600">No. If you don’t give feedback, we send you the same coffee as before.</p>
        </details>
        <details class="border border-gray-200 rounded-lg p-4">
          <summary class="pl-2 font-semibold cursor-pointer">How do I pause my subscription?</summary>
          <p class="mt-2 text-gray-600">Just turn on “vacation mode” in your settings.</p>
        </details>
        <details class="border border-gray-200 rounded-lg p-4">
          <summary class="pl-2 font-semibold cursor-pointer">How often will I get a new bag of coffee?</summary>
          <p class="mt-2 text-gray-600">After you open a new bag of coffee and leave feedback, we start creating the next version of your coffee and send it to you when done. We package it to remain fresh until you need it. If you don’t provide any feedback, we estimate when you will be running low on coffee and try to time it so we send you a new bag before you run out.</p>
        </details>
        <details class="border border-gray-200 rounded-lg p-4">
          <summary class="pl-2 font-semibold cursor-pointer">How much does the coffee cost?</summary>
          <p class="mt-2 text-gray-600">You get to choose how much you pay. Paying more impacts how much we are able to optimize the quality of your coffee.</p>
        </details>
        <details class="border border-gray-200 rounded-lg p-4">
          <summary class="pl-2 font-semibold cursor-pointer">What sizes of coffee can I buy?</summary>
          <p class="mt-2 text-gray-600">Currently we only sell 12oz bags of coffee. Please let us know if you would like to buy in bulk: support@roastportal.com.</p>
        </details>
      </div>
    </section>
  </main>
  <footer class="bg-gray-800 text-gray-200 py-8">
    <div class="container mx-auto px-6 flex flex-col md:flex-row justify-between items-center text-sm space-y-4 md:space-y-0">
      <a href="#hero" class="md:order-1" aria-label="Back to top">
        <img src="images/favicon.png" alt="RoastPortal logo" class="h-8" />
      </a>
      <p class="md:order-2">© 2025 RoastPortal. All rights reserved.</p>
      <div class="flex space-x-4 md:order-3">
        <a href="/terms" class="hover:underline">Terms</a>
        <a href="mailto:hello@roastportal.com" class="hover:underline">Contact</a>
      </div>
    </div>
  </footer>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbycyuhiCcG-zW3S0jLNFvxxx-TKPUghXoXXlJSJPDrZxX0CMkXABY0L7Lb9nxtUAG1Mdg/exec';
      // --- Modern Quiz UI/UX with Progress Bar ---
      const quizData = [
        {
          label: 'What roast level do you enjoy most?',
          type: 'radio',
          name: 'roastLevel',
          options: ['Light', 'Light-Medium', 'Medium', 'Medium-Dark', 'Dark'],
          help: 'Select the roast you prefer most.',
          required: false
        },
        {
          label: 'Which flavor notes do you love?',
          type: 'multi-range',
          names: ['flavorNutty','flavorFruity','flavorFloral','flavorSmoky'],
          min: 0, max: 100, step: 1,
          help: 'Move each slider to show how much you enjoy the flavor.',
          required: false,
          flavors: ['Nutty','Fruity','Floral','Smoky']
        },
        {
          label: 'How do you usually brew your coffee?',
          type: 'radio',
          name: 'brewMethod',
          options: ['Drip','Pour-over','French Press','Espresso','Single-Serve Pod','Cold Brew','Other'],
          help: 'Select the method you reach for most often.',
          required: false
        },
        {
          label: 'What brewing equipment do you have?',
          type: 'text',
          name: 'equipmentDetails',
          help: 'Let us know about your setup.',
          required: false
        },
        {
          label: 'Would you like us to grind the beans for you?',
          type: 'radio',
          name: 'grindService',
          options: ['Yes','No'],
          help: 'Choose yes if you want ready-to-brew ground coffee.',
          required: false
        },
        {
          label: 'How do you usually take your coffee?',
          type: 'checkbox',
          names: ['addMilk','addDairyFree','addSugar'],
          options: ['Milk / Cream','Dairy-free Milk','Sugar / Syrup'],
          help: 'Select all the extras you enjoy.',
          required: false
        },
        {
          label: "What's your coffee budget?",
          type: 'range',
          name: 'priceRange',
          min: 12, max: 100, step: 1,
          help: "Drag the slider to choose how much you're comfortable paying.",
          required: false,
          left: '$12', right: '$100'
        },
        {
          label: 'How adventurous is your coffee personality?',
          type: 'range',
          name: 'personality',
          min: 0, max: 100, step: 1,
          help: 'Slide from comforting to bold.',
          required: false,
          left: 'Comforting & Familiar', right: 'Adventurous & Complex'
        },
        {
          label: 'Where do you like your flavor balance?',
          type: 'multi-range',
          names: ['tasteSweetBitter','tasteSmoothTart'],
          min: 0, max: 100, step: 1,
          help: 'Adjust the sliders to show your taste.',
          required: false,
          flavors: ['Sweet ←→ Bitter','Smooth ←→ Tart']
        },
        {
          label: 'About how many cups do you drink on a normal day?',
          type: 'radio',
          name: 'cupsPerDay',
          options: ['1-2','3-5','6+'],
          help: 'Pick the range that fits your routine.',
          required: false
        },
        {
          label: 'What kind of water do you brew with?',
          type: 'radio',
          name: 'waterType',
          options: ['Unfiltered tap','Filtered tap','Recipe','Distilled'],
          help: 'Choose the type you use most often.',
          required: false
        },
        {
          label: 'Is there anything else we should know?',
          type: 'text',
          name: 'additionalNotes',
          help: 'Share any notes that could help us match you better.',
          required: false
        },
      ];

      let current = 0;
      let answers = {};
      let autoAdvancing = false;

      const quizCard = document.getElementById('quizCard');
      const progressBar = document.getElementById('progressBar');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      const errorMessage = document.getElementById('errorMessage');
      const summary = document.getElementById('summary');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const submitMessage = document.getElementById('submitMessage');

      // Add this helper function to map slider values to descriptive labels
      function getSliderLabel(name, value) {
        value = Number(value);
        if (name === 'roastLevel') {
          if (value <= 20) return 'Very Light';
          if (value <= 40) return 'Light';
          if (value <= 60) return 'Medium';
          if (value <= 80) return 'Dark';
          return 'Very Dark';
        }
        if (name === 'flavorNutty' || name === 'flavorFruity' || name === 'flavorFloral' || name === 'flavorSmoky') {
          if (value == 0) return 'Not at all';
          if (value > 0 && value < 25) return 'A little';
          if (value >= 25 && value < 50) return 'Somewhat';
          if (value >= 50 && value < 75) return 'A lot';
          if (value >= 75 && value < 100) return 'Really like it';
          if (value == 100) return 'Love it!';
        }
        if (name === 'personality') {
          if (value <= 20) return 'Comforting';
          if (value <= 40) return 'Familiar';
          if (value <= 60) return 'Balanced';
          if (value <= 80) return 'Adventurous';
          return 'Complex';
        }

        if (name === 'tasteSweetBitter') {
          if (value <= 20) return 'Very Sweet';
          if (value <= 40) return 'Sweet';
          if (value <= 60) return 'Balanced';
          if (value <= 80) return 'Bitter';
          return 'Very Bitter';
        }
        if (name === 'tasteSmoothTart') {
          if (value <= 20) return 'Very Smooth';
          if (value <= 40) return 'Smooth';
          if (value <= 60) return 'Balanced';
          if (value <= 80) return 'Tart';
          return 'Very Tart';
        }
        if (name === 'priceRange') {
          if (value <= 20) return 'Budget';
          if (value <= 40) return 'Value';
          if (value <= 60) return 'Standard';
          if (value <= 80) return 'Premium';
          return 'Luxury';
        }
        return '';
      }

      // Default values for each quiz field
      const quizDefaults = {
        roastLevel: 'Medium',
        flavorNutty: 50,
        flavorFruity: 50,
        flavorFloral: 50,
        flavorSmoky: 50,
        brewMethod: 'Drip',
        equipmentDetails: 'None',
        grindService: 'No',
        addMilk: false,
        addDairyFree: false,
        addSugar: false,
        priceRange: 35,
        additionalNotes: '',
        personality: 50,
        tasteSweetBitter: 50,
        tasteSmoothTart: 50,
        cupsPerDay: '1-2',
        waterType: 'Unfiltered tap'
      };

      function renderQuestion(idx) {
        if (idx < 0 || idx >= quizData.length) {
          console.error('renderQuestion: idx out of bounds', idx);
          quizCard.innerHTML = '<div class="text-red-500">Error: Question not found.</div>';
          return;
        }
        const q = quizData[idx];
        if (!q) {
          console.error('renderQuestion: question is undefined at idx', idx);
          quizCard.innerHTML = '<div class="text-red-500">Error: Question not found.</div>';
          return;
        }
        quizCard.innerHTML = '';
        if (q.type === 'radio') {
          // Use pill-styled box selection for roastLevel
          if (q.name === 'roastLevel') {
            quizCard.innerHTML = `
              <fieldset class="w-full">
                <legend class="block text-xl font-semibold mb-2">${q.label}</legend>
                <div class="text-gray-500 text-sm mb-2">${q.help || ''}</div>
                <div class="flex flex-wrap gap-3 mb-2 pill-input">
                  ${q.options.map(opt => `
                    <label class="cursor-pointer select-none">
                      <input type="radio" name="${q.name}" value="${opt}" ${answers[q.name] === opt ? 'checked' : ''} class="sr-only" />
                      <span class="inline-block px-6 py-3 rounded-full border font-medium transition-all duration-150 ${answers[q.name] === opt ? 'bg-[#22c55e] text-white border-[#22c55e] shadow-md' : 'bg-white text-gray-800 border-gray-300 hover:bg-gray-100'}">${opt}</span>
                    </label>
                  `).join('')}
                </div>
              </fieldset>
            `;
            const radios = quizCard.querySelectorAll(`input[type=radio][name='${q.name}']`);
            radios.forEach(radio => {
              radio.addEventListener('change', e => {
                if (autoAdvancing) return;
                answers[q.name] = e.target.value;
                autoAdvancing = true;
                setTimeout(() => {
                  if (current < quizData.length - 1) {
                    current++;
                    render();
                  }
                  autoAdvancing = false;
                }, 200);
              });
            });
            return;
          } else {
            // Default radio rendering for other radio questions
            quizCard.innerHTML = `
              <fieldset class="w-full">
                <legend class="block text-xl font-semibold mb-2">${q.label}</legend>
                <div class="text-gray-500 text-sm mb-2">${q.help || ''}</div>
                <div class="flex flex-wrap gap-3 mb-2 pill-input">
                  ${q.options.map(opt => `
                    <label class="cursor-pointer select-none">
                      <input type="radio" name="${q.name}" value="${opt}" ${answers[q.name] === opt ? 'checked' : ''} class="sr-only" />
                      <span class="inline-block px-6 py-3 rounded-full border font-medium transition-all duration-150 ${answers[q.name] === opt ? 'bg-[#22c55e] text-white border-[#22c55e] shadow-md' : 'bg-white text-gray-800 border-gray-300 hover:bg-gray-100'}">${opt}</span>
                    </label>
                  `).join('')}
                </div>
              </fieldset>
            `;
            const radios = quizCard.querySelectorAll(`input[type=radio][name='${q.name}']`);
            radios.forEach(radio => {
              radio.addEventListener('change', e => {
                if (autoAdvancing) return;
                answers[q.name] = e.target.value;
                autoAdvancing = true;
                setTimeout(() => {
                  if (current < quizData.length - 1) {
                    current++;
                    render();
                  }
                  autoAdvancing = false;
                }, 200);
              });
            });
            return;
          }
        } else if (q.type === 'range') {
          const val = answers[q.name] ?? (q.name === 'priceRange' ? 35 : 50);
          if (q.name === 'priceRange') {
            quizCard.innerHTML = `
              <div class='w-full relative'>
                <label class='block font-semibold text-lg mb-2'>${q.label}</label>
                <div class='text-gray-500 text-sm mb-2'>${q.help || ''}</div>
                <div class='relative w-full flex items-center'>
                  <input type='range' min='${q.min}' max='${q.max}' step='${q.step}' name='${q.name}' value='${val}' class='w-full accent-[#22c55e] mb-2' id='${q.name}' />
                  <span id='${q.name}Value' class='absolute pointer-events-none px-2 py-1 rounded bg-white border border-gray-300 text-[#22c55e] font-bold text-base shadow' style='top:-2.2rem; left:0;'>$${val}</span>
                </div>
                <div class='flex justify-between text-sm text-gray-500 mb-1'>
                  <span>${q.left || ''}</span>
                  <span>${q.right || ''}</span>
                </div>
              </div>
            `;
            const input = document.getElementById(q.name);
            const valueSpan = document.getElementById(q.name + 'Value');
            // Function to update value and position
            function updateSliderValue() {
              const min = Number(input.min);
              const max = Number(input.max);
              const val = Number(input.value);
              valueSpan.textContent = `$${val}`;
              // Calculate percent position
              const percent = (val - min) / (max - min);
              // Get slider width
              const sliderWidth = input.offsetWidth;
              // Thumb size and offset fudge factor
              const thumbSize = 32;
              const offset = thumbSize / 2;
              // Position value span
              valueSpan.style.left = `calc(${percent * 100}% - ${offset - percent * thumbSize}px)`;
            }
            input.addEventListener('input', e => {
              answers[q.name] = e.target.value;
              updateSliderValue();
            });
            // Initial position
            setTimeout(updateSliderValue, 10);
          } else {
            quizCard.innerHTML = `
              <div class='w-full'>
                <label class='block font-semibold text-lg mb-2'>${q.label}</label>
                <div class='text-gray-500 text-sm mb-2'>${q.help || ''}</div>
                <input type='range' min='${q.min}' max='${q.max}' step='${q.step}' name='${q.name}' value='${val}' class='w-full accent-[#22c55e] mb-2' id='${q.name}' />
                <div class='flex justify-between text-sm text-gray-500 mb-1'>
                  <span>${q.left || ''}</span>
                  <span>${q.right || ''}</span>
                </div>
                <div class='text-center'>
                  <span id='${q.name}Value' class='text-lg font-semibold'>${val}</span>
                </div>
              </div>
            `;
            const input = document.getElementById(q.name);
            const valueSpan = document.getElementById(q.name + 'Value');
            const labelSpan = document.getElementById(q.name + 'Label');
            input.addEventListener('input', e => { 
              valueSpan.textContent = e.target.value; 
              labelSpan.textContent = getSliderLabel(q.name, e.target.value);
              answers[q.name] = e.target.value;
            });
          }
        } else if (q.type === 'multi-range') {
          if (q.names[0] === 'flavorNutty') {
            quizCard.innerHTML = `
              <div class='w-full'>
                <label class='block font-semibold text-lg mb-2'>${q.label}${q.required ? ' <span class="text-red-500">*</span>' : ''}</label>
                <div class='text-gray-500 text-sm mb-2'>${q.help || ''}</div>
                <div class='grid grid-cols-1 md:grid-cols-2 gap-6 mt-2'>`;
            q.names.forEach((name, i) => {
              const val = (answers[name] ?? 50);
              quizCard.innerHTML += `<div><span class='text-sm'>${q.flavors[i]}</span><input type='range' min='${q.min}' max='${q.max}' step='${q.step}' name='${name}' value='${val}' class='w-full accent-[#22c55e]' id='${name}' /><div class='text-center text-base mt-1'><span class='block text-xs text-gray-500 mt-1' id='${name}Label'>${getSliderLabel(name, val)}</span></div></div>`;
            });
            quizCard.innerHTML += `</div>`;
          } else if (q.names[0] === 'tasteSweetBitter') {
            quizCard.innerHTML = `
              <div class='w-full'>
                <label class='block font-semibold text-lg mb-2'>${q.label}${q.required ? ' <span class="text-red-500">*</span>' : ''}</label>
                <div class='text-gray-500 text-sm mb-2'>${q.help || ''}</div>
                <div class='mt-4 space-y-4'>`;
            // Sweet ←→ Bitter
            const val1 = (answers['tasteSweetBitter'] ?? 50);
            quizCard.innerHTML += `<div class='flex items-center gap-2'>
              <span class='text-sm w-16 text-left'>Sweet</span>
              <input type='range' min='0' max='100' step='1' name='tasteSweetBitter' value='${val1}' class='w-full accent-[#22c55e]' id='tasteSweetBitter' />
              <span class='text-sm w-16 text-right'>Bitter</span>
            </div><div class='text-center text-base mt-1'><span class='block text-xs text-gray-500 mt-1' id='tasteSweetBitterLabel'>${getSliderLabel('tasteSweetBitter', val1)}</span></div>`;
            // Smooth ←→ Tart
            const val2 = (answers['tasteSmoothTart'] ?? 50);
            quizCard.innerHTML += `<div class='flex items-center gap-2'>
              <span class='text-sm w-16 text-left'>Smooth</span>
              <input type='range' min='0' max='100' step='1' name='tasteSmoothTart' value='${val2}' class='w-full accent-[#22c55e]' id='tasteSmoothTart' />
              <span class='text-sm w-16 text-right'>Tart</span>
            </div><div class='text-center text-base mt-1'><span class='block text-xs text-gray-500 mt-1' id='tasteSmoothTartLabel'>${getSliderLabel('tasteSmoothTart', val2)}</span></div>`;
            quizCard.innerHTML += `</div>`;
          } else {
            quizCard.innerHTML = `
              <div class='w-full'>
                <label class='block font-semibold text-lg mb-2'>${q.label}${q.required ? ' <span class="text-red-500">*</span>' : ''}</label>
                <div class='text-gray-500 text-sm mb-2'>${q.help || ''}</div>
                <div class='grid grid-cols-1 md:grid-cols-2 gap-6 mt-2'>`;
            q.names.forEach((name, i) => {
              const val = (answers[name] ?? 50);
              quizCard.innerHTML += `<div><span class='text-sm'>${q.flavors[i]}</span><input type='range' min='${q.min}' max='${q.max}' step='${q.step}' name='${name}' value='${val}' class='w-full accent-[#22c55e]' id='${name}' /><div class='text-center text-base mt-1'><span class='block text-xs text-gray-500 mt-1' id='${name}Label'>${getSliderLabel(name, val)}</span></div></div>`;
            });
            quizCard.innerHTML += `</div>`;
          }
        } else if (q.type === 'checkbox') {
          quizCard.innerHTML = `
            <div class='w-full'>
              <label class='block font-semibold text-lg mb-2'>${q.label}${q.required ? ' <span class="text-red-500">*</span>' : ''}</label>
              <div class='text-gray-500 text-sm mb-2'>${q.help || ''}</div>
              <div class='flex flex-wrap gap-3 mt-2 pill-input'>
                ${q.options.map((opt, i) => {
                  const checked = answers[q.names[i]] ? 'checked' : '';
                  return `<label class='cursor-pointer'>
                    <input type='checkbox' name='${q.names[i]}' value='1' ${checked} class='hidden' />
                    <span>${opt}</span>
                  </label>`;
                }).join('')}
              </div>
            </div>
          `;
        } else if (q.type === 'text') {
          const val = answers[q.name] ?? '';
          quizCard.innerHTML = `
            <div class='w-full'>
              <label class='block font-semibold text-lg mb-2'>${q.label}${q.required ? ' <span class="text-red-500">*</span>' : ''}</label>
              <div class='text-gray-500 text-sm mb-2'>${q.help || ''}</div>
              <textarea name='${q.name}' class='w-full mt-2 border-gray-300 rounded p-2 resize-y min-h-[3.5rem]' placeholder=''></textarea>
            </div>
          `;
          const textarea = quizCard.querySelector('textarea');
          textarea.value = val;
          textarea.addEventListener('focus', e => {
            // Center cursor in textarea on focus
            const len = e.target.value.length;
            // If empty, just focus; if not, set selection to middle
            if (len > 0) {
              const mid = Math.floor(len / 2);
              e.target.setSelectionRange(mid, mid);
            }
          });
          textarea.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
            }
          });
          textarea.addEventListener('input', e => {
            answers[q.name] = e.target.value;
          });
        }
        // Add listeners for dynamic value display
        if (q.type === 'range') {
          const input = document.getElementById(q.name);
          const valueSpan = document.getElementById(q.name + 'Value');
          const labelSpan = document.getElementById(q.name + 'Label');
          input.addEventListener('input', e => { 
            valueSpan.textContent = q.name === 'priceRange' ? '$' + e.target.value : e.target.value; 
          });
          input.addEventListener('change', e => { 
            valueSpan.textContent = q.name === 'priceRange' ? '$' + e.target.value : e.target.value; 
          });
        } else if (q.type === 'multi-range') {
          if (q.names[0] === 'flavorNutty') {
            const input1 = document.getElementById('flavorNutty');
            const valueSpan1 = document.getElementById('flavorNuttyValue');
            const labelSpan1 = document.getElementById('flavorNuttyLabel');
            input1.addEventListener('input', e => { labelSpan1.textContent = getSliderLabel('flavorNutty', e.target.value); });
            input1.addEventListener('change', e => { labelSpan1.textContent = getSliderLabel('flavorNutty', e.target.value); });
            const input2 = document.getElementById('flavorFruity');
            const valueSpan2 = document.getElementById('flavorFruityValue');
            const labelSpan2 = document.getElementById('flavorFruityLabel');
            input2.addEventListener('input', e => { labelSpan2.textContent = getSliderLabel('flavorFruity', e.target.value); });
            input2.addEventListener('change', e => { labelSpan2.textContent = getSliderLabel('flavorFruity', e.target.value); });
            const input3 = document.getElementById('flavorFloral');
            const valueSpan3 = document.getElementById('flavorFloralValue');
            const labelSpan3 = document.getElementById('flavorFloralLabel');
            input3.addEventListener('input', e => { labelSpan3.textContent = getSliderLabel('flavorFloral', e.target.value); });
            input3.addEventListener('change', e => { labelSpan3.textContent = getSliderLabel('flavorFloral', e.target.value); });
            const input4 = document.getElementById('flavorSmoky');
            const valueSpan4 = document.getElementById('flavorSmokyValue');
            const labelSpan4 = document.getElementById('flavorSmokyLabel');
            input4.addEventListener('input', e => { labelSpan4.textContent = getSliderLabel('flavorSmoky', e.target.value); });
            input4.addEventListener('change', e => { labelSpan4.textContent = getSliderLabel('flavorSmoky', e.target.value); });
          } else if (q.names[0] === 'tasteSweetBitter') {
            const input1 = document.getElementById('tasteSweetBitter');
            const valueSpan1 = document.getElementById('tasteSweetBitterValue');
            const labelSpan1 = document.getElementById('tasteSweetBitterLabel');
            input1.addEventListener('input', e => { labelSpan1.textContent = getSliderLabel('tasteSweetBitter', e.target.value); });
            input1.addEventListener('change', e => { labelSpan1.textContent = getSliderLabel('tasteSweetBitter', e.target.value); });
            const input2 = document.getElementById('tasteSmoothTart');
            const valueSpan2 = document.getElementById('tasteSmoothTartValue');
            const labelSpan2 = document.getElementById('tasteSmoothTartLabel');
            input2.addEventListener('input', e => { labelSpan2.textContent = getSliderLabel('tasteSmoothTart', e.target.value); });
            input2.addEventListener('change', e => { labelSpan2.textContent = getSliderLabel('tasteSmoothTart', e.target.value); });
          } else {
            q.names.forEach(name => {
              const input = document.getElementById(name);
              const valueSpan = document.getElementById(name + 'Value');
              const labelSpan = document.getElementById(name + 'Label');
              input.addEventListener('input', e => { labelSpan.textContent = getSliderLabel(name, e.target.value); });
              input.addEventListener('change', e => { labelSpan.textContent = getSliderLabel(name, e.target.value); });
            });
          }
        }
      }

      function updateProgress() {
        progressBar.style.width = `${((current + 1) / quizData.length) * 100}%`;
      }

      function showError(msg) {
        errorMessage.textContent = msg;
        errorMessage.classList.remove('hidden');
      }
      function hideError() {
        errorMessage.classList.add('hidden');
      }

      function render() {
        current = Math.max(0, Math.min(current, quizData.length - 1));
        renderQuestion(current);
        updateProgress();
        prevBtn.disabled = current === 0;
        nextBtn.disabled = false;
        submitBtn.classList.toggle('hidden', current !== quizData.length - 1);
        nextBtn.classList.toggle('hidden', current === quizData.length - 1);
        hideError();
      }

      // Restore Next/Previous button handlers
      nextBtn.addEventListener('click', () => {
        if (current < quizData.length - 1) {
          current++;
          render();
        }
      });

      prevBtn.addEventListener('click', () => {
        if (current > 0) {
          current--;
          render();
        }
      });

      // Handle input changes
      quizCard.addEventListener('input', e => {
        const q = quizData[current];
        if (q.type === 'range') {
          answers[q.name] = e.target.value;
          // Do NOT call render() here
        } else if (q.type === 'multi-range') {
          if (q.names.includes(e.target.name)) {
            answers[e.target.name] = e.target.value;
            // Do NOT call render() here
          }
        } else if (q.type === 'radio') {
          answers[q.name] = e.target.value;
          render();
        } else if (q.type === 'checkbox') {
          if (q.names.includes(e.target.name)) {
            answers[e.target.name] = e.target.checked;
            // Do NOT call render() here
          }
        } else if (q.type === 'text') {
          answers[q.name] = e.target.value;
          // Do NOT call render() here to avoid losing focus
        }
      });

      // Initial render
      render();

      // Required indicator for labels
      quizData.forEach(q => {
        const label = document.querySelector(`#quizCard label[for="${q.name}"]`);
        if (label && !label.innerHTML.includes('*')) {
          label.innerHTML += ' <span class="text-red-500">*</span>';
        }
      });

      // After quiz reset, reset Next button
      const quizForm = document.getElementById('quizForm');
      quizForm.addEventListener('reset', function() {
        current = 0;
        answers = {};
        render();
      });

      // Form submission handler
      quizForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Show loading state
        loadingSpinner.classList.remove('hidden');
        submitBtn.disabled = true;
        hideError();
        
        try {
          // Prepare form data
          const formData = new FormData();
          
          // Add timestamp
          formData.append('timestamp', new Date().toISOString());
          
          // Add all answers, using defaults if missing
          Object.keys(quizDefaults).forEach(key => {
            let value = answers[key];
            if (value === undefined || value === null || value === '') {
              value = quizDefaults[key];
            }
            // For checkboxes, ensure boolean is sent as 'TRUE'/'FALSE'
            if (typeof quizDefaults[key] === 'boolean') {
              value = value ? 'TRUE' : 'FALSE';
            }
            formData.append(key, value);
          });
          
          // Submit to Google Apps Script
          const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            body: formData
          });
          if (!response.ok) {
            throw new Error('Request failed');
          }
          
          // Show success message
          submitMessage.textContent = 'Thank you! Your coffee profile has been submitted successfully.';
          submitMessage.classList.remove('hidden');
          
          // Reset form after a delay
          setTimeout(() => {
            quizForm.reset();
            submitMessage.classList.add('hidden');
          }, 3000);
          
        } catch (error) {
          console.error('Submission error:', error);
          showError('There was an error submitting your responses. Please try again.');
        } finally {
          loadingSpinner.classList.add('hidden');
          submitBtn.disabled = false;
        }
      });

      // For all other questions, set required: false
      // In renderQuestion, after rendering the roastLevel pills:
      // if (q.type === 'radio' && q.name === 'roastLevel') {
      //   const radios = quizCard.querySelectorAll('input[type="radio"][name="roastLevel"]');
      //   radios.forEach(radio => {
      //     radio.addEventListener('change', e => {
      //       answers['roastLevel'] = e.target.value;
      //       setTimeout(() => {
      //         if (current < quizData.length - 1) {
      //           current++;
      //           render();
      //         }
      //       }, 200); // gentle delay for transition
      //     });
      //   });
      // }
    });
  </script>
</body>
</html>
