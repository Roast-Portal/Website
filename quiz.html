<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <meta name="theme-color" content="#FBFBFD" />
  <meta name="color-scheme" content="light" />
  <title>Roast Portal â€” Taste Preference Quiz</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5LTTX2TGVQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-5LTTX2TGVQ');
    gtag('config', 'AW-17346642053');
  </script>
  
  <!-- Event snippet for Submit lead form (1) conversion page -->
  <script>
    function gtag_report_conversion(url) {
      var callback = function () {
        if (typeof(url) != 'undefined') {
          window.location = url;
        }
      };
      gtag('event', 'conversion', {
        'send_to': 'AW-17346642053/djvHCNG48f4aEIWBw89A',
        'value': 0.0,
        'currency': 'USD',
        'event_callback': callback
      });
      return false;
    }
  </script>

  <link rel="stylesheet" href="css/font-system.css">
  <style>
    :root{
      --bg-primary:#FBFBFD;
      --bg-secondary:#F5F5F7;
      --text-primary:#1D1D1F;
      --text-secondary:#6E6E73;
      --accent-blue:#0071E3;
      --border-light:rgba(0,0,0,0.12);
      --radius:14px;
      --header-h:60px;
      --shadow:0 2px 10px rgba(0,0,0,.06);
      --ease: cubic-bezier(.25,.46,.45,.94);
      --focus: 2px solid #0071E3;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }

    /* Subscription Process Animation Styles */
    .subscription-intro {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        linear-gradient(135deg, #FBFBFD 0%, #F5F5F7 100%),
        radial-gradient(circle at 20% 80%, rgba(0, 113, 227, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(0, 113, 227, 0.03) 0%, transparent 50%);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.8s var(--ease);
    }

    .subscription-intro.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .intro-content {
      text-align: center;
      max-width: 600px;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .intro-logo {
      font-size: 2rem;
      font-weight: var(--font-weight-bold);
      color: var(--accent-blue);
      margin-bottom: 2rem;
      opacity: 0;
      animation: fadeInUp 0.6s var(--ease) 0.1s forwards;
    }

    .intro-title {
      font-size: 1.5rem;
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
      margin-bottom: 1.5rem;
      opacity: 0;
      animation: fadeInUp 0.6s var(--ease) 0.2s forwards;
    }

    .process-steps {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .process-step {
      display: flex;
      align-items: center;
      gap: 1rem;
      opacity: 0;
      animation: fadeInLeft 0.5s var(--ease) forwards;
    }

    .process-step:nth-child(1) { animation-delay: 0.3s; }
    .process-step:nth-child(2) { animation-delay: 0.5s; }
    .process-step:nth-child(3) { animation-delay: 0.7s; }
    .process-step:nth-child(4) { animation-delay: 0.9s; }
    .process-step:nth-child(5) { animation-delay: 1.1s; }

    .step-number {
      width: 32px;
      height: 32px;
      background: var(--accent-blue);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: var(--font-weight-bold);
      font-size: 0.875rem;
      flex-shrink: 0;
    }

    .step-text {
      font-size: 1rem;
      color: var(--text-primary);
      font-weight: 500;
      text-align: left;
    }

    .intro-subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      opacity: 0;
      animation: fadeInUp 0.6s var(--ease) 1.3s forwards;
    }

    .begin-btn {
      background: var(--accent-blue);
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: var(--font-weight-bold);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 2rem auto 0;
      transition: all 0.3s var(--ease);
      opacity: 0;
      animation: fadeInUp 0.6s var(--ease) 1.5s forwards;
      box-shadow: 0 8px 24px rgba(0, 113, 227, 0.3);
      position: relative;
      overflow: hidden;
      transform: scale(0.95);
    }

    .begin-btn {
      animation: fadeInUp 0.6s var(--ease) 1.5s forwards, scaleIn 0.4s var(--ease) 1.7s forwards;
    }

    .begin-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0, 113, 227, 0.4);
      background: #0051A3;
    }

    .begin-btn:active {
      transform: translateY(0);
      box-shadow: 0 6px 20px rgba(0, 113, 227, 0.3);
    }

    .begin-btn:focus-visible {
      outline: 3px solid rgba(0, 113, 227, 0.3);
      outline-offset: 2px;
    }

    .btn-text {
      font-weight: var(--font-weight-bold);
      letter-spacing: 0.02em;
    }

    .btn-icon {
      font-size: 1.2rem;
      transition: transform 0.3s var(--ease);
    }

    .begin-btn:hover .btn-icon {
      transform: translateX(4px);
    }

    /* Subtle pulse effect to draw attention */
    .begin-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--accent-blue);
      border-radius: 50px;
      opacity: 0;
      animation: pulse 2s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 0;
        transform: scale(1);
      }
      50% {
        opacity: 0.1;
        transform: scale(1.05);
      }
    }

    /* Button loading state */
    .begin-btn.loading {
      pointer-events: none;
      background: #6E6E73;
    }

    .begin-btn.loading .btn-text {
      opacity: 0.7;
    }

    .begin-btn.loading .btn-icon {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.95);
      }
      to {
        transform: scale(1);
      }
    }

    @keyframes loadingBounce {
      0%, 80%, 100% {
        transform: scale(0);
      }
      40% {
        transform: scale(1);
      }
    }

    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .intro-content {
        padding: 1.5rem;
        max-width: 100%;
      }
      
      .intro-logo {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
      }
      
      .intro-title {
        font-size: 1.25rem;
        margin-bottom: 1rem;
      }
      
      .process-step {
        gap: 0.75rem;
      }
      
      .step-number {
        width: 28px;
        height: 28px;
        font-size: 0.75rem;
      }
      
      .step-text {
        font-size: 0.9rem;
      }
      
      .intro-subtitle {
        font-size: 0.9rem;
      }
      
      .begin-btn {
        padding: 14px 28px;
        font-size: 1rem;
        margin-top: 1.5rem;
      }
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg-primary:#0E0E10;
        --bg-secondary:#151518;
        --text-primary:#F5F5F7;
        --text-secondary:#B3B3B8;
        --border-light:rgba(255,255,255,0.12);
        --accent-blue:#0071E3;
      }
    }

    /* Force light theme regardless of system preference */
    :root{
      --bg-primary:#FBFBFD;
      --bg-secondary:#F5F5F7;
      --text-primary:#1D1D1F;
      --text-secondary:#6E6E73;
      --border-light:rgba(0,0,0,0.12);
      --accent-blue:#0071E3;
    }
    body{ color-scheme: light; }

    *,*::before,*::after{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      font-family: var(--font-primary);
      font-weight: var(--font-weight-regular);
      background:var(--bg-primary);
      color:var(--text-primary);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Accessibility helpers */
    .sr-only{
      position:absolute!important; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }
    :focus-visible{ outline: var(--focus); outline-offset: 2px; border-radius: 8px; }

    /* Layout */
    .quiz-header{
      position:fixed; top:0; left:0; right:0; height:var(--header-h);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 16px; z-index:100;
      background: color-mix(in oklab, var(--bg-primary) 80%, transparent);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom:1px solid var(--border-light);
      padding-top: calc(var(--safe-top));
    }
    .brand{ font-weight: var(--font-weight-bold); font-size:18px; letter-spacing:.2px; }
    .exit-link{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:999px; text-decoration:none;
      border:1px solid var(--border-light); color:var(--text-primary); background:var(--bg-secondary);
    }

    .progress-wrap{
      position:fixed; top:calc(var(--header-h) + var(--safe-top));
      left:0; right:0; z-index:90;
    }
    .progress-rail{ height:4px; background:var(--bg-secondary); }
    .progress-bar{ height:4px; width:0%; background:var(--accent-blue); transition: width .35s var(--ease); }
    .progress-text{
      padding:6px 16px; font-size:12px; color:var(--text-secondary); display:flex; justify-content:space-between;
    }

    .quiz-container{
      max-width:720px; margin:0 auto;
      padding: calc(var(--header-h) + 36px + var(--safe-top)) 16px 120px;
      min-height:100dvh;
    }
    .quiz-content{ min-height: 52dvh; display:flex; align-items:center; }
    
    /* Mobile height optimization */
    @media (max-width: 619px) {
      .quiz-container { padding: calc(var(--header-h) + 16px + var(--safe-top)) 16px 120px; }
      .quiz-content { min-height: 35dvh; }
    }
    .quiz-step{
      width:100%; animation: fadeIn .35s var(--ease) both;
    }
    
    .quiz-container {
      opacity: 0;
      transition: opacity 0.8s var(--ease);
    }
    
    .quiz-container.show {
      opacity: 1;
    }
    
    @media (prefers-reduced-motion: reduce){
      .quiz-step{ animation:none; }
      .quiz-container { animation: none; opacity: 1; }
    }
    
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }
    

    .question-title{
      font-size: clamp(22px, 4.5vw, 32px); line-height:1.2; margin:0 0 10px; font-weight: var(--font-weight-bold);
    }
    .question-subtitle{
      margin:0 0 22px; color:var(--text-secondary); font-size:15px;
    }
    
    /* Mobile question spacing optimization */
    @media (max-width: 619px) {
      .question-title { margin: 0 0 6px; font-size: clamp(20px, 4vw, 28px); }
      .question-subtitle { margin: 0 0 12px; font-size: 13px; line-height: 1.3; }
    }

    /* Choice groups */
    fieldset{ border:0; margin:0; padding:0; }
    .answers{ display:grid; gap:12px; }
    .choice{
      display:block; width:100%;
      border:1px solid var(--border-light); background:#fff; color:#000;
      background:var(--bg-secondary); color:var(--text-primary);
      border-radius: var(--radius); padding:16px; font-size:16px; font-weight: var(--font-weight-bold);
      box-shadow: var(--shadow); cursor:pointer; text-align:center;
      min-height: 52px;
      transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease, color .15s ease, border-color .15s ease;
      user-select:none;
    }
    .choice:hover{ transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,.08); }
    input[type="radio"].visually-hidden,
    input[type="checkbox"].visually-hidden{ position:absolute; opacity:0; pointer-events:none; }

    input[type="radio"]:checked + label.choice,
    input[type="checkbox"]:checked + label.choice{
      background: var(--accent-blue); color:#fff; border-color: var(--accent-blue);
      box-shadow: 0 6px 18px rgba(0,113,227, .25);
    }

    /* Sliders */
    .flavor-grid{ display:grid; grid-template-columns:1fr; gap:22px; }
    .flavor-slider-group label{ display:block; font-weight: var(--font-weight-bold); margin:0 0 10px; }
    .slider-wrap{ position:relative; padding-top: 32px; }
    
    /* Mobile optimization for flavor sliders */
    @media (max-width: 619px) {
      .flavor-grid { gap: 12px; }
      .flavor-slider-group label { margin: 0 0 6px; font-size: 13px; }
      .slider-wrap { padding-top: 24px; }
      .slider-labels { font-size: 10px; margin-top: 3px; }
    }
    input[type="range"]{
      -webkit-appearance: none; appearance: none; width:100%; height:8px;
      background: var(--bg-secondary); border-radius:999px; outline:none;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; width:28px; height:28px; border-radius:50%;
      background: var(--accent-blue); box-shadow: 0 2px 6px rgba(0,113,227,.35); cursor:pointer;
      border:0;
    }
    input[type="range"]::-moz-range-thumb{
      width:28px; height:28px; border-radius:50%; background: var(--accent-blue); border:0; cursor:pointer;
      box-shadow: 0 2px 6px rgba(0,113,227,.35);
    }
    
    /* Mobile slider thumb optimization */
    @media (max-width: 619px) {
      input[type="range"]::-webkit-slider-thumb {
        width: 24px; height: 24px;
      }
      input[type="range"]::-moz-range-thumb {
        width: 24px; height: 24px;
      }
    }
    .bubble{
      position:absolute; top:-8px; transform: translateX(-50%);
      padding:4px 8px; font-size:12px; background: var(--bg-secondary); border:1px solid var(--border-light);
      border-radius: 8px; white-space:nowrap;
      z-index: 10;
    }
    .slider-labels{ display:flex; justify-content:space-between; font-size:12px; color:var(--text-secondary); margin-top:6px; }

    /* Inputs */
    .text-input, .textarea-input {
      width:100%; padding:14px 16px; font-size:16px; border-radius: var(--radius);
      border:1px solid var(--border-light); background:#fff; background:var(--bg-secondary);
      color:var(--text-primary); box-shadow: var(--shadow);
      margin-bottom: 0; /* Reset default margins */
    }
    .textarea-input{ min-height:120px; resize: vertical; }
    .field-row{ display:grid; gap:12px; grid-template-columns:1fr; }
    @media (min-width: 600px){ .field-row{ grid-template-columns:1fr 1fr; } }
    
    /* Contact form specific styling for consistent spacing */
    .contact-form { 
      display: block !important; /* Override grid display */
      gap: 0 !important; /* Remove grid gap */
    }
    .contact-form .field-row { 
      margin-bottom: 12px !important; 
    }
    .contact-form .text-input { 
      margin-bottom: 12px !important; 
    }
    .contact-form .error { 
      margin-top: 8px !important; 
    }
    
    /* Ensure consistent spacing for all contact form elements */
    .contact-form > * {
      margin-bottom: 12px !important;
    }
    .contact-form > *:last-child {
      margin-bottom: 0 !important;
    }

    /* Sticky nav */
    .quiz-nav{
      position: fixed; left:0; right:0; bottom:0; z-index:95;
      background: color-mix(in oklab, var(--bg-primary) 92%, transparent);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border-top:1px solid var(--border-light);
      padding:12px 16px calc(12px + var(--safe-bottom));
      display:flex; gap:12px; justify-content:space-between; align-items:center;
    }
    .nav-btn{
      flex:1; padding:14px 18px; border-radius:999px; font-weight: var(--font-weight-bold); font-size:16px; cursor:pointer;
      border:1px solid var(--border-light); background:var(--bg-secondary); color:var(--text-primary); min-height:52px;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .nav-btn:hover{ transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,.08); }
    .primary{ background: var(--accent-blue); color:#fff; border-color: var(--accent-blue); }
    .nav-btn:disabled{ opacity:.5; transform:none; box-shadow:none; cursor:not-allowed; }

    .toolbar{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      margin-top:6px; color:var(--text-secondary); font-size:12px;
    }
    .linklike{ background:none; border:0; padding:6px 10px; border-radius:8px; cursor:pointer; color:var(--text-secondary); text-decoration:underline; }
    .error{ color:#B00020; font-size:14px; margin-top:10px; }

  </style>
</head>
<body>
  <!-- Subscription Process Introduction Animation -->
  <div class="subscription-intro" id="subscription-intro">
    <div class="intro-content">
      <div class="intro-logo">â˜• Roast Portal</div>
      <h1 class="intro-title">Your Personalized Coffee Journey</h1>
      
      <div class="process-steps">
        <div class="process-step">
          <div class="step-number">1</div>
          <div class="step-text">Answer a few questions about your taste</div>
        </div>
        <div class="process-step">
          <div class="step-number">2</div>
          <div class="step-text">Subscribe to your personalized blend</div>
        </div>
        <div class="process-step">
          <div class="step-number">3</div>
          <div class="step-text">Let AI build your custom coffee profile</div>
        </div>
        <div class="process-step">
          <div class="step-number">4</div>
          <div class="step-text">Give feedback on your blend</div>
        </div>
        <div class="process-step">
          <div class="step-number">5</div>
          <div class="step-text">Get your improved blend, repeat!</div>
        </div>
      </div>
      
      <p class="intro-subtitle">Ready to discover your perfect blend?</p>
      
      <button class="begin-btn" id="begin-btn">
        <span class="btn-text">Begin Now</span>
        <span class="btn-icon">â†’</span>
      </button>
    </div>
  </div>

  <a class="sr-only" href="#quiz-content">Skip to quiz</a>

  <header class="quiz-header" role="banner">
    <div class="brand" aria-label="Roast Portal">Roast Portal</div>
    <div>
      <button id="reset-btn" class="linklike" aria-describedby="reset-help">Reset</button>
      <span id="reset-help" class="sr-only">Clears saved answers and restarts the quiz</span>
      <a href="index.html" class="exit-link" aria-label="Return to main page">Back to Main</a>
    </div>
  </header>

  <div class="progress-wrap" aria-hidden="true">
    <div class="progress-rail">
      <div class="progress-bar" id="progress-bar"></div>
            </div>
    <div class="progress-text" id="progress-text">
      <span>Step 1</span><span>0%</span>
    </div>
  </div>

  <main id="quiz-content" class="quiz-container" role="main">
    <div class="quiz-content" aria-live="polite"></div>
    <div class="toolbar" aria-live="polite" id="status"></div>
  </main>

  <nav class="quiz-nav" aria-label="Quiz navigation">
    <button class="nav-btn" id="prev-btn">Back</button>
    <button class="nav-btn primary" id="next-btn">Next</button>
  </nav>

  <script>
    // --- Google Apps Script Integration ---
    // Quiz submissions are sent to: https://script.google.com/macros/s/AKfycbzPAMu_-e7bZ6qXQRawEQqAfmSMy3HnAS31qeayNCATDCsUHdDuipldJf253-FsB7WUog/exec
    // This script handles quiz data collection and can be configured to send emails, store in Google Sheets, etc.
    
    // --- Google Analytics Tracking ---
    function trackQuizEvent(eventName, parameters = {}) {
      try {
        if (typeof gtag === 'function') {
          gtag('event', eventName, {
            ...parameters,
            page_title: document.title,
            page_location: window.location.href,
            timestamp: Date.now()
          });
        }
      } catch (error) {
        console.error('Google Analytics tracking error:', error);
      }
    }
    
    function trackQuestionView(questionId, questionTitle, stepNumber) {
      trackQuizEvent('question_view', {
        question_id: questionId,
        question_title: questionTitle,
        step_number: stepNumber,
        total_steps: quizData.length,
        custom_parameter: 'quiz_progress'
      });
    }
    
    function trackAnswerSelection(questionId, answer, stepNumber) {
      trackQuizEvent('answer_selection', {
        question_id: questionId,
        answer: answer,
        step_number: stepNumber,
        total_steps: quizData.length,
        custom_parameter: 'quiz_interaction'
      });
    }
    
    function trackButtonClick(buttonName, buttonLocation, stepNumber) {
      trackQuizEvent('button_click', {
        button_name: buttonName,
        button_location: buttonLocation,
        step_number: stepNumber,
        total_steps: quizData.length,
        custom_parameter: 'quiz_navigation'
      });
    }
    
    function trackQuizProgress(stepNumber, totalSteps) {
      const progress = Math.round((stepNumber / totalSteps) * 100);
      trackQuizEvent('quiz_progress', {
        step_number: stepNumber,
        total_steps: totalSteps,
        progress_percentage: progress,
        custom_parameter: 'quiz_milestone'
      });
    }
    
    function trackQuizStart() {
      trackQuizEvent('quiz_start', {
        custom_parameter: 'quiz_begin'
      });
    }
    
    function trackQuizCompletion(answers) {
      trackQuizEvent('quiz_completion', {
        total_questions: quizData.length,
        questions_answered: Object.keys(answers).length,
        custom_parameter: 'quiz_finished'
      });
    }
    
    // --- Utilities ---
    const storageKey = 'quizAnswers';
    const stepKey = 'quizCurrentStep';
    
    const safeGtag = (...args) => { try{ if(typeof gtag === 'function') gtag(...args); }catch(_){} };
    const $ = sel => document.querySelector(sel);
    
    const moneyFromQuarters = (q)=> `$${(q/4).toFixed(2)}`;
    const emailOk = (e)=> /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'').trim());

    // Build a checkout-compatible rp_quiz payload from current answers
    function buildRpQuizPayload(a){
      const s = v => (v == null ? '' : String(v));
      const additions = Array.isArray(a.additions) ? a.additions.join(', ') : s(a.additions);
      return {
        roastLevel: s(a.roastLevel),
        brewMethod: s(a.brewMethod),
        additions,
        cupsPerDay: s(a.cupsPerDay),
        personality: s(a.personality),
        tasteBalance: s(a.tasteBalance),
        flavorNutty: s(a.flavorNutty),
        flavorFruity: s(a.flavorFruity),
        flavorFloral: s(a.flavorFloral),
        flavorSmoky: s(a.flavorSmoky),
        priceRange: s(a.priceRange),
        equipmentDetails: s(a.equipmentDetails),
        additionalNotes: s(a.additionalNotes),
        blendName: s(a.blendName),
        firstName: s(a.firstName),
        lastName: s(a.lastName),
        email: s(a.email)
      };
    }
    
    // --- Data ---
    const quizData = [
      { id:'roastLevel', title:'What roast level do you enjoy most?', subtitle:'From light and bright to deep and bold.', type:'single-choice', answers:['Light','Light-Medium','Medium','Medium-Dark','Dark'], required:true },
      { id:'flavorNotes', title:'What kind of flavors do you typically enjoy in a cup of coffee?', subtitle:'Select all that apply.', type:'multiple-choice', answers:[
          'Chocolatey & Nutty',
          'Sweet & Fruity',
          'Floral & Delicate',
          'Smoky & Rich'
        ], required:false
      },
      { id:'brewMethod', title:'How do you usually brew your coffee?', subtitle:"We'll grind to match your method.", type:'single-choice', answers:['Drip','Pour-over','French Press','Single-Serve Pod','Cold Brew','Other'], required:true },
      { id:'equipmentDetails', title:'What brewing equipment do you have?', subtitle:'Tell us about your setup.', type:'text', placeholder:'e.g., Chemex, V60, Moka pot, Nespresso', required:false },
      { id:'additions', title:'How do you take your coffee?', subtitle:'Select all that apply.', type:'multiple-choice', answers:['Black','Milk / Cream','Dairy-free Milk','Sugar / Syrup'], required:false },
      { id:'priceRange', title:'How much do you want to spend per cup?', subtitle:"We'll match your budget.", type:'slider', min:8, max:36, defaultValue:20, minLabel:'$2.00', maxLabel:'$9.00', required:false },
      { id:'cupsPerDay', title:'How many cups of coffee do you drink per day?', subtitle:'Choose one.', type:'single-choice', answers:['1 cup per day','More than one cup per day'], required:false },
      { id:'adventurousness', title:'How do you like to explore new coffees?', subtitle:"Let us know your preference.", type:'single-choice', answers:["I know what I like and I stick to it",'I enjoy trying new things sometimes',"I'm always looking for something new and exciting"], required:false },
      { id:'bodyPreference', title:'What do you prefer in a coffee?', subtitle:'Choose the option that sounds best to you.', type:'single-choice', answers:['A smooth, balanced, and easy-drinking cup','A complex cup with a pleasant tartness','A rich, heavy-bodied, and intense cup'], required:false },
      { id:'additionalNotes', title:'Anything else we should know?', subtitle:'Optionalâ€”any notes or allergies.', type:'textarea', placeholder:'e.g., love caramel, avoid blueberry; prefer low acidity', required:false },
      { id:'blendName', title:'Name your blend', subtitle:'Give your custom roast a memorable name.', type:'text', placeholder:'e.g., Morning Magic, Daily Grind', required:false },
      { id:'contactInfo', title:'Where should we send your match?', subtitle:"We'll email your custom profile and first pack details.", type:'contact-form', required:true }
    ];

    const quizContent = document.querySelector('.quiz-content');
    const progressBar = $('#progress-bar');
    const progressText = $('#progress-text');
    const status = $('#status');
    const prevBtn = $('#prev-btn');
    const nextBtn = $('#next-btn');
    const resetBtn = $('#reset-btn');

    let currentStep = 0;
    let answers = {};
    let hasAttemptedSubmit = false;
    let submissionInProgress = false;
    let submissionCompleted = false;

    // --- Storage ---
    function saveProgress(){
      try{
        localStorage.setItem(storageKey, JSON.stringify(answers));
        localStorage.setItem(stepKey, String(currentStep));
        // Maintain compatibility with checkout by also saving rp_quiz
        localStorage.setItem('rp_quiz', JSON.stringify(buildRpQuizPayload(answers)));
      }catch(_){}
    }
    function loadProgress(){
      try{
        const a = localStorage.getItem(storageKey);
        const s = localStorage.getItem(stepKey);
        if(a){ answers = JSON.parse(a)||{}; }
        if(s && !Number.isNaN(Number(s))){ currentStep = Math.min(Math.max(0, Number(s)), quizData.length-1); }
      }catch(_){}
    }
    function resetProgress(){
      try{
        localStorage.removeItem(storageKey);
        localStorage.removeItem(stepKey);
      }catch(_){}
      answers = {};
      currentStep = 0;
      hasAttemptedSubmit = false;
      renderStep(true);
      updateNav();
      safeGtag('event','quiz_reset');
    }

    // --- Rendering ---
    function renderStep(focusTitle=false){
      const step = quizData[currentStep];
      quizContent.innerHTML = '';
      hasAttemptedSubmit = false;

      // Track question view
      trackQuestionView(step.id, step.title, currentStep + 1);

      const stepEl = document.createElement('section');
      stepEl.className = 'quiz-step';
      stepEl.setAttribute('role','group');
      stepEl.setAttribute('aria-labelledby', step.id + '-title');

      const title = document.createElement('h2');
      title.className = 'question-title'; title.id = step.id + '-title';
      title.textContent = step.title;

      const subtitle = document.createElement('p');
      subtitle.className = 'question-subtitle';
      subtitle.textContent = step.subtitle;

      const answersWrap = document.createElement('div');
      answersWrap.className = 'answers';

      // Build by type:
      if(step.type === 'single-choice'){
        const fs = document.createElement('fieldset');
        fs.setAttribute('role','radiogroup');
        fs.setAttribute('aria-labelledby', step.id + '-title');
        step.answers.forEach((opt, idx)=>{
          const input = document.createElement('input');
          input.type = 'radio'; input.name = step.id; input.value = opt; input.id = step.id + '-' + idx;
          input.className = 'visually-hidden';
          if(answers[step.id] === opt){ input.checked = true; }

          const label = document.createElement('label');
          label.className = 'choice'; label.setAttribute('for', input.id);
          label.textContent = opt;

          input.addEventListener('change', ()=>{
            answers[step.id] = opt;
            saveProgress();
            updateNav();
            // Track answer selection
            trackAnswerSelection(step.id, opt, currentStep + 1);
            safeGtag('event','quiz_answer',{ step_id: step.id, answer: opt });
          });

          fs.appendChild(input); fs.appendChild(label);
        });
        answersWrap.appendChild(fs);
      }

      if(step.type === 'multiple-choice'){
        const fs = document.createElement('fieldset');
        fs.setAttribute('aria-describedby', step.id + '-desc');
        const desc = document.createElement('div');
        desc.id = step.id + '-desc'; desc.className = 'sr-only';
        desc.textContent = 'You may select multiple.';
        fs.appendChild(desc);

        const selected = new Set(Array.isArray(answers[step.id]) ? answers[step.id] : []);
        step.answers.forEach((opt, idx)=>{
          const input = document.createElement('input');
          input.type = 'checkbox'; input.name = step.id; input.value = opt; input.id = step.id + '-' + idx;
          input.className = 'visually-hidden';
          if(selected.has(opt)) input.checked = true;

          const label = document.createElement('label');
          label.className = 'choice'; label.setAttribute('for', input.id);
          label.textContent = opt;

          input.addEventListener('change', ()=>{
            if(!answers[step.id]) answers[step.id] = [];
            if(input.checked) { 
              if(!answers[step.id].includes(opt)) answers[step.id].push(opt); 
              // Track answer selection
              trackAnswerSelection(step.id, opt, currentStep + 1);
            }
            else { 
              answers[step.id] = answers[step.id].filter(v => v !== opt); 
            }
            saveProgress();
            updateNav();
          });

          fs.appendChild(input); fs.appendChild(label);
        });
        answersWrap.appendChild(fs);
      }

      if(step.type === 'flavor-profile'){
        const grid = document.createElement('div');
        grid.className = 'flavor-grid';
        step.flavors.forEach(f=>{
          const group = document.createElement('div');
          group.className = 'flavor-slider-group';
          const lab = document.createElement('label');
          lab.textContent = f.label;
          lab.setAttribute('for', f.id);

          const wrap = document.createElement('div');
          wrap.className = 'slider-wrap';

          const slider = document.createElement('input');
          slider.type = 'range'; slider.min = 0; slider.max = 100;
          slider.value = answers[f.id] ?? 50; slider.id = f.id; slider.name = f.id;

          wrap.appendChild(slider);

          const labels = document.createElement('div');
          labels.className = 'slider-labels';
          labels.innerHTML = '<span>Dislike</span><span>Love it</span>';

          group.appendChild(lab);
          group.appendChild(wrap);
          group.appendChild(labels);
          grid.appendChild(group);

          slider.addEventListener('input', ()=>{
            answers[f.id] = slider.value;
            saveProgress();
            // Track slider adjustment
            trackAnswerSelection(step.id, `${f.id}:${slider.value}`, currentStep + 1);
          });
        });
        answersWrap.appendChild(grid);
      }

      if(step.type === 'slider'){
        const group = document.createElement('div');
        group.className = 'flavor-slider-group';
        const lab = document.createElement('label');
        lab.textContent = step.title;
        lab.className = 'sr-only'; // Title already shown above.

        const wrap = document.createElement('div');
        wrap.className = 'slider-wrap';

        const bubble = document.createElement('div');
        bubble.className = 'bubble';

        const slider = document.createElement('input');
        slider.type='range';
        slider.min=step.min; slider.max=step.max;
        slider.value = answers[step.id] ?? step.defaultValue ?? step.min;
        slider.id = step.id;

        const labels = document.createElement('div');
        labels.className = 'slider-labels';
        labels.innerHTML = `<span>${step.minLabel||''}</span><span>${step.maxLabel||''}</span>`;

        const positionBubble = ()=>{
          const min = Number(slider.min), max = Number(slider.max), v = Number(slider.value);
          const percent = (v - min) / (max - min);
          bubble.style.left = `calc(${percent*100}% + ${(14 - percent*28)}px)`;
          bubble.textContent = moneyFromQuarters(v);
        };
        positionBubble();

        slider.addEventListener('input', ()=>{
          answers[step.id] = Number(slider.value);
          positionBubble();
          saveProgress();
          // Track slider adjustment
          trackAnswerSelection(step.id, `price:${slider.value}`, currentStep + 1);
        });
        window.addEventListener('resize', positionBubble, { passive:true });

        wrap.appendChild(bubble);
        wrap.appendChild(slider);
        group.appendChild(lab);
        group.appendChild(wrap);
        group.appendChild(labels);
        answersWrap.appendChild(group);
      }

      if(step.type === 'text'){
        const input = document.createElement('input');
        input.type='text'; input.id=step.id; input.className='text-input';
        input.placeholder = step.placeholder||''; input.value = answers[step.id] || '';
        input.autocomplete = 'off'; input.inputMode = 'text';
        input.addEventListener('input', ()=>{
          answers[step.id] = input.value;
        saveProgress();
          updateNav();
          // Track text input (debounced to avoid too many events)
          clearTimeout(input._trackingTimeout);
          input._trackingTimeout = setTimeout(() => {
            trackAnswerSelection(step.id, `text_input:${input.value.length}chars`, currentStep + 1);
          }, 1000);
        });
        answersWrap.appendChild(input);
      }

      if(step.type === 'textarea'){
        const texta = document.createElement('textarea');
        texta.id=step.id; texta.className='textarea-input';
        texta.placeholder = step.placeholder||''; texta.value = answers[step.id] || '';
        texta.addEventListener('input', ()=>{
          answers[step.id] = texta.value;
          saveProgress();
          // Track textarea input (debounced to avoid too many events)
          clearTimeout(texta._trackingTimeout);
          texta._trackingTimeout = setTimeout(() => {
            trackAnswerSelection(step.id, `textarea_input:${texta.value.length}chars`, currentStep + 1);
          }, 1000);
        });
        answersWrap.appendChild(texta);
      }

      if(step.type === 'contact-form'){
        // Add contact-form class to answersWrap for consistent spacing
        answersWrap.classList.add('contact-form');
        
        const row = document.createElement('div'); row.className='field-row';
        const fn = document.createElement('input');
        fn.type='text'; fn.id='firstName'; fn.className='text-input'; fn.placeholder='First name';
        fn.autocomplete='given-name'; fn.value = answers.firstName || '';
        const ln = document.createElement('input');
        ln.type='text'; ln.id='lastName'; ln.className='text-input'; ln.placeholder='Last name';
        ln.autocomplete='family-name'; ln.value = answers.lastName || '';
        const em = document.createElement('input');
        em.type='email'; em.id='email'; em.className='text-input'; em.placeholder='Email address';
        em.autocomplete='email'; em.inputMode='email'; em.value = answers.email || '';

        [fn,ln,em].forEach(inp=>{
          inp.addEventListener('input', ()=>{
            answers[inp.id] = inp.value;
            saveProgress();
            updateNav();
            // Track contact form input (debounced to avoid too many events)
            clearTimeout(inp._trackingTimeout);
            inp._trackingTimeout = setTimeout(() => {
              trackAnswerSelection('contact_form', `${inp.id}:${inp.value.length}chars`, currentStep + 1);
            }, 1000);
          });
        });

        row.appendChild(fn); row.appendChild(ln);
        answersWrap.appendChild(row);
        answersWrap.appendChild(em);

        const err = document.createElement('div'); err.id='contact-error'; err.className='error'; err.role='alert';
        answersWrap.appendChild(err);
      }

      stepEl.appendChild(title);
      stepEl.appendChild(subtitle);
      stepEl.appendChild(answersWrap);
      quizContent.appendChild(stepEl);

      if(focusTitle){
        // Focus title for SR users on step change
        setTimeout(()=> title.focus({ preventScroll:true }), 0);
        title.tabIndex = -1;
      }

      updateNav();
      updateProgress();
      safeGtag('event','quiz_step_view',{ step_index: currentStep+1, step_id: step.id, step_title: step.title });
    }

    function updateProgress(){
      const pct = Math.round((currentStep/quizData.length)*100);
      progressBar.style.width = pct + '%';
      progressText.innerHTML = `<span></span><span></span>`;
    }

    function isStepValid(){
      const step = quizData[currentStep];
      if(!step.required) return true;
      if(step.type === 'single-choice') return Boolean(answers[step.id]);
      if(step.type === 'text') return Boolean((answers[step.id]||'').trim());
      if(step.type === 'contact-form'){
        const ok = Boolean((answers.firstName||'').trim()) && emailOk(answers.email);
        const err = document.getElementById('contact-error');
        if(err && hasAttemptedSubmit) {
          err.textContent = ok ? '' : 'Please enter your first name and a valid email.';
        }
        return ok;
      }
      // Sliders / multi / flavor-profile arenâ€™t required in this config
      return true;
    }

    function updateNav(){
      // On first question, back button should go to previous page
      if (currentStep === 0) {
        prevBtn.disabled = false;
        prevBtn.textContent = 'Back';
      } else {
        prevBtn.disabled = false;
        prevBtn.textContent = 'Back';
      }
      nextBtn.textContent = (currentStep === quizData.length-1) ? 'Submit' : 'Next';
      nextBtn.disabled = !isStepValid();
    }

    // Submit quiz data to Google Apps Script
    async function submitQuizToGoogleScript(answers) {
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbzPAMu_-e7bZ6qXQRawEQqAfmSMy3HnAS31qeayNCATDCsUHdDuipldJf253-FsB7WUog/exec';
      
      try {
        // Build payload for Google Apps Script
        const payload = {
          tab: 'Orders',
          source: 'quiz_completion',
          firstName: answers.firstName || '',
          lastName: answers.lastName || '',
          email: answers.email || '',
          roastLevel: answers.roastLevel || '',
          brewMethod: answers.brewMethod || '',
          equipmentDetails: answers.equipmentDetails || '',
          additions: Array.isArray(answers.additions) ? answers.additions.join(', ') : (answers.additions || ''),
          priceRange: answers.priceRange || '',
          cupsPerDay: answers.cupsPerDay || '',
          personality: answers.personality || '',
          tasteBalance: answers.tasteBalance || '',
          flavorNutty: answers.flavorNutty || '',
          flavorFruity: answers.flavorFruity || '',
          flavorFloral: answers.flavorFloral || '',
          flavorSmoky: answers.flavorSmoky || '',
          blendName: answers.blendName || 'Your Daily Roast',
          additionalNotes: answers.additionalNotes || '',
          submission_id: 'quiz_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          timestamp: new Date().toISOString(),
          page_path: window.location.pathname,
          referrer: document.referrer || '',
          user_agent: navigator.userAgent
        };

        console.log('Submitting quiz data to Google Apps Script:', payload);
        
        const form = new URLSearchParams();
        Object.entries(payload).forEach(([k,v]) => form.append(k, String(v ?? '')));
        
        const response = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: form.toString(),
          keepalive: true
        });

        if (response.ok) {
          console.log('Quiz data submitted successfully to Google Apps Script');
          return true;
        } else {
          console.error('Google Apps Script submission failed:', response.status, response.statusText);
          return false;
        }
      } catch (error) {
        console.error('Error submitting quiz data to Google Apps Script:', error);
        return false;
      }
    }
    
    // Submission ID generation moved to checkout page
    
    // Fallback submission method (no longer needed)
    function submitQuizViaForm(answers) {
      console.log('Fallback submission no longer needed - checkout handles all submissions');
      return;
    }

    // --- Navigation ---
    nextBtn.addEventListener('click', async ()=>{
      console.log('Next button clicked, step:', currentStep + 1, 'of', quizData.length);
      
      // Track button click
      trackButtonClick('Next', 'quiz_navigation', currentStep + 1);
      
      // Prevent multiple clicks during submission
      if (submissionInProgress || submissionCompleted) {
        console.log('Submission in progress or completed, ignoring click...');
        return;
      }
      
      // Set submission in progress immediately to prevent rapid clicking
      submissionInProgress = true;
      console.log('Submission in progress set to true');
      
      hasAttemptedSubmit = true;
      if(!isStepValid()) return;
      if(currentStep < quizData.length - 1){
        // Track progress milestone
        trackQuizProgress(currentStep + 1, quizData.length);
        
        // Reset submission in progress for next step
        submissionInProgress = false;
        currentStep++;
        saveProgress();
        renderStep(true);
      }else{
        // Track quiz completion
        trackQuizCompletion(answers);
        
        // Finalize and submit to Google Apps Script
        const payload = {
          answers,
          meta: {
            completedAt: new Date().toISOString(),
            steps: quizData.length,
            version: 1
          }
        };
        
        // Store quiz data for checkout
        try{
          localStorage.setItem(storageKey, JSON.stringify(payload.answers));
          // Save rp_quiz for checkout page
          localStorage.setItem('rp_quiz', JSON.stringify(buildRpQuizPayload(answers)));
          // Mark quiz as completed
          localStorage.setItem('quiz_completed', 'true');
        }catch(_){}
        
        safeGtag('event','quiz_completed');
        // Track conversion when quiz is completed
        gtag('event', 'conversion', {
          'send_to': 'AW-17346642053/djvHCNG48f4aEIWBw89A',
          'value': 0.0,
          'currency': 'USD'
        });
        
        // Mark submission as completed to prevent multiple submissions
        submissionCompleted = true;
        submissionInProgress = false;
        console.log('Quiz completed, submission flags set - completed:', submissionCompleted, 'in progress:', submissionInProgress);
        
        // Show completion status
        status.innerHTML = '<span style="color: #34A853;">âœ“ Quiz completed! Submitting your data to Google Apps Script...</span>';
        
        // Disable the button to prevent further clicks
        nextBtn.disabled = true;
        console.log('Next button disabled to prevent further clicks');
        
        // Submit to Google Apps Script
        try {
          const submissionSuccess = await submitQuizToGoogleScript(answers);
          if (submissionSuccess) {
            status.innerHTML = '<span style="color: #34A853;">âœ“ Quiz data submitted successfully! Redirecting to checkout...</span>';
            console.log('Quiz data submitted to Google Apps Script successfully');
          } else {
            status.innerHTML = '<span style="color: #FF9500;">âš  Quiz completed! Redirecting to checkout...</span>';
            console.log('Quiz data submission failed, but continuing to checkout');
          }
        } catch (error) {
          console.error('Error during Google Apps Script submission:', error);
          status.innerHTML = '<span style="color: #FF9500;">âš  Quiz completed! Redirecting to checkout...</span>';
        }
        
        // Small delay to show success message before redirect
        setTimeout(() => {
          console.log('Redirecting to checkout...');
          // Redirect to checkout page
          window.location.href = 'checkout.html';
        }, 2000);
      }
    });

    prevBtn.addEventListener('click', ()=>{
      // Track button click
      trackButtonClick('Back', 'quiz_navigation', currentStep + 1);
      
      if(currentStep > 0){
        // Go to previous quiz question
        currentStep--;
        saveProgress();
        renderStep(true);
      } else {
        // On first question, go back to previous page
        if (window.history.length > 1) {
          window.history.back();
        } else {
          // Fallback to main page if no history
          window.location.href = 'index.html';
        }
      }
    });

    // Keyboard shortcuts - consolidated to prevent multiple submissions
    document.addEventListener('keydown', (e)=>{
      const tag = (e.target && e.target.tagName) || '';
      const inField = ['INPUT','TEXTAREA'].includes(tag);
      
      // Arrow keys for navigation (when not in input fields)
      if(e.key === 'ArrowRight' && !inField){ 
        e.preventDefault(); 
        if(!nextBtn.disabled && !submissionInProgress && !submissionCompleted) nextBtn.click(); 
      }
      if(e.key === 'ArrowLeft' && !inField){ 
        e.preventDefault(); 
        if(!prevBtn.disabled) prevBtn.click(); 
      }
      
      // Enter/Return key acts as Next button (always, including in text fields)
      if(e.key === 'Enter' || e.key === 'Return'){ 
        e.preventDefault(); 
        if(!nextBtn.disabled && !submissionInProgress && !submissionCompleted) nextBtn.click(); 
      }
    });

    resetBtn.addEventListener('click', ()=>{
      // Track reset button click
      trackQuizEvent('quiz_reset', {
        step_number: currentStep + 1,
        total_steps: quizData.length,
        custom_parameter: 'quiz_reset'
      });
      
      if(confirm('Reset your quiz and clear saved answers?')) resetProgress();
    });

    // Track exit link clicks
    document.addEventListener('click', (e) => {
      const exitLink = e.target.closest('.exit-link');
      if (exitLink) {
        trackQuizEvent('quiz_exit', {
          step_number: currentStep + 1,
          total_steps: quizData.length,
          custom_parameter: 'quiz_abandoned'
        });
      }
    });
    
    // Track quiz abandonment (when user leaves the page)
    window.addEventListener('beforeunload', () => {
      trackQuizEvent('quiz_abandonment', {
        step_number: currentStep + 1,
        total_steps: quizData.length,
        custom_parameter: 'page_unload'
      });
    });
    
    // Initial render
    loadProgress();
    
    // Check if quiz was already submitted today
    const today = Date.now().toString().slice(0, -3); // Daily key
    const submissionKey = 'quiz_submitted_' + today;
    if (localStorage.getItem(submissionKey)) {
      submissionCompleted = true;
      console.log('Quiz already submitted today, preventing duplicate submissions');
    }
    
    // Handle subscription intro animation
    function handleSubscriptionIntro() {
      const introElement = document.getElementById('subscription-intro');
      const beginBtn = document.getElementById('begin-btn');
      
      if (!introElement || !beginBtn) return;
      
      // Check if user has already seen the intro in this session
      if (sessionStorage.getItem('quiz_intro_shown')) {
        introElement.remove();
        return;
      }
      
      // Mark intro as shown for this session
      sessionStorage.setItem('quiz_intro_shown', 'true');
      
      // Add click event listener to begin button
      beginBtn.addEventListener('click', function() {
        // Track begin button click
        trackQuizEvent('subscription_intro_begin', {
          custom_parameter: 'intro_start'
        });
        
        // Add loading state to button
        beginBtn.classList.add('loading');
        beginBtn.querySelector('.btn-text').textContent = 'Starting...';
        
        // Fade out intro after button click
        setTimeout(() => {
          introElement.classList.add('fade-out');
          
          // Show quiz container
          const quizContainer = document.querySelector('.quiz-container');
          if (quizContainer) {
            quizContainer.classList.add('show');
          }
          
          // Remove intro element after fade out animation completes
          setTimeout(() => {
            if (introElement.parentNode) {
              introElement.parentNode.removeChild(introElement);
            }
          }, 800); // Match the CSS transition duration
        }, 300); // Small delay to show loading state
      });
    }
    
    // Start the intro animation
    handleSubscriptionIntro();
    
    // Track quiz start
    trackQuizStart();
    
    renderStep();
  </script>
</body>
</html>