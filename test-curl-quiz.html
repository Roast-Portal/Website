<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Submission Test - Curl Format</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f7;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1d1d1f;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #0071e3;
        }
        button {
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #0051a3;
        }
        button:disabled {
            background: #999;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .curl-command {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            overflow-x: auto;
        }
        .field-group {
            margin-bottom: 15px;
        }
        .field-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .field-group input, .field-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .field-group select {
            background: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Quiz Submission Test - Curl Format</h1>
        
        <div class="test-section">
            <h3>Test Data Configuration</h3>
            <p>Configure the test data below to match your curl command format:</p>
            
            <div class="field-group">
                <label for="tab">Tab:</label>
                <input type="text" id="tab" value="Orders" placeholder="Orders">
            </div>
            
            <div class="field-group">
                <label for="source">Source:</label>
                <input type="text" id="source" value="buy_click" placeholder="buy_click">
            </div>
            
            <div class="field-group">
                <label for="firstName">First Name:</label>
                <input type="text" id="firstName" value="Test" placeholder="Test">
            </div>
            
            <div class="field-group">
                <label for="lastName">Last Name:</label>
                <input type="text" id="lastName" value="User" placeholder="User">
            </div>
            
            <div class="field-group">
                <label for="email">Email:</label>
                <input type="email" id="email" value="you@example.com" placeholder="you@example.com">
            </div>
            
            <div class="field-group">
                <label for="roastLevel">Roast Level:</label>
                <select id="roastLevel">
                    <option value="Light">Light</option>
                    <option value="Light-Medium">Light-Medium</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="Medium-Dark">Medium-Dark</option>
                    <option value="Dark">Dark</option>
                </select>
            </div>
            
            <div class="field-group">
                <label for="brewMethod">Brew Method:</label>
                <select id="brewMethod">
                    <option value="Drip" selected>Drip</option>
                    <option value="Pour-over">Pour-over</option>
                    <option value="French Press">French Press</option>
                    <option value="Single-Serve Pod">Single-Serve Pod</option>
                    <option value="Cold Brew">Cold Brew</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div class="field-group">
                <label for="blendName">Blend Name:</label>
                <input type="text" id="blendName" value="CLI Blend" placeholder="CLI Blend">
            </div>
            
            <div class="field-group">
                <label for="billedServings">Billed Servings:</label>
                <input type="number" id="billedServings" value="14" min="1" max="100">
            </div>
            
            <div class="field-group">
                <label for="bonus">Bonus:</label>
                <input type="number" id="bonus" value="1" min="0" max="10">
            </div>
            
            <div class="field-group">
                <label for="totalServings">Total Servings:</label>
                <input type="number" id="totalServings" value="15" min="1" max="100">
            </div>
            
            <div class="field-group">
                <label for="submission_id">Submission ID:</label>
                <input type="text" id="submission_id" value="debug_123" placeholder="debug_123">
            </div>
        </div>

        <div class="test-section">
            <h3>Generated Curl Command</h3>
            <div class="curl-command" id="curl-command">
                <!-- Curl command will be generated here -->
            </div>
            <button onclick="generateCurlCommand()">Generate Curl Command</button>
            <button onclick="copyCurlCommand()">Copy to Clipboard</button>
        </div>

        <div class="test-section">
            <h3>Test Submission</h3>
            <p>Test the submission using the configured data:</p>
            <button onclick="testSubmission()" id="test-btn">Test Submission</button>
            <button onclick="testSubmissionWithBeacon()" id="test-beacon-btn">Test with sendBeacon</button>
            <div id="test-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>Current Google Script URLs</h3>
                    <p><strong>Checkout (Quiz Submissions):</strong> <code>AKfycbwhrYLxp9jWxPwcyM4qZqJQkAQEOH-sTz2mw9A7YNziEXkEdtJ520sOgfmMcXmFq0rvbA</code></p>
        <p><strong>Test Script:</strong> <code>AKfycbwhrYLxp9jWxPwcyM4qZqJQkAQEOV-sTz2mw9A7YNziEXkEdtJ520sOgfmMcXmFq0rvbA</code></p>
            <p><strong>Contact Form:</strong> <code>AKfycbyuuoHLme_YQQChx3JCOFVcyz4H0e_oMpNn-OnzzZAEj_iMIxciVAVub2OJdZPmBGUN</code></p>
            <p><strong>Quiz (Legacy):</strong> <code>AKfycbz51E_2YHKN4KLQnghZgiys4yfQcYuD27jyfsPAKDWaIVzWngueaErxnAhDc_nLTPzjsA</code></p>
        </div>
    </div>

    <script>
        // Google Script URL from checkout.html (where quiz submissions are actually sent)
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwhrYLxp9jWxPwcyM4qZqJQkAQEOH-sTz2mw9A7YNziEXkEdtJ520sOgfmMcXmFq0rvbA/exec';
        
        function getFormData() {
            return {
                tab: document.getElementById('tab').value,
                source: document.getElementById('source').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                roastLevel: document.getElementById('roastLevel').value,
                brewMethod: document.getElementById('brewMethod').value,
                blendName: document.getElementById('blendName').value,
                billedServings: document.getElementById('billedServings').value,
                bonus: document.getElementById('bonus').value,
                totalServings: document.getElementById('totalServings').value,
                submission_id: document.getElementById('submission_id').value
            };
        }
        
        function generateCurlCommand() {
            const data = getFormData();
            const curlCommand = `curl -X POST '${GOOGLE_SCRIPT_URL}' \\
  -H 'Content-Type: application/x-www-form-urlencoded' \\
  --data-urlencode 'tab=${data.tab}' \\
  --data-urlencode 'source=${data.source}' \\
  --data-urlencode 'firstName=${data.firstName}' \\
  --data-urlencode 'lastName=${data.lastName}' \\
  --data-urlencode 'email=${data.email}' \\
  --data-urlencode 'roastLevel=${data.roastLevel}' \\
  --data-urlencode 'brewMethod=${data.brewMethod}' \\
  --data-urlencode 'blendName=${data.blendName}' \\
  --data-urlencode 'billedServings=${data.billedServings}' \\
  --data-urlencode 'bonus=${data.bonus}' \\
  --data-urlencode 'totalServings=${data.totalServings}' \\
  --data-urlencode 'submission_id=${data.submission_id}'`;
            
            document.getElementById('curl-command').textContent = curlCommand;
        }
        
        function copyCurlCommand() {
            const curlText = document.getElementById('curl-command').textContent;
            if (curlText) {
                navigator.clipboard.writeText(curlText).then(() => {
                    alert('Curl command copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = curlText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Curl command copied to clipboard!');
                });
            }
        }
        
        async function testSubmission() {
            const resultDiv = document.getElementById('test-result');
            const testBtn = document.getElementById('test-btn');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing submission...';
            resultDiv.className = 'result info';
            
            testBtn.disabled = true;
            
            try {
                const data = getFormData();
                const formData = new URLSearchParams();
                
                Object.entries(data).forEach(([key, value]) => {
                    formData.append(key, String(value));
                });
                
                console.log('Submitting data:', data);
                console.log('Form data:', formData.toString());
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData.toString(),
                    mode: 'no-cors' // Required for Google Apps Script
                });
                
                resultDiv.innerHTML = '✅ Submission successful!\n\nResponse status: ' + response.status + '\nResponse type: ' + response.type + '\n\nNote: Google Apps Script returns opaque response due to CORS restrictions. Check your Google Apps Script logs for confirmation.';
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = '❌ Submission failed: ' + error.message + '\n\nError details: ' + error.stack;
                resultDiv.className = 'result error';
                console.error('Submission error:', error);
            } finally {
                testBtn.disabled = false;
            }
        }
        
        function testSubmissionWithBeacon() {
            const resultDiv = document.getElementById('test-result');
            const testBtn = document.getElementById('test-beacon-btn');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing submission with sendBeacon...';
            resultDiv.className = 'result info';
            
            testBtn.disabled = true;
            
            try {
                const data = getFormData();
                const formData = new URLSearchParams();
                
                Object.entries(data).forEach(([key, value]) => {
                    formData.append(key, String(value));
                });
                
                console.log('Submitting data with sendBeacon:', data);
                
                if ('sendBeacon' in navigator) {
                    const blob = new Blob([formData.toString()], { 
                        type: 'application/x-www-form-urlencoded' 
                    });
                    
                    const success = navigator.sendBeacon(GOOGLE_SCRIPT_URL, blob);
                    
                    if (success) {
                        resultDiv.innerHTML = '✅ sendBeacon submission successful!\n\nData sent successfully. Check your Google Apps Script logs for confirmation.';
                        resultDiv.className = 'result success';
                    } else {
                        resultDiv.innerHTML = '❌ sendBeacon returned false\n\nThis usually means the browser rejected the request. Check console for details.';
                        resultDiv.className = 'result error';
                    }
                } else {
                    resultDiv.innerHTML = '❌ sendBeacon not supported\n\nFalling back to fetch...';
                    resultDiv.className = 'result error';
                    testSubmission();
                }
                
            } catch (error) {
                resultDiv.innerHTML = '❌ sendBeacon submission failed: ' + error.message;
                resultDiv.className = 'result error';
                console.error('sendBeacon error:', error);
            } finally {
                testBtn.disabled = false;
            }
        }
        
        // Generate initial curl command
        generateCurlCommand();
    </script>
</body>
</html>
