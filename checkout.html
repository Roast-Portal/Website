<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Performance hints -->
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#FBFBFD">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b0b0d">
  <title>Roast Portal â€” Checkout</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5LTTX2TGVQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-5LTTX2TGVQ');
  </script>

  <style>
    :root{
      /* Light scheme */
      --bg-primary:#FBFBFD; 
      --surface:#ffffff;
      --text-primary:#1D1D1F; 
      --text-secondary:#6E6E73;
      --border:rgba(0,0,0,0.08); 
      --blue:#0071E3;
      --shadow: 0 10px 30px rgba(0,0,0,.06);
      --surface-radius:20px;
      --focus: 0 0 0 3px rgba(0,113,227,.35);
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg-primary:#0b0b0d;
        --surface:#141417;
        --text-primary:#F5F5F7;
        --text-secondary:#B0B0B5;
        --border:rgba(255,255,255,0.12);
        --blue:#2997ff;
        --shadow: 0 12px 28px rgba(0,0,0,.45);
        --focus: 0 0 0 3px rgba(41,151,255,.45);
      }
    }

    /* Base resets */
    *,*::before,*::after{ box-sizing:border-box; }
    html{ -webkit-text-size-adjust:100%; }

    /* Viewport-height that works everywhere */
    :root{
      --vh: 1vh; /* JS will update on legacy browsers */
    }

    html, body{
      height:100%;
    }

    body{
      margin:0; 
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
      background:var(--bg-primary);
      color:var(--text-primary);
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-overflow-scrolling:touch;
      overflow-x:hidden;
      overscroll-behavior-y: contain; /* Prevent rubber-band jank during checkout */
    }

    /* Container uses dvh with graceful fallbacks */
    .container{
      max-width:1080px;
      margin-inline:auto;
      padding:clamp(12px, 2.2vw, 24px);
      min-height:100vh;
    }
    @supports (height: 100dvh){
      .container{ min-height:100dvh; }
    }

    .surface{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--surface-radius);
      box-shadow:var(--shadow);
      padding:clamp(16px, 2.2vw, 24px);
    }

    h1{
      font-size:clamp(22px, 2.2vw, 28px);
      margin:0 0 6px;
      font-weight:800;
      letter-spacing:-0.01em;
    }

    p.sub{
      color:var(--text-secondary);
      margin:0 0 20px;
      font-size:clamp(14px, 1.6vw, 16px);
    }

    .grid{
      display:grid;
      grid-template-columns:1.5fr 1fr;
      gap:clamp(16px, 3.2vw, 32px);
      align-items:start;
    }

    .section-title{
      font-weight:800;
      margin:0 0 8px;
      font-size:clamp(16px, 1.9vw, 18px);
      letter-spacing:-0.01em;
    }

    .desc{
      color:var(--text-secondary);
      line-height:1.5;
      margin:0 0 16px;
      font-size:clamp(13px, 1.5vw, 14px);
    }

    .badges{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:transparent; color:var(--text-secondary);
    }

    .divider{ height:1px; background:var(--border); margin:16px 0; }

    .line{ display:flex; justify-content:space-between; gap:12px; margin:8px 0; font-size:14px; }
    .muted{ color:var(--text-secondary); }
    .price{ font-weight:700; }
    .total{ font-weight:900; font-size:16px; }

    .actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:20px; flex-wrap:wrap; }

    .btn{
      appearance:none; -webkit-appearance:none;
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text-primary);
      padding:12px 20px; border-radius:999px; cursor:pointer;
      font-size:14px; font-weight:600; box-shadow:0 1px 6px rgba(0,0,0,.06);
      transition:transform .2s ease, box-shadow .2s ease; position:relative;
    }
    @media (hover:hover){
      .btn:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.10); }
    }
    .btn:focus-visible{ outline:none; box-shadow:var(--focus); }
    .btn[disabled], .btn[aria-busy="true"]{ opacity:.6; cursor:not-allowed; }

    .btn.primary{ background:var(--blue); color:#fff; border-color:transparent; box-shadow:0 8px 20px rgba(0,113,227,.28); }
    @media (hover:hover){
      .btn.primary:hover{ box-shadow:0 10px 25px rgba(0,113,227,.35); }
    }

    /* Pouch visualization */
    .visual{ text-align:center; margin-bottom:24px; position:relative; }
    .pouch-stack{ display:inline-block; position:relative; margin-bottom:16px; }

    .pouch-extreme{ 
      --pouch-min: min(120px, 160px); 
      --bag-bg:#0a0a0a; 
      --bag-radius-frac:0.0375; 
      --pouch-border-frac:0.003; 
      --pouch-border-color: rgba(0,0,0,0.1); 
      --label-bg:#FDFEFE; 
      --label-radius-frac:0.055; 
      --label-top-frac:0.88; 
      --label-pad-frac:0.04; 
      --label-gradient: linear-gradient(135deg, rgba(245, 248, 252, 0.65) 0%, rgba(252, 254, 255, 0.45) 50%, rgba(248, 250, 252, 0.4) 100%); 
      --label-gradient-opacity:0.85; 
    }

    .pouch-extreme.pouch-container{ position:relative; inline-size:120px; block-size:160px; container-type:inline-size }

    .pouch-extreme .pouch{ position:absolute; inset:0; background:var(--bag-bg); border-radius: calc(var(--bag-radius-frac) * var(--pouch-min)) calc(var(--bag-radius-frac) * var(--pouch-min)) calc(var(--bag-radius-frac) * .8 * var(--pouch-min)) calc(var(--bag-radius-frac) * .8 * var(--pouch-min)); overflow:hidden; isolation:isolate; box-shadow: 0 12px 28px rgba(0,0,0,.18), 0 2px 6px rgba(0,0,0,.10); }

    .pouch-extreme .pouch::after{ content:""; position:absolute; inset:0; z-index:3; pointer-events:none; border-radius: inherit; clip-path: inherit; box-shadow: inset 0 0 0 calc(var(--pouch-border-frac) * var(--pouch-min)) var(--pouch-border-color); }

    .pouch-extreme .pouch{
      --rT: calc(var(--bag-radius-frac) * 100cqw);
      --rB: calc(var(--bag-radius-frac) * 80cqw);
      --t1: var(--rT); --t2: calc(var(--rT)*.6); --t3: calc(var(--rT)*.4); --t4: calc(var(--rT)*.2);
      --b1: var(--rB); --b2: calc(var(--rB)*.6); --b3: calc(var(--rB)*.4); --b4: calc(var(--rB)*.2);
      --nx: 1; --nox: calc(4cqw * var(--nx));
      clip-path: polygon(0 var(--t1), var(--t4) var(--t2), var(--t3) var(--t3), var(--t2) var(--t4), var(--t1) 0,
                         calc(100% - var(--t1)) 0, calc(100% - var(--t2)) var(--t4), calc(100% - var(--t3)) var(--t3), calc(100% - var(--t4)) var(--t2), 100% var(--t1),
                         100% calc(var(--t1) + 4cqw), calc(100% - var(--nox)) calc(var(--t1) + 6cqw), 100% calc(var(--t1) + 8cqw),
                         100% calc(100% - var(--b1)), calc(100% - var(--b4)) calc(100% - var(--b2)), calc(100% - var(--b3)) calc(100% - var(--b3)), calc(100% - var(--b2)) calc(100% - var(--b4)), calc(100% - var(--b1)) 100%,
                         var(--b1) 100%, var(--b2) calc(100% - var(--b4)), var(--b3) calc(100% - var(--b3)), var(--b4) calc(100% - var(--b2)), 0 calc(100% - var(--b1)),
                         0 calc(var(--t1) + 8cqw), var(--nox) calc(var(--t1) + 6cqw), 0 calc(var(--t1) + 4cqw),
                         0 var(--t1)); 
    }

    .pouch-extreme .top-seal{ position:absolute; inset-inline:0; inset-block-start:0; height:10cqw; background-color:var(--bag-bg); border-bottom:1px solid rgba(220,225,230,0.32);
      background-image: repeating-linear-gradient(180deg, rgba(255,255,255,0.06) 0 1px, rgba(0,0,0,0.08) 1px 2px, transparent 2px 3px), linear-gradient(0deg, rgba(0,0,0,0.28) 0, transparent 50%), radial-gradient(100% 50% at 50% 0%, rgba(255,255,255,0.06) 0, transparent 70%); box-shadow: inset 0 -1px 0 rgba(0,0,0,0.38), inset 0 1px 0 rgba(220,225,230,0.22); clip-path: inherit; }

    .pouch-extreme .pouch-label{ --pad: calc(var(--label-pad-frac) * var(--pouch-min)); position:absolute; left:var(--pad); right:var(--pad); bottom:var(--pad); top: calc(100% - (var(--label-top-frac) * 100%)); background:var(--label-bg); border-radius: calc(var(--label-radius-frac) * var(--pouch-min)); padding:16px 12px; overflow:hidden; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; box-shadow: inset 0 1px 0 rgba(255,255,255,0.5), inset 0 -1px 0 rgba(0,0,0,0.05), 0 4px 12px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.04); }

    .pouch-extreme .pouch-label::before{ content:""; position:absolute; inset:0; border-radius:inherit; background:linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 60%), var(--label-gradient), radial-gradient(120% 80% at 18% 20%, hsla(210, 42%, 88%, 0.25) 0 40%, transparent 70%), radial-gradient(130% 78% at 80% 24%, hsla(200, 40%, 90%, 0.22) 0 38%, transparent 72%), radial-gradient(110% 88% at 64% 84%, hsla(180, 38%, 92%, 0.20) 0 42%, transparent 74%); opacity: calc(var(--label-gradient-opacity) * 0.7); }

    .label-badge{ padding:6px 10px; border-radius:14px; color:#fff; background:var(--blue); font-size:11px; font-weight:800; box-shadow:0 0 0 1px rgba(0,113,227,.28); margin-bottom:8px; display:inline-block; position:relative; z-index:1; }
    .label-tagline{ font-size:14px; font-weight:800; color:#1d1d1f; margin-bottom:6px; position:relative; z-index:1; text-shadow: 0 1px 2px rgba(0,0,0,0.05); line-height:1.2; }
    .label-description{ font-size:12px; color:#2b2b30; margin-top:6px; line-height:1.3; position:relative; z-index:1; letter-spacing: -0.01em; }

    @media (prefers-color-scheme: dark){
      .label-tagline{ color:#F5F5F7; }
      .label-description{ color:#D8D8DC; }
    }

    .qty-badge{ position:absolute; top:8px; inset-inline-end:8px; background:#111; color:#fff; border-radius:999px; font-size:12px; padding:6px 10px; font-weight:700; }

    /* Responsive tweaks */
    @media(max-width: 860px){
      .grid{ grid-template-columns:1fr; gap:24px; }
      .surface{ border-radius:16px; }
    }

    @media(max-width: 480px){
      .actions{ flex-direction:column; }
      .btn{ width:100%; padding:14px 20px; font-size:15px; }
      .surface{ border-radius:12px; }
    }

    /* Motion & contrast prefs */
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation-duration:.01ms !important; animation-iteration-count:1 !important; }
    }
    @media (prefers-contrast: more){
      :root{ --border: rgba(0,0,0,.35); }
      @media (prefers-color-scheme: dark){ :root{ --border: rgba(255,255,255,.45); } }
    }
  </style>
</head>
<body>
  <div class="container">
    <main class="surface" role="main" aria-labelledby="page-title">
      <h1 id="page-title">Checkout</h1>
      <p class="sub">Review your custom blend and complete your order.</p>
      <section id="checkout" class="grid" aria-live="polite" aria-atomic="true"></section>
    </main>
  </div>

  <noscript>
    <style> .grid{display:block} .actions{display:none} </style>
    <div style="max-width:1080px;margin:12px auto;color:#b00;padding-inline:16px;">
      JavaScript is disabled. Enable it to review your blend and complete checkout.
    </div>
  </noscript>

  <script>
  (function(){
    'use strict';

    // ---- Utilities ----
    const currencyFmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
    const $$ = (n) => currencyFmt.format(Number(n || 0));

    const esc = (s) => String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');

    function safeGetLS(key){
      try{ return window.localStorage.getItem(key); }catch{ return null; }
    }
    function safeSetLS(key, val){
      try{ window.localStorage.setItem(key, String(val)); }catch{}
    }

    function parseNumberLike(x, fallback = 0){
      if (typeof x === 'number' && isFinite(x)) return x;
      if (typeof x === 'string'){
        const m = x.match(/[\d.]+/);
        if (m) return parseFloat(m[0]);
      }
      return fallback;
    }

    function mapPrice(per){
      const val = parseNumberLike(per, 20);
      const pct = (val - 8) / (36 - 8);
      const price = Math.max(2, Math.min(9, +(2 + 7 * pct).toFixed(2)));
      return price;
    }

    function roundTo95(amount){
      const ceil = Math.ceil(Number(amount || 0));
      return Math.max(0, ceil - 0.05); // e.g. 12.01 -> 12.95, 12 -> 11.95 (intentional pricing rule)
    }

    function loadData(){
      try{ return JSON.parse(safeGetLS('rp_quiz') || '{}'); }catch{ return {}; }
    }

    function topFlavors(d){
      return [ ['Nutty', d.flavorNutty], ['Fruity', d.flavorFruity], ['Floral', d.flavorFloral], ['Smoky', d.flavorSmoky] ]
        .filter(([,v]) => v !== '' && !isNaN(parseFloat(v)))
        .sort((a,b) => parseFloat(b[1]) - parseFloat(a[1]))
        .slice(0,2)
        .map(([k]) => k)
        .join(' & ');
    }

    function compute(d){
      const pricePerCup = mapPrice(d.priceRange);
      const more = String(d.cupsPerDay || '').toLowerCase().includes('more');
      const billedServings = more ? 28 : 14;
      const bonus = 1;
      const totalServings = Math.min(31, billedServings + bonus);
      const rawSubtotal = pricePerCup * billedServings;
      const shipping = 4.95;
      const rawTax = rawSubtotal * 0.08;
      const subtotal = roundTo95(rawSubtotal);
      const tax = roundTo95(rawTax);
      const total = roundTo95(subtotal + tax + shipping);
      return { pricePerCup, billedServings, bonus, totalServings, subtotal, shipping, tax, total, period: 'every 2 weeks' };
    }

    function pluralize(word, n){ return n === 1 ? word : word + 's'; }

    function template(d, p){
      const flavors = topFlavors(d);
      const tasting = flavors ? `${flavors} notes` : 'Balanced, approachable cup';
      const brew = d.brewMethod ? `Ground for ${String(d.brewMethod).toLowerCase()}` : 'Ground for your method';
      const style = d.additions ? `Enjoyed with ${String(d.additions).toLowerCase()}` : 'Enjoyed black or with milk';

      const rawName = d.blendName || 'Your Daily Roast';
      const planName = /subscription/i.test(rawName) ? rawName : `${rawName} subscription`;

      let badgeText = 'Your Blend';
      if (d.firstName && String(d.firstName).trim()){
        const n = String(d.firstName).trim();
        badgeText = /s$/i.test(n) ? `${n}' Blend` : `${n}'s Blend`;
      } else if (d.email){
        const handle = String(d.email).split('@')[0];
        if (handle){ badgeText = /s$/i.test(handle) ? `${handle}' Blend` : `${handle}'s Blend`; }
      }

      return `
        <div>
          <div class="visual">
            <div class="pouch-stack">
              <div class="pouch-extreme pouch-container" aria-hidden="true">
                <div class="pouch">
                  <div class="top-seal"></div>
                  <div class="pouch-label">
                    <div class="label-badge">${esc(badgeText)}</div>
                    <div class="label-tagline">${esc(d.blendName || 'Your Daily Roast')}</div>
                    <div class="label-description">${esc(tasting)}</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="qty-badge">${p.totalServings} ${esc(pluralize('cup', p.totalServings))}</div>
          </div>

          <div class="section-title">${esc(d.blendName || 'Your Daily Roast')} â€” ${esc(d.roastLevel || 'Medium')}</div>
          <div class="desc">${esc(tasting)}. ${esc(brew)}. ${esc(style)}.</div>

          <div class="badges">
            ${d.personality ? `<span class='pill'>${esc(d.personality)}</span>` : ''}
            ${d.tasteBalance ? `<span class='pill'>${esc(d.tasteBalance)}</span>` : ''}
            ${d.cupsPerDay ? `<span class='pill'>${esc(d.cupsPerDay)}</span>` : ''}
          </div>

          ${d.additionalNotes ? `<div class='divider'></div><div class='desc'><strong>Notes:</strong> ${esc(d.additionalNotes)}</div>` : ''}
        </div>

        <div>
          <div class="line"><span class="muted">Plan</span><span>${esc(planName)} â€¢ ${esc(p.period)}</span></div>
          <div class="line"><span class="muted">Price per cup</span><span class="price">${$$(p.pricePerCup)}</span></div>
          <div class="line"><span class="muted">Servings (billed)</span><span>${p.billedServings} Ã— ${$$(p.pricePerCup)}</span></div>
          <div class="line"><span class="muted">Bonus cup (qty 1)</span><span>${$$(0)}</span></div>
          <div class="divider"></div>
          <div class="line"><span class="muted">Subtotal</span><span>${$$(p.subtotal)}</span></div>
          <div class="line"><span class="muted">Shipping</span><span>${$$(p.shipping)}</span></div>
          <div class="line"><span class="muted">Estimated tax</span><span>${$$(p.tax)}</span></div>
          <div class="divider"></div>
          <div class="line total"><span>Total today</span><span>${$$(p.total)}</span></div>

          <div class="actions">
            <button class="btn" type="button" id="backBtn" aria-label="Go back">Back</button>
            <button class="btn primary" type="button" id="buyBtn" aria-label="Buy now">Buy now</button>
          </div>
        </div>`;
    }

    function render(){
      const d = loadData();
      const p = compute(d);
      const el = document.getElementById('checkout');
      if (!el) return;
      el.setAttribute('aria-busy','true');
      el.innerHTML = template(d, p);
      el.removeAttribute('aria-busy');
      bindHandlers(d, p);
    }

    // ---- Networking ----
    function buildPayload(){
      let d = loadData();
      const pricePerCup = mapPrice(d.priceRange);
      const more = String(d.cupsPerDay || '').toLowerCase().includes('more');
      const billedServings = more ? 28 : 14; 
      const bonus = 1; 
      const totalServings = billedServings + bonus;

      const topFlavors = [ ['Nutty',d.flavorNutty], ['Fruity',d.flavorFruity], ['Floral',d.flavorFloral], ['Smoky',d.flavorSmoky] ]
        .filter(([,v]) => v !== '' && !isNaN(Number(v)))
        .sort((a,b) => Number(b[1]) - Number(a[1]))
        .slice(0,3)
        .map(([k,v]) => `${k}:${v}`)
        .join(', ');

      const RP_USER_ID = safeGetLS('rp_user_id') || '';

      return {
        timestamp: new Date().toISOString(),
        tab: 'FormResponses',
        userId: RP_USER_ID,
        firstName: d.firstName||'', 
        lastName: d.lastName||'', 
        email: d.email||'',
        roastLevel: d.roastLevel||'', 
        brewMethod: d.brewMethod||'', 
        equipmentDetails: d.equipmentDetails||'', 
        additions: d.additions||'',
        priceRange: d.priceRange||'', 
        pricePerCup, 
        cupsPerDay: d.cupsPerDay||'', 
        personality: d.personality||'', 
        tasteBalance: d.tasteBalance||'',
        flavorNutty: d.flavorNutty||'', 
        flavorFruity: d.flavorFruity||'', 
        flavorFloral: d.flavorFloral||'', 
        flavorSmoky: d.flavorSmoky||'', 
        topFlavors,
        blendName: d.blendName||'', 
        billedServings, 
        bonus, 
        totalServings, 
        source: 'checkout'
      };
    }

    function postToSheets(payload, { useBeacon = false } = {}){
      const url = 'https://script.google.com/macros/s/AKfycbxd6pPajYDJEtCIZpUe9zmJrTCypz6_vzWAHABsx0vg-bpAjF0SdfuCkhvhZJ6pTnpz7g/exec';
      const form = new URLSearchParams();
      Object.entries(payload).forEach(([k,v]) => form.append(k, String(v ?? '')));
      const body = form.toString();

      // Try sendBeacon on navigation for reliability
      if (useBeacon && 'sendBeacon' in navigator){
        const blob = new Blob([body], { type:'application/x-www-form-urlencoded;charset=UTF-8' });
        const ok = navigator.sendBeacon(url, blob);
        if (ok) return Promise.resolve(true);
      }

      // Fallback to fetch
      return fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body
      });
    }

    // ---- Analytics + Navigation ----
    function gtagNavigate(url, data){
      let navigated = false;
      const nav = () => {
        if (!navigated && typeof url === 'string'){
          navigated = true;
          window.location.assign(url);
        }
      };

      if (typeof gtag === 'function'){
        // GA4 recommended purchase event
        try{
          gtag('event', 'purchase', {
            transaction_id: String(Date.now()),
            value: data.value,
            currency: 'USD',
            items: data.items || []
          });
        }catch{}

        // Custom event w/ callback; short timeout + manual backup
        try{
          gtag('event', 'submission_ok', Object.assign({
            event_callback: nav,
            event_timeout: 800
          }, data || {}));
        }catch{}
        setTimeout(nav, 400); // ensure we leave quickly even if blocked
      } else {
        nav();
      }
    }

    function onBuy(){
      const btn = document.getElementById('buyBtn');
      if (btn){ btn.setAttribute('aria-busy', 'true'); btn.disabled = true; }

      const payload = buildPayload();
      const d = loadData();
      const p = compute(d);

      // Timestamp last order immediately
      safeSetLS('rp_last_order_ts', Date.now());

      // Fire-and-forget to Sheets with beacon where possible
      postToSheets(payload, { useBeacon: true }).catch(err => console.error('Background submission failed:', err));

      // Navigate immediately (with GA callback attempts)
      gtagNavigate('thanks.html', {
        value: p.total,
        currency: 'USD',
        transaction_id: Date.now().toString(),
        items: [{
          item_id: 'subscription',
          item_name: d.blendName || 'Your Daily Roast',
          item_category: 'coffee_subscription',
          price: p.pricePerCup,
          quantity: p.billedServings
        }]
      });
    }

    function bindHandlers(d, p){
      const buy = document.getElementById('buyBtn');
      const back = document.getElementById('backBtn');
      if (buy){ buy.addEventListener('click', onBuy, { passive:true }); }
      if (back){ back.addEventListener('click', () => history.length ? history.back() : window.location.assign('index.html')); }

      // Review mode
      const params = new URLSearchParams(window.location.search);
      if (params.get('review') === '1' && buy){ buy.remove(); }
    }

    // ---- Viewport height fix for legacy iOS Chrome/Safari ----
    (function viewportFix(){
      const set = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight / 100}px`);
      const useLegacy = !CSS.supports('height', '100dvh');
      if (useLegacy){
        window.addEventListener('resize', set, { passive:true });
        window.addEventListener('orientationchange', set, { passive:true });
        window.addEventListener('load', set, { once:true });
        set();
        // Use the custom var in CSS only if needed
        const style = document.createElement('style');
        style.textContent = `.container{min-height: calc(var(--vh, 1vh) * 100);}`;
        document.head.appendChild(style);
      }
    })();

    // Initial render
    render();
  })();
  </script>
</body>
</html>
