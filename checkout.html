<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Performance hints -->
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#FBFBFD">
  <title>Roast Portal â€” Checkout</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5LTTX2TGVQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-5LTTX2TGVQ');
  </script>

  <style>
    :root{
      --bg-primary:#FBFBFD; 
      --surface:#ffffff;
      --text-primary:#1D1D1F; 
      --text-secondary:#6E6E73;
      --border:rgba(0,0,0,0.08); 
      --blue:#0071E3;
      --shadow: 0 10px 30px rgba(0,0,0,.06);
      --surface-radius:20px;
      --focus: 0 0 0 3px rgba(0,113,227,.35);
      --pouch-width: 300px;
      --pouch-height: calc(var(--pouch-width) * 1.335);
      --pouch-thickness: 38px; /* ~1cm at 96dpi */
      --ease-apple: cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Base resets */
    *,*::before,*::after{ box-sizing:border-box; }
    html{ 
      -webkit-text-size-adjust:100%;
      margin: 0;
      overscroll-behavior: none; /* Prevent pull-to-refresh and scroll chaining */
    }

    /* Viewport-height that works everywhere */
    :root{
      --vh: 1vh; /* JS will update on legacy browsers */
    }

    html, body{
      height:100%;
    }

    body{
      margin:0; 
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
      background:var(--bg-primary);
      color:var(--text-primary);
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-overflow-scrolling:touch;
      overflow-x:hidden;
      overscroll-behavior: none; /* Prevent overscroll effects completely */
    }

    /* Container uses dvh with graceful fallbacks */
    .container{
      max-width:1080px;
      margin-inline:auto;
      padding:clamp(12px, 2.2vw, 24px);
      min-height:100vh;
      /* Chrome on iOS scroll fixes */
      overscroll-behavior: contain;
      overflow-x: hidden;
    }
    @supports (height: 100dvh){
      .container{ min-height:100dvh; }
    }

    .surface{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--surface-radius);
      box-shadow:var(--shadow);
      padding:clamp(16px, 2.2vw, 24px);
      /* Chrome on iOS scroll fixes */
      overscroll-behavior: contain;
      overflow-x: hidden;
    }

    h1{
      font-size:clamp(22px, 2.2vw, 28px);
      margin:0 0 6px;
      font-weight:800;
      letter-spacing:-0.01em;
    }

    p.sub{
      color:var(--text-secondary);
      margin:0 0 20px;
      font-size:clamp(14px, 1.6vw, 16px);
    }

    .grid{
      display:grid;
      grid-template-columns:1.5fr 1fr;
      gap:clamp(16px, 3.2vw, 32px);
      align-items:start;
    }

    .section-title{
      font-weight:800;
      margin:0 0 8px;
      font-size:clamp(16px, 1.9vw, 18px);
      letter-spacing:-0.01em;
    }

    .desc{
      color:var(--text-secondary);
      line-height:1.5;
      margin:0 0 16px;
      font-size:clamp(13px, 1.5vw, 14px);
    }

    .badges{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:transparent; color:var(--text-secondary);
    }

    .divider{ height:1px; background:var(--border); margin:16px 0; }

    .line{ display:flex; justify-content:space-between; gap:12px; margin:8px 0; font-size:14px; }
    .muted{ color:var(--text-secondary); }
    .price{ font-weight:700; }
    .total{ font-weight:900; font-size:16px; }

    .actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:20px; flex-wrap:wrap; }

    .btn{
      appearance:none; -webkit-appearance:none;
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text-primary);
      padding:12px 20px; border-radius:999px; cursor:pointer;
      font-size:14px; font-weight:600; box-shadow:0 1px 6px rgba(0,0,0,.06);
      transition:transform .2s ease, box-shadow .2s ease; position:relative;
    }
    @media (hover:hover){
      .btn:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.10); }
    }
    .btn:focus-visible{ outline:none; box-shadow:var(--focus); }
    .btn[disabled], .btn[aria-busy="true"]{ opacity:.6; cursor:not-allowed; }

    .btn.primary{ background:var(--blue); color:#fff; border-color:transparent; box-shadow:0 8px 20px rgba(0,113,227,.28); }
    @media (hover:hover){
      .btn.primary:hover{ box-shadow:0 10px 25px rgba(0,113,227,.35); }
    }

    /* Pouch visualization */
    .visual{ text-align:center; margin-bottom:24px; position:relative; }
    .pouch-stack{ display:inline-block; position:relative; margin-bottom:16px; }
    
    /* Pouches Grid Layout */
    .pouches-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 32px;
      align-items: start;
      margin-bottom: 24px;
    }
    
    .pouch-column {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .stack-area {
      position: relative;
      display: grid;
      place-items: center;
      margin-bottom: 16px;
    }
    
    .stack-area .pouch-stack {
      grid-area: 1 / 1;
    }
    
    .pouch-info {
      text-align: center;
      max-width: 320px;
    }
    
    .pouch-info p {
      font-size: 16px;
      color: var(--text-secondary);
      line-height: 1.5;
      font-weight: 400;
      letter-spacing: -0.01em;
    }
    
    /* Stack Card Styling */
    .stack-card {
      position: absolute;
      width: 120px;
      height: 160px;
      left: 50%;
      top: 55%;
      transform: translate(-50%, -50%);
      transition: transform 0.6s var(--ease-apple, cubic-bezier(0.4, 0, 0.2, 1)), filter 0.4s var(--ease-apple, cubic-bezier(0.4, 0, 0.2, 1)), opacity 0.4s var(--ease-apple, cubic-bezier(0.4, 0, 0.2, 1));
      cursor: default;
    }
    
    .stack-card.mini {
      opacity: 1;
      filter: brightness(0.96) saturate(0.92);
    }
    
    .stack-card.active {
      transform: translateX(-50%) translateY(calc(-50% - 8px)) translateZ(30px) rotateZ(0deg) !important;
      z-index: 6 !important;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .pouches-grid {
        grid-template-columns: 1fr;
        gap: 40px;
      }
      
      .pouch-info p {
        font-size: 15px;
      }
    }
    
    /* === Contrast outline that matches the pouch shape exactly === */
    :root{
      --outline-inner: rgba(255,255,255,0.5);
      --outline-outer: rgba(0,0,0,0.2);
      --outline-inner-w: 0.5px;
      --outline-outer-w: 1px;
    }
    .pouch-outline{ position: absolute; inset: 0; pointer-events: none; z-index: 8; transform-style: preserve-3d; }
    .pouch-outline.front{ transform: translateZ(calc(var(--pouch-thickness) / 2)); }
    .pouch-outline.back{ transform: rotateY(180deg) translateZ(calc(var(--pouch-thickness) / 2)); }
    .pouch-outline path{ fill: none; vector-effect: non-scaling-stroke; stroke-linejoin: miter; shape-rendering: geometricPrecision; }
    .pouch-outline .outer{ stroke: var(--outline-outer); stroke-width: var(--outline-outer-w); }
    .pouch-outline .inner{ stroke: var(--outline-inner); stroke-width: var(--outline-inner-w); }

    .pouch-extreme{ 
      --pouch-w: 120px; 
      --pouch-h: 160px;
      --pouch-min: min(var(--pouch-w), var(--pouch-h)); 
      --pouch-thickness: 38px; /* ~1cm at 96dpi */
      --bag-bg:#0a0a0a; 
      --bag-radius-frac:0.0375; 
      --pouch-border-frac:0.003; 
      --pouch-border-color: rgba(0,0,0,0.1); 
      --label-bg:#FDFEFE; 
      --label-radius-frac:0.055; 
      --label-top-frac:0.88; 
      --label-pad-frac:0.04; 
      --label-gradient: linear-gradient(135deg, rgba(245, 248, 252, 0.65) 0%, rgba(252, 254, 255, 0.45) 50%, rgba(248, 250, 252, 0.4) 100%); 
      --label-gradient-opacity:0.85; 
      --ink1: hsla(210, 42%, 88%, 0.25);
      --ink2: hsla(200, 40%, 90%, 0.22);
      --ink3: hsla(180, 38%, 92%, 0.20);
      --notch-amp: 1;
      --text-size-frac-default: .05;
    }
    
    /* Unique colors for each pouch stack */
    #stack1 .pouch-label { --ink1: hsla(34, 78%, 76%, 0.35); --ink2: hsla(20, 65%, 78%, 0.32); --ink3: hsla(46, 70%, 82%, 0.30); }
    #stack2 .pouch-label { --ink1: hsla(205, 70%, 78%, 0.35); --ink2: hsla(192, 60%, 80%, 0.32); --ink3: hsla(220, 62%, 84%, 0.30); }
    #stack3 .pouch-label { --ink1: hsla(132, 60%, 78%, 0.35); --ink2: hsla(150, 55%, 80%, 0.32); --ink3: hsla(170, 52%, 84%, 0.30); }

    .pouch-extreme.pouch-container{ position:relative; inline-size:var(--pouch-w); block-size:var(--pouch-h); container-type:inline-size }

    .pouch-extreme .pouch{ position:absolute; inset:0; background:var(--bag-bg); border-radius: calc(var(--bag-radius-frac) * var(--pouch-min)) calc(var(--bag-radius-frac) * var(--pouch-min)) calc(var(--bag-radius-frac) * .8 * var(--pouch-min)) calc(var(--bag-radius-frac) * .8 * var(--pouch-min)); overflow:hidden; isolation:isolate; box-shadow: 0 12px 28px rgba(0,0,0,.18), 0 2px 6px rgba(0,0,0,.10); }

    .pouch-extreme .pouch::after{ content:""; position:absolute; inset:0; z-index:3; pointer-events:none; border-radius: inherit; clip-path: inherit; box-shadow: inset 0 0 0 calc(var(--pouch-border-frac) * var(--pouch-min)) var(--pouch-border-color); }

    .pouch-extreme .pouch{
      --rT: calc(var(--bag-radius-frac) * 100cqw);
      --rB: calc(var(--bag-radius-frac) * 80cqw);
      --t1: var(--rT); --t2: calc(var(--rT)*.6); --t3: calc(var(--rT)*.4); --t4: calc(var(--rT)*.2);
      --b1: var(--rB); --b2: calc(var(--rB)*.6); --b3: calc(var(--rB)*.4); --b4: calc(var(--rB)*.2);
      --nx: 1; --nox: calc(4cqw * var(--nx));
      clip-path: polygon(0 var(--t1), var(--t4) var(--t2), var(--t3) var(--t3), var(--t2) var(--t4), var(--t1) 0,
                         calc(100% - var(--t1)) 0, calc(100% - var(--t2)) var(--t4), calc(100% - var(--t3)) var(--t3), calc(100% - var(--t4)) var(--t2), 100% var(--t1),
                         100% calc(var(--t1) + 4cqw), calc(100% - var(--nox)) calc(var(--t1) + 6cqw), 100% calc(var(--t1) + 8cqw),
                         100% calc(100% - var(--b1)), calc(100% - var(--b4)) calc(100% - var(--b2)), calc(100% - var(--b3)) calc(100% - var(--b3)), calc(100% - var(--b2)) calc(100% - var(--b4)), calc(100% - var(--b1)) 100%,
                         var(--b1) 100%, var(--b2) calc(100% - var(--b4)), var(--b3) calc(100% - var(--b3)), var(--b4) calc(100% - var(--b2)), 0 calc(100% - var(--b1)),
                         0 calc(var(--t1) + 8cqw), var(--nox) calc(var(--t1) + 6cqw), 0 calc(var(--t1) + 4cqw),
                         0 var(--t1)); 
    }

    .pouch-extreme .top-seal{ position:absolute; inset-inline:0; inset-block-start:0; height:10cqw; background-color:var(--bag-bg); border-bottom:1px solid rgba(220,225,230,0.32);
      background-image: repeating-linear-gradient(180deg, rgba(255,255,255,0.06) 0 1px, rgba(0,0,0,0.08) 1px 2px, transparent 2px 3px), linear-gradient(0deg, rgba(0,0,0,0.28) 0, transparent 50%), radial-gradient(100% 50% at 50% 0%, rgba(255,255,255,0.06) 0, transparent 70%); box-shadow: inset 0 -1px 0 rgba(0,0,0,0.38), inset 0 1px 0 rgba(220,225,230,0.22); clip-path: inherit; }

    .pouch-extreme .pouch-label{ --pad: calc(var(--label-pad-frac) * var(--pouch-min)); position:absolute; left:var(--pad); right:var(--pad); bottom:var(--pad); top: calc(100% - (var(--label-top-frac) * 100%)); background:var(--label-bg); border-radius: calc(var(--label-radius-frac) * var(--pouch-min)); padding:28px 24px; overflow:hidden; display:flex; flex-direction:column; justify-content:space-between; box-shadow: inset 0 1px 0 rgba(255,255,255,0.5), inset 0 -1px 0 rgba(0,0,0,0.05), 0 4px 12px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.04); }

    .pouch-extreme .pouch-label::before{ content:""; position:absolute; inset:0; border-radius:inherit; background:linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 60%), var(--label-gradient), radial-gradient(120% 80% at 18% 20%, hsla(210, 42%, 88%, 0.25) 0 40%, transparent 70%), radial-gradient(130% 78% at 80% 24%, hsla(200, 40%, 90%, 0.22) 0 38%, transparent 72%), radial-gradient(110% 88% at 64% 84%, hsla(180, 38%, 92%, 0.20) 0 42%, transparent 74%); opacity: calc(var(--label-gradient-opacity) * 0.7); }
    .pouch-extreme .pouch-label::after{ content:""; position:absolute; inset:0; border-radius:inherit; opacity: 0.03; pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='9' numOctaves='4' stitchTiles='stitch'/%3E%3C/svg%3E"); }
    .pouch-extreme .shape-layer, .pouch-extreme .text-layer{ position:absolute; inset:0 }
    .pouch-extreme .shape-layer{ width:100%; height:100%; opacity: 0.15; z-index: 1; display: none; }
    .pouch-extreme .text-layer{ z-index: 2; }
    .pouch-extreme .text-block{ position:absolute; font-size: calc(var(--text-size-frac, .05) * var(--pouch-min)); }
    
    /* Text block positioning and styling */
    .pouch-extreme .text-block.label-badge {
      background: rgba(0,0,0,0.75);
      color: #fff;
      font-weight: 700;
      text-transform: uppercase;
      line-height: 1;
      letter-spacing: 0.08em;
      padding: 8px 16px;
      border-radius: 20px;
      white-space: nowrap;
      backdrop-filter: blur(8px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1);
    }
    
    .pouch-extreme .text-block.label-tagline {
      color: #1d1d1f;
      font-weight: 700;
      line-height: 1.1;
      text-align: center;
      width: 85%;
      white-space: normal;
      max-width: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .pouch-extreme .text-block.label-description {
      color: #2b2b30;
      font-weight: 400;
      line-height: 1.4;
      text-align: center;
      width: 80%;
      white-space: normal;
      max-width: none;
      letter-spacing: -0.01em;
    }

    .pouch-extreme .label-badge { 
      backdrop-filter: blur(8px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1);
    }
    .pouch-extreme .label-tagline { text-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .pouch-extreme .label-description { letter-spacing: -0.01em; }
    
    .label-badge{ padding:6px 10px; border-radius:14px; color:#fff; background:var(--blue); font-size:11px; font-weight:800; box-shadow:0 0 0 1px rgba(0,113,227,.28); margin-bottom:8px; display:inline-block; position:relative; z-index:1; }
    .label-tagline{ font-size:14px; font-weight:800; color:#1d1d1f; margin-bottom:6px; position:relative; z-index:1; text-shadow: 0 1px 2px rgba(0,0,0,0.05); line-height:1.2; }
    .label-description{ font-size:12px; color:#2b2b30; margin-top:6px; line-height:1.3; position:relative; z-index:1; letter-spacing: -0.01em; }



    .qty-badge{ position:absolute; top:8px; inset-inline-end:8px; background:#111; color:#fff; border-radius:999px; font-size:12px; padding:6px 10px; font-weight:700; }

    /* Responsive tweaks */
    @media(max-width: 860px){
      .grid{ grid-template-columns:1fr; gap:24px; }
      .surface{ border-radius:16px; }
    }
    
    /* Mobile responsive adjustments for pouch labels */
    @media (max-width: 768px) {
      .pouch-extreme .label-badge { --text-size-frac: 0.024 !important; }
      .pouch-extreme .label-tagline { --text-size-frac: 0.065 !important; }
      .pouch-extreme .label-description { --text-size-frac: 0.045 !important; }
    }

    @media(max-width: 480px){
      .actions{ flex-direction:column; }
      .btn{ width:100%; padding:14px 20px; font-size:15px; }
      .surface{ border-radius:12px; }
    }


  </style>
</head>
<body>
  <div class="container">
    <main class="surface" role="main" aria-labelledby="page-title">
      <h1 id="page-title">Checkout</h1>
      <p class="sub">Review your custom blend and complete your order.</p>
      <section id="checkout" class="grid" aria-live="polite" aria-atomic="true"></section>
    </main>
  </div>

  <noscript>
    <style> .grid{display:block} .actions{display:none} </style>
    <div style="max-width:1080px;margin:12px auto;color:#b00;padding-inline:16px;">
      JavaScript is disabled. Enable it to review your blend and complete checkout.
    </div>
  </noscript>

  <script>
  (function(){
    'use strict';

    // ---- Utilities ----
    const currencyFmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
    const $$ = (n) => currencyFmt.format(Number(n || 0));

    const esc = (s) => String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');

    function safeGetLS(key){
      try{ return window.localStorage.getItem(key); }catch{ return null; }
    }
    function safeSetLS(key, val){
      try{ window.localStorage.setItem(key, String(val)); }catch{}
    }

    function parseNumberLike(x, fallback = 0){
      if (typeof x === 'number' && isFinite(x)) return x;
      if (typeof x === 'string'){
        const m = x.match(/[\d.]+/);
        if (m) return parseFloat(m[0]);
      }
      return fallback;
    }

    function mapPrice(per){
      const val = parseNumberLike(per, 20);
      const pct = (val - 8) / (36 - 8);
      const price = Math.max(2, Math.min(9, +(2 + 7 * pct).toFixed(2)));
      return price;
    }

    function roundTo95(amount){
      const ceil = Math.ceil(Number(amount || 0));
      return Math.max(0, ceil - 0.05); // e.g. 12.01 -> 12.95, 12 -> 11.95 (intentional pricing rule)
    }

    function loadData(){
      try{ return JSON.parse(safeGetLS('rp_quiz') || '{}'); }catch{ return {}; }
    }

    function topFlavors(d){
      return [ ['Nutty', d.flavorNutty], ['Fruity', d.flavorFruity], ['Floral', d.flavorFloral], ['Smoky', d.flavorSmoky] ]
        .filter(([,v]) => v !== '' && !isNaN(parseFloat(v)))
        .sort((a,b) => parseFloat(b[1]) - parseFloat(a[1]))
        .slice(0,2)
        .map(([k]) => k)
        .join(' & ');
    }

    function compute(d){
      const pricePerCup = mapPrice(d.priceRange);
      const more = String(d.cupsPerDay || '').toLowerCase().includes('more');
      const billedServings = more ? 28 : 14;
      const bonus = 1;
      const totalServings = Math.min(31, billedServings + bonus);
      const rawSubtotal = pricePerCup * billedServings;
      const shipping = 4.95;
      const rawTax = rawSubtotal * 0.08;
      const subtotal = roundTo95(rawSubtotal);
      const tax = roundTo95(rawTax);
      const total = roundTo95(subtotal + tax + shipping);
      return { pricePerCup, billedServings, bonus, totalServings, subtotal, shipping, tax, total, period: 'every 2 weeks' };
    }

    function pluralize(word, n){ return n === 1 ? word : word + 's'; }

    function template(d, p){
      const flavors = topFlavors(d);
      const tasting = flavors ? `${flavors} notes` : 'Balanced, approachable cup';
      const brew = d.brewMethod ? `Ground for ${String(d.brewMethod).toLowerCase()}` : 'Ground for your method';
      const style = d.additions ? `Enjoyed with ${String(d.additions).toLowerCase()}` : 'Enjoyed black or with milk';

      const rawName = d.blendName || 'Your Daily Roast';
      const planName = /subscription/i.test(rawName) ? rawName : `${rawName} subscription`;

      let badgeText = 'Your Blend';
      if (d.firstName && String(d.firstName).trim()){
        const n = String(d.firstName).trim();
        badgeText = /s$/i.test(n) ? `${n}' Blend` : `${n}'s Blend`;
      } else if (d.email){
        const handle = String(d.email).split('@')[0];
        if (handle){ badgeText = /s$/i.test(handle) ? `${handle}' Blend` : `${handle}'s Blend`; }
      }

      return `
        <div>
          <div class="visual">
            <div class="pouch-stack">
              <div class="pouch-extreme pouch-container" aria-hidden="true">
                <div class="pouch">
                  <div class="top-seal"></div>
                  <div class="pouch-label">
                    <svg class="shape-layer" viewBox="0 0 1000 1000" preserveAspectRatio="none" aria-label="Shape layer"><rect x="397.807373046875" y="263.5442199707031" width="200" height="200" rx="3.200347071234561" ry="12" data-corner="12" fill="#ffffff80" data-shape="square" data-rot="0" data-scalex="3.7495933200054137" data-scaley="1" style="cursor: pointer; transform-box: fill-box; transform-origin: center center; transform: rotate(0deg) scale(3.74959, 1);"></rect><circle cx="977.3275756835938" cy="24.153820037841797" r="110" fill="rgba(16, 234, 81, 1)" data-shape="circle" data-rot="0" data-scalex="1.278094641436079" data-scaley="1" style="cursor: pointer; transform-box: fill-box; transform-origin: center center; transform: rotate(0deg) scale(1.27809, 1);"></circle><polygon points="504.1848449707031,645.3689880371094 614.1848449707031,875.3689880371094 394.1848449707031,875.3689880371094" fill="rgba(0, 0, 0, 1)" data-shape="triangle" data-rot="0" data-scalex="5" data-scaley="2.165829465350702" style="cursor: pointer; transform-box: fill-box; transform-origin: center center; transform: rotate(0deg) scale(5, 2.16583);"></polygon></svg>
                  </div>
                  
                  <div class="text-layer">
                    <div class="text-block label-badge" data-size-frac="0.020" style="--text-size-frac: 0.020; top: 12%; left: 50%; transform: translate(-50%, -50%); color: rgb(255, 255, 255); font-weight: 700; text-transform: uppercase; line-height: 1; letter-spacing: 0.08em; background: rgba(0,0,0,0.75); padding: 8px 16px; border-radius: 20px; white-space: nowrap;">${esc(badgeText)}</div>
                    <div class="text-block label-tagline" data-size-frac="0.072" style="--text-size-frac: 0.072; top: 38%; left: 50%; transform: translate(-50%, -50%); color: rgb(28, 28, 32); font-weight: 700; line-height: 1.1; text-align: center; width: 85%; white-space: normal; max-width: none;">${esc(d.blendName || 'Your Daily Roast')}</div>
                    <div class="text-block label-description" data-size-frac="0.042" style="--text-size-frac: 0.042; top: 73%; left: 50%; transform: translate(-50%, -50%); color: rgb(72, 72, 74); font-weight: 700; line-height: 1.4; text-align: center; width: 80%; white-space: normal; max-width: none;">${esc(tasting)}</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="qty-badge">${p.totalServings} ${esc(pluralize('cup', p.totalServings))}</div>
          </div>

          <div class="section-title">${esc(d.blendName || 'Your Daily Roast')} â€” ${esc(d.roastLevel || 'Medium')}</div>
          <div class="desc">${esc(tasting)}. ${esc(brew)}. ${esc(style)}.</div>

          <div class="badges">
            ${d.personality ? `<span class='pill'>${esc(d.personality)}</span>` : ''}
            ${d.tasteBalance ? `<span class='pill'>${esc(d.tasteBalance)}</span>` : ''}
            ${d.cupsPerDay ? `<span class='pill'>${esc(d.cupsPerDay)}</span>` : ''}
          </div>

          ${d.additionalNotes ? `<div class='divider'></div><div class='desc'><strong>Notes:</strong> ${esc(d.additionalNotes)}</div>` : ''}
        </div>

        <div>
          <div class="line"><span class="muted">Plan</span><span>${esc(planName)} â€¢ ${esc(p.period)}</span></div>
          <div class="line"><span class="muted">Price per cup</span><span class="price">${$$(p.pricePerCup)}</span></div>
          <div class="line"><span class="muted">Servings (billed)</span><span>${p.billedServings} Ã— ${$$(p.pricePerCup)}</span></div>
          <div class="line"><span class="muted">Bonus cup (qty 1)</span><span>${$$(0)}</span></div>
          <div class="divider"></div>
          <div class="line"><span class="muted">Subtotal</span><span>${$$(p.subtotal)}</span></div>
          <div class="line"><span class="muted">Shipping</span><span>${$$(p.shipping)}</span></div>
          <div class="line"><span class="muted">Estimated tax</span><span>${$$(p.tax)}</span></div>
          <div class="divider"></div>
          <div class="line total"><span>Total today</span><span>${$$(p.total)}</span></div>

          <div class="actions">
            <button class="btn" type="button" id="backBtn" aria-label="Go back">Back</button>
            <button class="btn primary" type="button" id="buyBtn" aria-label="Buy now">Buy now</button>
          </div>
        </div>`;
    }

    function render(){
      const d = loadData();
      const p = compute(d);
      const el = document.getElementById('checkout');
      if (!el) return;
      el.setAttribute('aria-busy','true');
      el.innerHTML = template(d, p);
      el.removeAttribute('aria-busy');
      bindHandlers(d, p);
    }

    // ---- Networking ----
    function buildPayload(){
      let d = loadData();
      const pricePerCup = mapPrice(d.priceRange);
      const more = String(d.cupsPerDay || '').toLowerCase().includes('more');
      const billedServings = more ? 28 : 14; 
      const bonus = 1; 
      const totalServings = billedServings + bonus;

      const topFlavors = [ ['Nutty',d.flavorNutty], ['Fruity',d.flavorFruity], ['Floral',d.flavorFloral], ['Smoky',d.flavorSmoky] ]
        .filter(([,v]) => v !== '' && !isNaN(Number(v)))
        .sort((a,b) => Number(b[1]) - Number(a[1]))
        .slice(0,3)
        .map(([k,v]) => `${k}:${v}`)
        .join(', ');

      const RP_USER_ID = safeGetLS('rp_user_id') || '';

      return {
        timestamp: new Date().toISOString(),
        tab: 'FormResponses',
        userId: RP_USER_ID,
        firstName: d.firstName||'', 
        lastName: d.lastName||'', 
        email: d.email||'',
        roastLevel: d.roastLevel||'', 
        brewMethod: d.brewMethod||'', 
        equipmentDetails: d.equipmentDetails||'', 
        additions: d.additions||'',
        priceRange: d.priceRange||'', 
        pricePerCup, 
        cupsPerDay: d.cupsPerDay||'', 
        personality: d.personality||'', 
        tasteBalance: d.tasteBalance||'',
        flavorNutty: d.flavorNutty||'', 
        flavorFruity: d.flavorFruity||'', 
        flavorFloral: d.flavorFloral||'', 
        flavorSmoky: d.flavorSmoky||'', 
        topFlavors,
        blendName: d.blendName||'', 
        billedServings, 
        bonus, 
        totalServings, 
        source: 'checkout'
      };
    }

    function postToSheets(payload, { useBeacon = false } = {}){
      const url = 'https://script.google.com/macros/s/AKfycbxd6pPajYDJEtCIZpUe9zmJrTCypz6_vzWAHABsx0vg-bpAjF0SdfuCkhvhZJ6pTnpz7g/exec';
      const form = new URLSearchParams();
      Object.entries(payload).forEach(([k,v]) => form.append(k, String(v ?? '')));
      const body = form.toString();

      // Try sendBeacon on navigation for reliability
      if (useBeacon && 'sendBeacon' in navigator){
        const blob = new Blob([body], { type:'application/x-www-form-urlencoded;charset=UTF-8' });
        const ok = navigator.sendBeacon(url, blob);
        if (ok) return Promise.resolve(true);
      }

      // Fallback to fetch
      return fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body
      });
    }

    // ---- Analytics + Navigation ----
    function gtagNavigate(url, data){
      let navigated = false;
      const nav = () => {
        if (!navigated && typeof url === 'string'){
          navigated = true;
          window.location.assign(url);
        }
      };

      if (typeof gtag === 'function'){
        // GA4 recommended purchase event
        try{
          gtag('event', 'purchase', {
            transaction_id: String(Date.now()),
            value: data.value,
            currency: 'USD',
            items: data.items || []
          });
        }catch{}

        // Custom event w/ callback; short timeout + manual backup
        try{
          gtag('event', 'submission_ok', Object.assign({
            event_callback: nav,
            event_timeout: 800
          }, data || {}));
        }catch{}
        setTimeout(nav, 400); // ensure we leave quickly even if blocked
      } else {
        nav();
      }
    }

    function onBuy(){
      const btn = document.getElementById('buyBtn');
      if (btn){ btn.setAttribute('aria-busy', 'true'); btn.disabled = true; }

      const payload = buildPayload();
      const d = loadData();
      const p = compute(d);

      // Timestamp last order immediately
      safeSetLS('rp_last_order_ts', Date.now());

      // Fire-and-forget to Sheets with beacon where possible
      postToSheets(payload, { useBeacon: true }).catch(err => console.error('Background submission failed:', err));

      // Navigate immediately (with GA callback attempts)
      gtagNavigate('thanks.html', {
        value: p.total,
        currency: 'USD',
        transaction_id: Date.now().toString(),
        items: [{
          item_id: 'subscription',
          item_name: d.blendName || 'Your Daily Roast',
          item_category: 'coffee_subscription',
          price: p.pricePerCup,
          quantity: p.billedServings
        }]
      });
    }

    function bindHandlers(d, p){
      const buy = document.getElementById('buyBtn');
      const back = document.getElementById('backBtn');
      if (buy){ buy.addEventListener('click', onBuy, { passive:true }); }
      if (back){ back.addEventListener('click', () => history.length ? history.back() : window.location.assign('index.html')); }

      // Review mode
      const params = new URLSearchParams(window.location.search);
      if (params.get('review') === '1' && buy){ buy.remove(); }
    }

    // ---- Chrome on iOS specific fixes ----
    (function chromeIOSFix(){
      // Detect Chrome on iOS
      const isChromeOnIOS = /CriOS/.test(navigator.userAgent);
      
      if (isChromeOnIOS) {
        // Prevent scroll jumping and toolbar interference
        let lastScrollTop = 0;
        let scrollTimeout;
        
        // Enhanced scroll event handling
        window.addEventListener('scroll', function(e) {
          const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          
          // Clear previous timeout
          clearTimeout(scrollTimeout);
          
          // Set a timeout to handle scroll end
          scrollTimeout = setTimeout(function() {
            lastScrollTop = scrollTop;
          }, 150);
          
          // Prevent extreme scroll values that cause jumping
          if (Math.abs(scrollTop - lastScrollTop) > 500) {
            e.preventDefault();
            window.scrollTo(0, lastScrollTop);
            return false;
          }
        }, { passive: false });
        
        // Fix viewport height issues
        function setViewportHeight() {
          const vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight, { passive: true });
        window.addEventListener('orientationchange', setViewportHeight, { passive: true });
        
        // Prevent pull-to-refresh
        document.addEventListener('touchstart', function(e) {
          if (e.touches.length === 1 && e.touches[0].clientY < 50) {
            e.preventDefault();
          }
        }, { passive: false });
        
        // Prevent overscroll on body
        document.body.style.overscrollBehavior = 'none';
        document.documentElement.style.overscrollBehavior = 'none';
      }
    })();
    
    // ---- Viewport height fix for legacy iOS Chrome/Safari ----
    (function viewportFix(){
      const set = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight / 100}px`);
      const useLegacy = !CSS.supports('height', '100dvh');
      if (useLegacy){
        window.addEventListener('resize', set, { passive:true });
        window.addEventListener('orientationchange', set, { passive:true });
        window.addEventListener('load', set, { once:true });
        set();
        // Use the custom var in CSS only if needed
        const style = document.createElement('style');
        style.textContent = `.container{min-height: calc(var(--vh, 1vh) * 100);}`;
        document.head.appendChild(style);
      }
    })();

    // Initial render
    render();
  })();
  </script>
</body>
</html>
