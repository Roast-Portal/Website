<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5LTTX2TGVQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-5LTTX2TGVQ');
  </script>
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Roast Portal — Checkout</title>
  <style>
    :root{
      --bg-primary:#FBFBFD; --text-primary:#1D1D1F; --text-secondary:#6E6E73;
      --border:rgba(0,0,0,0.08); --blue:#0071E3;
    }
    
    *{box-sizing:border-box}
    
    body{
      margin:0; 
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:var(--bg-primary);
      color:var(--text-primary);
      line-height:1.5;
    }
    
    .container{
      max-width:1080px;
      margin:0 auto;
      padding:24px;
    }
    
    .surface{
      background:#fff;
      border:1px solid var(--border);
      border-radius:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:24px;
    }
    
    h1{
      font-size:28px;
      margin:0 0 8px;
      font-weight:700;
    }
    
    p.sub{
      color:var(--text-secondary);
      margin:0 0 24px;
      font-size:16px;
    }
    
    .grid{
      display:grid;
      grid-template-columns:1.5fr 1fr;
      gap:32px;
      align-items:start;
    }
    
    .section-title{
      font-weight:700;
      margin:0 0 8px;
      font-size:18px;
    }
    
    .desc{
      color:var(--text-secondary);
      line-height:1.5;
      margin:0 0 16px;
      font-size:14px;
    }
    
    .badges{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
    }
    
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.1);
      background:#fff;
      color:var(--text-secondary);
    }
    
    .divider{
      height:1px;
      background:var(--border);
      margin:16px 0;
    }
    
    .line{
      display:flex;
      justify-content:space-between;
      gap:12px;
      margin:8px 0;
      font-size:14px;
    }
    
    .muted{
      color:var(--text-secondary);
    }
    
    .price{
      font-weight:600;
    }
    
    .total{
      font-weight:800;
      font-size:16px;
    }
    
    .actions{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:20px;
    }
    
    .btn{
      appearance:none;
      border:1px solid rgba(0,0,0,.1);
      background:#fff;
      color:#1d1d1f;
      padding:12px 20px;
      border-radius:999px;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      box-shadow:0 1px 6px rgba(0,0,0,.06);
      transition:all 0.2s ease;
    }
    
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    
    .btn.primary{
      background:var(--blue);
      color:#fff;
      border-color:transparent;
      box-shadow:0 8px 20px rgba(0,113,227,.28);
    }
    
    .btn.primary:hover{
      box-shadow:0 10px 25px rgba(0,113,227,.35);
    }
    
    /* Pouch visualization */
    .visual{
      text-align:center;
      margin-bottom:24px;
      position:relative;
    }
    
    .pouch-stack{
      display:inline-block;
      position:relative;
      margin-bottom:16px;
    }
    
    .pouch{
      width:120px;
      height:160px;
      background:#0a0a0a;
      border-radius:8px 8px 12px 12px;
      position:relative;
      margin:0 auto;
      box-shadow:0 8px 20px rgba(0,0,0,.15);
    }
    
    .pouch-label{
      position:absolute;
      bottom:12px;
      left:12px;
      right:12px;
      background:#fff;
      border-radius:8px;
      padding:16px 12px;
      text-align:center;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    
    .label-badge{
      background:var(--blue);
      color:#fff;
      padding:4px 8px;
      border-radius:12px;
      font-size:10px;
      font-weight:700;
      margin-bottom:6px;
      display:inline-block;
    }
    
    .label-tagline{
      font-size:12px;
      font-weight:700;
      color:var(--text-primary);
      margin-bottom:4px;
    }
    
    .label-description{
      font-size:10px;
      color:var(--text-secondary);
      line-height:1.3;
    }
    
    .qty-badge{
      position:absolute;
      top:8px;
      right:8px;
      background:#111;
      color:#fff;
      border-radius:999px;
      font-size:12px;
      padding:6px 10px;
      font-weight:600;
    }
    
    /* Mobile optimizations */
    @media(max-width:860px){
      .grid{
        grid-template-columns:1fr;
        gap:24px;
      }
      
      .container{
        padding:16px;
      }
      
      .surface{
        padding:20px;
        border-radius:16px;
      }
      
      h1{
        font-size:24px;
      }
      
      .pouch{
        width:100px;
        height:133px;
      }
      
      .pouch-label{
        padding:12px 8px;
        bottom:8px;
        left:8px;
        right:8px;
      }
      
      .label-badge{
        font-size:9px;
        padding:3px 6px;
      }
      
      .label-tagline{
        font-size:11px;
      }
      
      .label-description{
        font-size:9px;
      }
    }
    
    @media(max-width:480px){
      .container{
        padding:12px;
      }
      
      .surface{
        padding:16px;
        border-radius:12px;
      }
      
      h1{
        font-size:22px;
      }
      
      .actions{
        flex-direction:column;
      }
      
      .btn{
        width:100%;
        padding:14px 20px;
        font-size:15px;
      }
      
      .pouch{
        width:80px;
        height:107px;
      }
      
      .pouch-label{
        padding:8px 6px;
        bottom:6px;
        left:6px;
        right:6px;
      }
      
      .qty-badge{
        font-size:11px;
        padding:4px 8px;
      }
    }
  </style>
  
  <!-- Google tag (gtag.js) event - delayed navigation helper -->
  <script>
    function gtagSendEvent(url, eventData) {
      var callback = function () {
        console.log('✅ GA callback executed, navigating to:', url);
        if (typeof url === 'string') {
          window.location = url;
        }
      };
      console.log('📊 Sending GA event "submission_ok" with data:', eventData);
      gtag('event', 'submission_ok', Object.assign({
        'event_callback': callback,
        'event_timeout': 2000,
      }, eventData || {}));
      return false;
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="surface">
      <h1>Checkout</h1>
      <p class="sub">Review your custom blend and complete your order.</p>
      <div id="checkout" class="grid" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // Load quiz data
    function loadData(){
      try{ 
        return JSON.parse(localStorage.getItem('rp_quiz')||'{}');
      }catch{ 
        return {}; 
      }
    }
    
    function mapPrice(per){
      const val = Number(per)||20; 
      const pct=(val-8)/(36-8); 
      const price=Math.max(2,Math.min(9,+(2+7*pct).toFixed(2))); 
      return price;
    }
    
    function roundTo95(amount){
      const dollars = Math.ceil(amount);
      return dollars - 0.05 + (dollars === amount ? 0 : 0);
    }
    
    function compute(data){
      const pricePerCup = mapPrice(data.priceRange);
      const more = (data.cupsPerDay||'').toLowerCase().includes('more');
      const billedServings = more?28:14;
      const bonus = 1;
      const totalServings = Math.min(31, billedServings + bonus);
      const rawSubtotal = pricePerCup * billedServings;
      const shipping = 4.95;
      const rawTax = rawSubtotal * 0.08;
      const subtotal = roundTo95(rawSubtotal);
      const tax = roundTo95(rawTax);
      const total = roundTo95(subtotal + tax + shipping);
      
      return {
        pricePerCup,
        billedServings,
        bonus,
        totalServings,
        subtotal,
        shipping,
        tax,
        total,
        period:'every 2 weeks'
      };
    }
    
    function topFlavors(d){
      return [ 
        ['Nutty',d.flavorNutty], 
        ['Fruity',d.flavorFruity], 
        ['Floral',d.flavorFloral], 
        ['Smoky',d.flavorSmoky] 
      ]
        .filter(([,v])=>v!==''&&!isNaN(Number(v)))
        .sort((a,b)=>Number(b[1])-Number(a[1]))
        .slice(0,2)
        .map(([k])=>k)
        .join(' & ');
    }
    
    function render(){
      const d = loadData();
      const p = compute(d);
      const flavors = topFlavors(d);
      const tasting = flavors? `${flavors} notes` : 'Balanced, approachable cup';
      const brew = d.brewMethod? `Ground for ${d.brewMethod.toLowerCase()}` : 'Ground for your method';
      const style = d.additions? `Enjoyed with ${d.additions.toLowerCase()}` : 'Enjoyed black or with milk';
      
      const el = document.getElementById('checkout');
      const rawName = d.blendName || 'Your Daily Roast';
      const planName = /subscription/i.test(rawName) ? rawName : `${rawName} subscription`;
      
      let badgeText = 'Your Blend';
      if(d.firstName && String(d.firstName).trim()){
        const n = String(d.firstName).trim();
        badgeText = /s$/i.test(n) ? `${n}' Blend` : `${n}'s Blend`;
      } else if(d.email){
        const handle = String(d.email).split('@')[0];
        if(handle){ 
          badgeText = /s$/i.test(handle) ? `${handle}' Blend` : `${handle}'s Blend`; 
        }
      }
      
      el.innerHTML = `
        <div>
          <div class="visual">
            <div class="pouch-stack">
              <div class="pouch">
                <div class="pouch-label">
                  <div class="label-badge">${badgeText}</div>
                  <div class="label-tagline">${d.blendName||'Your Daily Roast'}</div>
                  <div class="label-description">${tasting}</div>
                </div>
              </div>
            </div>
            <div class="qty-badge">${p.totalServings} cup${p.totalServings===1?'':'s'}</div>
          </div>
          
          <div class="section-title">${d.blendName||'Your Daily Roast'} — ${d.roastLevel||'Medium'}</div>
          <div class="desc">${tasting}. ${brew}. ${style}.</div>
          
          <div class="badges">
            ${d.personality?`<span class='pill'>${d.personality}</span>`:''}
            ${d.tasteBalance?`<span class='pill'>${d.tasteBalance}</span>`:''}
            ${d.cupsPerDay?`<span class='pill'>${d.cupsPerDay}</span>`:''}
          </div>
          
          ${d.additionalNotes?`<div class='divider'></div><div class='desc'><strong>Notes:</strong> ${d.additionalNotes}</div>`:''}
        </div>
        
        <div>
          <div class="line"><span class="muted">Plan</span><span>${planName} • ${p.period}</span></div>
          <div class="line"><span class="muted">Price per cup</span><span class="price">$${p.pricePerCup.toFixed(2)}</span></div>
          <div class="line"><span class="muted">Servings (billed)</span><span>${p.billedServings} × $${p.pricePerCup.toFixed(2)}</span></div>
          <div class="line"><span class="muted">Bonus cup (qty 1)</span><span>$0.00</span></div>
          <div class="divider"></div>
          <div class="line"><span class="muted">Subtotal</span><span>$${p.subtotal.toFixed(2)}</span></div>
          <div class="line"><span class="muted">Shipping</span><span>$${p.shipping.toFixed(2)}</span></div>
          <div class="line"><span class="muted">Estimated tax</span><span>$${p.tax.toFixed(2)}</span></div>
          <div class="divider"></div>
          <div class="line total"><span>Total today</span><span>$${p.total.toFixed(2)}</span></div>
          
          <div class="actions">
            <button class="btn" type="button" onclick="window.history.back()">Back</button>
            <button class="btn primary" type="button" id="buyBtn">Buy now</button>
          </div>
        </div>`;
    }
    
    render();
    
    // Build payload and submit
    function buildPayload(){
      let d = {}; 
      try{ 
        d = JSON.parse(localStorage.getItem('rp_quiz')||'{}'); 
      }catch{}
      
      const pricePerCup = mapPrice(d.priceRange);
      const more = (d.cupsPerDay||'').toLowerCase().includes('more');
      const billedServings = more?28:14; 
      const bonus=1; 
      const totalServings=billedServings+bonus;
      
      const topFlavors = [ 
        ['Nutty',d.flavorNutty], 
        ['Fruity',d.flavorFruity], 
        ['Floral',d.flavorFloral], 
        ['Smoky',d.flavorSmoky] 
      ]
        .filter(([,v])=>v!==''&&!isNaN(Number(v)))
        .sort((a,b)=>Number(b[1])-Number(a[1]))
        .slice(0,3)
        .map(([k,v])=>`${k}:${v}`)
        .join(', ');
      
      const RP_USER_ID = (function(){ 
        try{ 
          return localStorage.getItem('rp_user_id')||'' 
        }catch{ 
          return '' 
        } 
      })();
      
      return {
        timestamp: new Date().toISOString(),
        tab: 'FormResponses',
        userId: RP_USER_ID,
        firstName: d.firstName||'', 
        lastName: d.lastName||'', 
        email: d.email||'',
        roastLevel: d.roastLevel||'', 
        brewMethod: d.brewMethod||'', 
        equipmentDetails: d.equipmentDetails||'', 
        additions: d.additions||'',
        priceRange: d.priceRange||'', 
        pricePerCup, 
        cupsPerDay: d.cupsPerDay||'', 
        personality: d.personality||'', 
        tasteBalance: d.tasteBalance||'',
        flavorNutty: d.flavorNutty||'', 
        flavorFruity: d.flavorFruity||'', 
        flavorFloral: d.flavorFloral||'', 
        flavorSmoky: d.flavorSmoky||'', 
        topFlavors,
        blendName: d.blendName||'', 
        billedServings, 
        bonus, 
        totalServings, 
        source: 'checkout'
      };
    }
    
    function postToSheets(payload){
      const url = 'https://script.google.com/macros/s/AKfycbxd6pPajYDJEtCIZpUe9zmJrTCypz6_vzWAHABsx0vg-bpAjF0SdfuCkhvhZJ6pTnpz7g/exec';
      const form = new URLSearchParams(); 
      Object.entries(payload).forEach(([k,v])=>form.append(k,String(v??'')));
      return fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body:form.toString()
      });
    }
    
    // Buy button handler
    document.getElementById('buyBtn')?.addEventListener('click', ()=>{
      const payload = buildPayload();
      const d = loadData();
      const p = compute(d);
      
      // Save timestamp immediately
      try{ 
        localStorage.setItem('rp_last_order_ts', String(Date.now())); 
      }catch{}
      
      // Start Google Sheets submission in background (non-blocking)
      postToSheets(payload).catch(err => {
        console.error('⚠️ Background submission failed:', err);
      });
      
      // Navigate immediately without waiting for submission
      if (typeof gtag !== 'undefined') {
        console.log('🎯 Buy button clicked - GA is available');
        gtagSendEvent('thanks.html', {
          'value': p.total,
          'currency': 'USD',
          'transaction_id': Date.now().toString(),
          'items': [{
            'item_id': 'subscription',
            'item_name': d.blendName || 'Your Daily Roast',
            'item_category': 'coffee_subscription',
            'price': p.pricePerCup,
            'quantity': p.billedServings
          }]
        });
      } else {
        console.warn('⚠️ Google Analytics (gtag) not found - navigating directly');
        window.location.href = 'thanks.html';
      }
    });

    // Hide Buy button in review mode
    (function(){
      const params = new URLSearchParams(window.location.search);
      if(params.get('review')==='1'){
        const buy = document.getElementById('buyBtn');
        if(buy){ 
          buy.remove(); 
        }
      }
    })();
  </script>
</body>
</html>


