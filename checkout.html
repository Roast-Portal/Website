<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5LTTX2TGVQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-5LTTX2TGVQ');
  </script>
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Roast Portal — Checkout</title>
  <style>
    :root{
      --bg-primary:#FBFBFD; --text-primary:#1D1D1F; --text-secondary:#6E6E73;
      --border:rgba(0,0,0,0.08); --blue:#0071E3;
    }
    
    *{box-sizing:border-box}
    
    html,
    body{
      height: 100%;
      height: 100vh;
      height: calc(var(--vh, 1vh) * 100);
    }
    
    body{
      margin:0; 
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:var(--bg-primary);
      color:var(--text-primary);
      line-height:1.5;
      /* Chrome on iOS scroll fixes */
      -webkit-overflow-scrolling: touch;
      overflow-x: hidden;
      position: relative;
    }
    
    .container{
      max-width:1080px;
      margin:0 auto;
      padding:24px;
    }
    
    .surface{
      background:#fff;
      border:1px solid var(--border);
      border-radius:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:24px;
    }
    
    h1{
      font-size:28px;
      margin:0 0 8px;
      font-weight:700;
    }
    
    p.sub{
      color:var(--text-secondary);
      margin:0 0 24px;
      font-size:16px;
    }
    
    .grid{
      display:grid;
      grid-template-columns:1.5fr 1fr;
      gap:32px;
      align-items:start;
    }
    
    .section-title{
      font-weight:700;
      margin:0 0 8px;
      font-size:18px;
    }
    
    .desc{
      color:var(--text-secondary);
      line-height:1.5;
      margin:0 0 16px;
      font-size:14px;
    }
    
    .badges{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
    }
    
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.1);
      background:#fff;
      color:var(--text-secondary);
    }
    
    .divider{
      height:1px;
      background:var(--border);
      margin:16px 0;
    }
    
    .line{
      display:flex;
      justify-content:space-between;
      gap:12px;
      margin:8px 0;
      font-size:14px;
    }
    
    .muted{
      color:var(--text-secondary);
    }
    
    .price{
      font-weight:600;
    }
    
    .total{
      font-weight:800;
      font-size:16px;
    }
    
    .actions{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:20px;
    }
    
    .btn{
      appearance:none;
      border:1px solid rgba(0,0,0,.1);
      background:#fff;
      color:#1d1d1f;
      padding:12px 20px;
      border-radius:999px;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      box-shadow:0 1px 6px rgba(0,0,0,.06);
      transition:all 0.2s ease;
    }
    
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    
    .btn.primary{
      background:var(--blue);
      color:#fff;
      border-color:transparent;
      box-shadow:0 8px 20px rgba(0,113,227,.28);
    }
    
    .btn.primary:hover{
      box-shadow:0 10px 25px rgba(0,113,227,.35);
    }
    
    /* Pouch visualization - using product-section pouch-extreme design */
    .visual{
      text-align:center;
      margin-bottom:24px;
      position:relative;
    }
    
    .pouch-stack{
      display:inline-block;
      position:relative;
      margin-bottom:16px;
    }
    
    /* Pouch extreme (from product-section) */
    .pouch-extreme{ 
      --pouch-min: min(120px, 160px); 
      --bag-bg:#0a0a0a; 
      --bag-radius-frac:0.0375; 
      --pouch-border-frac:0.003; 
      --pouch-border-color: rgba(0,0,0,0.1); 
      --label-bg:#FDFEFE; 
      --label-radius-frac:0.055; 
      --label-top-frac:0.88; 
      --label-pad-frac:0.04; 
      --label-gradient: linear-gradient(135deg, rgba(245, 248, 252, 0.65) 0%, rgba(252, 254, 255, 0.45) 50%, rgba(248, 250, 252, 0.4) 100%); 
      --label-gradient-opacity:0.85; 
    }
    
    .pouch-extreme.pouch-container{ 
      position:relative; 
      inline-size:120px; 
      block-size:160px; 
      container-type:inline-size 
    }
    
    .pouch-extreme .pouch{ 
      position:absolute; 
      inset:0; 
      background:var(--bag-bg); 
      border-radius: calc(var(--bag-radius-frac) * var(--pouch-min)) calc(var(--bag-radius-frac) * var(--pouch-min)) calc(var(--bag-radius-frac) * .8 * var(--pouch-min)) calc(var(--bag-radius-frac) * .8 * var(--pouch-min)); 
      overflow:hidden; 
      isolation:isolate; 
      box-shadow: 0 12px 28px rgba(0,0,0,.18), 0 2px 6px rgba(0,0,0,.10); 
    }
    
    .pouch-extreme .pouch::after{ 
      content:""; 
      position:absolute; 
      inset:0; 
      z-index:3; 
      pointer-events:none; 
      border-radius: inherit; 
      clip-path: inherit; 
      box-shadow: inset 0 0 0 calc(var(--pouch-border-frac) * var(--pouch-min)) var(--pouch-border-color); 
    }
    
    .pouch-extreme .pouch{
      --rT: calc(var(--bag-radius-frac) * 100cqw);
      --rB: calc(var(--bag-radius-frac) * 80cqw);
      --t1: var(--rT); --t2: calc(var(--rT)*.6); --t3: calc(var(--rT)*.4); --t4: calc(var(--rT)*.2);
      --b1: var(--rB); --b2: calc(var(--rB)*.6); --b3: calc(var(--rB)*.4); --b4: calc(var(--rB)*.2);
      --nx: 1; --nox: calc(4cqw * var(--nx));
      clip-path: polygon(0 var(--t1), var(--t4) var(--t2), var(--t3) var(--t3), var(--t2) var(--t4), var(--t1) 0,
                         calc(100% - var(--t1)) 0, calc(100% - var(--t2)) var(--t4), calc(100% - var(--t3)) var(--t3), calc(100% - var(--t4)) var(--t2), 100% var(--t1),
                         100% calc(var(--t1) + 4cqw), calc(100% - var(--nox)) calc(var(--t1) + 6cqw), 100% calc(var(--t1) + 8cqw),
                         100% calc(100% - var(--b1)), calc(100% - var(--b4)) calc(100% - var(--b2)), calc(100% - var(--b3)) calc(100% - var(--b3)), calc(100% - var(--b2)) calc(100% - var(--b4)), calc(100% - var(--b1)) 100%,
                         var(--b1) 100%, var(--b2) calc(100% - var(--b4)), var(--b3) calc(100% - var(--b3)), var(--b4) calc(100% - var(--b2)), 0 calc(100% - var(--b1)),
                         0 calc(var(--t1) + 8cqw), var(--nox) calc(var(--t1) + 6cqw), 0 calc(var(--t1) + 4cqw),
                         0 var(--t1)); 
    }
    
    .pouch-extreme .top-seal{ 
      position:absolute; 
      inset-inline:0; 
      inset-block-start:0; 
      height:10cqw; 
      background-color:var(--bag-bg); 
      border-bottom:1px solid rgba(220,225,230,0.32);
      background-image: repeating-linear-gradient(180deg, rgba(255,255,255,0.06) 0 1px, rgba(0,0,0,0.08) 1px 2px, transparent 2px 3px),
                        linear-gradient(0deg, rgba(0,0,0,0.28) 0, transparent 50%),
                        radial-gradient(100% 50% at 50% 0%, rgba(255,255,255,0.06) 0, transparent 70%); 
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.38), inset 0 1px 0 rgba(220,225,230,0.22); 
      clip-path: inherit; 
    }
    
    .pouch-extreme .pouch-label{ 
      --pad: calc(var(--label-pad-frac) * var(--pouch-min)); 
      position:absolute; 
      left:var(--pad); 
      right:var(--pad); 
      bottom:var(--pad); 
      top: calc(100% - (var(--label-top-frac) * 100%));
      background:var(--label-bg); 
      border-radius: calc(var(--label-radius-frac) * var(--pouch-min)); 
      padding:16px 12px; 
      overflow:hidden; 
      display:flex; 
      flex-direction:column; 
      align-items:center; 
      justify-content:center; 
      text-align:center; 
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.5), inset 0 -1px 0 rgba(0,0,0,0.05), 0 4px 12px rgba(0,0,0,0.08); 
      border: 1px solid rgba(0,0,0,0.04); 
    }
    
    .pouch-extreme .pouch-label::before{ 
      content:""; 
      position:absolute; 
      inset:0; 
      border-radius:inherit; 
      background:
        linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 60%),
        var(--label-gradient),
        radial-gradient(120% 80% at 18% 20%, hsla(210, 42%, 88%, 0.25) 0 40%, transparent 70%),
        radial-gradient(130% 78% at 80% 24%, hsla(200, 40%, 90%, 0.22) 0 38%, transparent 72%),
        radial-gradient(110% 88% at 64% 84%, hsla(180, 38%, 92%, 0.20) 0 42%, transparent 74%); 
      opacity: calc(var(--label-gradient-opacity) * 0.7); 
    }
    
    .label-badge{
      padding:6px 10px;
      border-radius:14px;
      color:#fff;
      background:var(--blue);
      font-size:11px;
      font-weight:700;
      box-shadow:0 0 0 1px rgba(0,113,227,.28);
      margin-bottom:8px;
      display:inline-block;
      position:relative;
      z-index:1;
    }
    
    .label-tagline{
      font-size:14px;
      font-weight:700;
      color:#1d1d1f;
      margin-bottom:6px;
      position:relative;
      z-index:1;
      text-shadow: 0 1px 2px rgba(0,0,0,0.05);
      line-height:1.2;
    }
    
    .label-description{
      font-size:12px;
      color:#2b2b30;
      margin-top:6px;
      line-height:1.3;
      position:relative;
      z-index:1;
      letter-spacing: -0.01em;
    }
    
    .qty-badge{
      position:absolute;
      top:8px;
      right:8px;
      background:#111;
      color:#fff;
      border-radius:999px;
      font-size:12px;
      padding:6px 10px;
      font-weight:600;
    }
    
    /* Mobile optimizations */
    @media(max-width:860px){
      .grid{
        grid-template-columns:1fr;
        gap:24px;
      }
      
      .container{
        padding:16px;
      }
      
      .surface{
        padding:20px;
        border-radius:16px;
      }
      
      h1{
        font-size:24px;
      }
      
      .pouch-extreme.pouch-container{
        inline-size:100px;
        block-size:133px;
      }
      
      .pouch-extreme .pouch-label{
        padding:12px 8px;
      }
      
      .label-badge{
        font-size:10px;
        padding:4px 8px;
        margin-bottom:6px;
      }
      
      .label-tagline{
        font-size:12px;
        margin-bottom:5px;
      }
      
      .label-description{
        font-size:10px;
        margin-top:5px;
      }
      
      /* Chrome on iOS specific fixes */
      body{
        -webkit-overflow-scrolling: touch;
        overflow-x: hidden;
        position: relative;
        height: 100vh;
        height: -webkit-fill-available;
      }
      
      .container{
        min-height: 100vh;
        min-height: -webkit-fill-available;
        overflow-x: hidden;
      }
      
      .surface{
        overflow-x: hidden;
      }
    }
    
    @media(max-width:480px){
      .container{
        padding:12px;
      }
      
      .surface{
        padding:16px;
        border-radius:12px;
      }
      
      h1{
        font-size:22px;
      }
      
      .actions{
        flex-direction:column;
      }
      
      .btn{
        width:100%;
        padding:14px 20px;
        font-size:15px;
      }
      
      .pouch-extreme.pouch-container{
        inline-size:80px;
        block-size:107px;
      }
      
      .pouch-extreme .pouch-label{
        padding:8px 6px;
      }
      
      .label-badge{
        font-size:9px;
        padding:3px 6px;
        margin-bottom:4px;
      }
      
      .label-tagline{
        font-size:10px;
        margin-bottom:3px;
      }
      
      .label-description{
        font-size:9px;
        margin-top:3px;
      }
      
      .qty-badge{
        font-size:11px;
        padding:4px 8px;
      }
    }
    
    /* Chrome on iOS specific fixes */
    @supports (-webkit-touch-callout: none) {
      body {
        -webkit-overflow-scrolling: touch;
        overflow-x: hidden;
        position: relative;
        height: calc(var(--vh, 1vh) * 100);
        min-height: -webkit-fill-available;
      }
      
      .container {
        min-height: calc(var(--vh, 1vh) * 100);
        min-height: -webkit-fill-available;
        overflow-x: hidden;
        position: relative;
      }
      
      .surface {
        overflow-x: hidden;
        position: relative;
      }
      
      /* Prevent Chrome toolbar interference */
      .visual {
        overflow: visible;
        position: relative;
      }
      
      .pouch-stack {
        overflow: visible;
        position: relative;
      }
    }
  </style>
  
  <!-- Google tag (gtag.js) event - delayed navigation helper -->
  <script>
    function gtagSendEvent(url, eventData) {
      var callback = function () {
        console.log('✅ GA callback executed, navigating to:', url);
        if (typeof url === 'string') {
          window.location = url;
        }
      };
      console.log('📊 Sending GA event "submission_ok" with data:', eventData);
      gtag('event', 'submission_ok', Object.assign({
        'event_callback': callback,
        'event_timeout': 2000,
      }, eventData || {}));
      return false;
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="surface">
      <h1>Checkout</h1>
      <p class="sub">Review your custom blend and complete your order.</p>
      <div id="checkout" class="grid" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // Load quiz data
    function loadData(){
      try{ 
        return JSON.parse(localStorage.getItem('rp_quiz')||'{}');
      }catch{ 
        return {}; 
      }
    }
    
    function mapPrice(per){
      const val = Number(per)||20; 
      const pct=(val-8)/(36-8); 
      const price=Math.max(2,Math.min(9,+(2+7*pct).toFixed(2))); 
      return price;
    }
    
    function roundTo95(amount){
      const dollars = Math.ceil(amount);
      return dollars - 0.05 + (dollars === amount ? 0 : 0);
    }
    
    function compute(data){
      const pricePerCup = mapPrice(data.priceRange);
      const more = (data.cupsPerDay||'').toLowerCase().includes('more');
      const billedServings = more?28:14;
      const bonus = 1;
      const totalServings = Math.min(31, billedServings + bonus);
      const rawSubtotal = pricePerCup * billedServings;
      const shipping = 4.95;
      const rawTax = rawSubtotal * 0.08;
      const subtotal = roundTo95(rawSubtotal);
      const tax = roundTo95(rawTax);
      const total = roundTo95(subtotal + tax + shipping);
      
      return {
        pricePerCup,
        billedServings,
        bonus,
        totalServings,
        subtotal,
        shipping,
        tax,
        total,
        period:'every 2 weeks'
      };
    }
    
    function topFlavors(d){
      return [ 
        ['Nutty',d.flavorNutty], 
        ['Fruity',d.flavorFruity], 
        ['Floral',d.flavorFloral], 
        ['Smoky',d.flavorSmoky] 
      ]
        .filter(([,v])=>v!==''&&!isNaN(Number(v)))
        .sort((a,b)=>Number(b[1])-Number(a[1]))
        .slice(0,2)
        .map(([k])=>k)
        .join(' & ');
    }
    
    function render(){
      const d = loadData();
      const p = compute(d);
      const flavors = topFlavors(d);
      const tasting = flavors? `${flavors} notes` : 'Balanced, approachable cup';
      const brew = d.brewMethod? `Ground for ${d.brewMethod.toLowerCase()}` : 'Ground for your method';
      const style = d.additions? `Enjoyed with ${d.additions.toLowerCase()}` : 'Enjoyed black or with milk';
      
      const el = document.getElementById('checkout');
      const rawName = d.blendName || 'Your Daily Roast';
      const planName = /subscription/i.test(rawName) ? rawName : `${rawName} subscription`;
      
      let badgeText = 'Your Blend';
      if(d.firstName && String(d.firstName).trim()){
        const n = String(d.firstName).trim();
        badgeText = /s$/i.test(n) ? `${n}' Blend` : `${n}'s Blend`;
      } else if(d.email){
        const handle = String(d.email).split('@')[0];
        if(handle){ 
          badgeText = /s$/i.test(handle) ? `${handle}' Blend` : `${handle}'s Blend`; 
        }
      }
      
      el.innerHTML = `
        <div>
          <div class="visual">
            <div class="pouch-stack">
              <div class="pouch-extreme pouch-container">
                <div class="pouch">
                  <div class="top-seal"></div>
                  <div class="pouch-label">
                    <div class="label-badge">${badgeText}</div>
                    <div class="label-tagline">${d.blendName||'Your Daily Roast'}</div>
                    <div class="label-description">${tasting}</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="qty-badge">${p.totalServings} cup${p.totalServings===1?'':'s'}</div>
          </div>
          
          <div class="section-title">${d.blendName||'Your Daily Roast'} — ${d.roastLevel||'Medium'}</div>
          <div class="desc">${tasting}. ${brew}. ${style}.</div>
          
          <div class="badges">
            ${d.personality?`<span class='pill'>${d.personality}</span>`:''}
            ${d.tasteBalance?`<span class='pill'>${d.tasteBalance}</span>`:''}
            ${d.cupsPerDay?`<span class='pill'>${d.cupsPerDay}</span>`:''}
          </div>
          
          ${d.additionalNotes?`<div class='divider'></div><div class='desc'><strong>Notes:</strong> ${d.additionalNotes}</div>`:''}
        </div>
        
        <div>
          <div class="line"><span class="muted">Plan</span><span>${planName} • ${p.period}</span></div>
          <div class="line"><span class="muted">Price per cup</span><span class="price">$${p.pricePerCup.toFixed(2)}</span></div>
          <div class="line"><span class="muted">Servings (billed)</span><span>${p.billedServings} × $${p.pricePerCup.toFixed(2)}</span></div>
          <div class="line"><span class="muted">Bonus cup (qty 1)</span><span>$0.00</span></div>
          <div class="divider"></div>
          <div class="line"><span class="muted">Subtotal</span><span>$${p.subtotal.toFixed(2)}</span></div>
          <div class="line"><span class="muted">Shipping</span><span>$${p.shipping.toFixed(2)}</span></div>
          <div class="line"><span class="muted">Estimated tax</span><span>$${p.tax.toFixed(2)}</span></div>
          <div class="divider"></div>
          <div class="line total"><span>Total today</span><span>$${p.total.toFixed(2)}</span></div>
          
          <div class="actions">
            <button class="btn" type="button" onclick="window.history.back()">Back</button>
            <button class="btn primary" type="button" id="buyBtn">Buy now</button>
          </div>
        </div>`;
    }
    
    render();
    
    // Build payload and submit
    function buildPayload(){
      let d = {}; 
      try{ 
        d = JSON.parse(localStorage.getItem('rp_quiz')||'{}'); 
      }catch{}
      
      const pricePerCup = mapPrice(d.priceRange);
      const more = (d.cupsPerDay||'').toLowerCase().includes('more');
      const billedServings = more?28:14; 
      const bonus=1; 
      const totalServings=billedServings+bonus;
      
      const topFlavors = [ 
        ['Nutty',d.flavorNutty], 
        ['Fruity',d.flavorFruity], 
        ['Floral',d.flavorFloral], 
        ['Smoky',d.flavorSmoky] 
      ]
        .filter(([,v])=>v!==''&&!isNaN(Number(v)))
        .sort((a,b)=>Number(b[1])-Number(a[1]))
        .slice(0,3)
        .map(([k,v])=>`${k}:${v}`)
        .join(', ');
      
      const RP_USER_ID = (function(){ 
        try{ 
          return localStorage.getItem('rp_user_id')||'' 
        }catch{ 
          return '' 
        } 
      })();
      
      return {
        timestamp: new Date().toISOString(),
        tab: 'FormResponses',
        userId: RP_USER_ID,
        firstName: d.firstName||'', 
        lastName: d.lastName||'', 
        email: d.email||'',
        roastLevel: d.roastLevel||'', 
        brewMethod: d.brewMethod||'', 
        equipmentDetails: d.equipmentDetails||'', 
        additions: d.additions||'',
        priceRange: d.priceRange||'', 
        pricePerCup, 
        cupsPerDay: d.cupsPerDay||'', 
        personality: d.personality||'', 
        tasteBalance: d.tasteBalance||'',
        flavorNutty: d.flavorNutty||'', 
        flavorFruity: d.flavorFruity||'', 
        flavorFloral: d.flavorFloral||'', 
        flavorSmoky: d.flavorSmoky||'', 
        topFlavors,
        blendName: d.blendName||'', 
        billedServings, 
        bonus, 
        totalServings, 
        source: 'checkout'
      };
    }
    
    function postToSheets(payload){
      const url = 'https://script.google.com/macros/s/AKfycbxd6pPajYDJEtCIZpUe9zmJrTCypz6_vzWAHABsx0vg-bpAjF0SdfuCkhvhZJ6pTnpz7g/exec';
      const form = new URLSearchParams(); 
      Object.entries(payload).forEach(([k,v])=>form.append(k,String(v??'')));
      return fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body:form.toString()
      });
    }
    
    // Buy button handler
    document.getElementById('buyBtn')?.addEventListener('click', ()=>{
      const payload = buildPayload();
      const d = loadData();
      const p = compute(d);
      
      // Save timestamp immediately
      try{ 
        localStorage.setItem('rp_last_order_ts', String(Date.now())); 
      }catch{}
      
      // Start Google Sheets submission in background (non-blocking)
      postToSheets(payload).catch(err => {
        console.error('⚠️ Background submission failed:', err);
      });
      
      // Navigate immediately without waiting for submission
      if (typeof gtag !== 'undefined') {
        console.log('🎯 Buy button clicked - GA is available');
        gtagSendEvent('thanks.html', {
          'value': p.total,
          'currency': 'USD',
          'transaction_id': Date.now().toString(),
          'items': [{
            'item_id': 'subscription',
            'item_name': d.blendName || 'Your Daily Roast',
            'item_category': 'coffee_subscription',
            'price': p.pricePerCup,
            'quantity': p.billedServings
          }]
        });
      } else {
        console.warn('⚠️ Google Analytics (gtag) not found - navigating directly');
        window.location.href = 'thanks.html';
      }
    });

    // Chrome on iOS viewport height fix - proven solution from Stack Overflow
    (function(){
      function fixHeight() {
        document.documentElement.style.setProperty('--vh', `${window.innerHeight / 100}px`);
      }
      
      // Fix height on load, resize, and orientation change
      addEventListener('load', fixHeight);
      addEventListener('resize', fixHeight);
      addEventListener('orientationchange', fixHeight);
      
      // Also run immediately for faster fix
      fixHeight();
    })();
    
    // Hide Buy button in review mode
    (function(){
      const params = new URLSearchParams(window.location.search);
      if(params.get('review')==='1'){
        const buy = document.getElementById('buyBtn');
        if(buy){ 
          buy.remove(); 
        }
      }
    })();
  </script>
</body>
</html>


